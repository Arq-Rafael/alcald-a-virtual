{% extends "base.html" %}
{% block title %}Gesti√≥n Arb√≥rea - Gesti√≥n del Riesgo{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gestion_riesgo.css') }}">
<style>
  .wizard-container { max-width: 900px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  .wizard-header { background: linear-gradient(135deg, #2d5016 0%, #7cb342 100%); color: white; padding: 24px; border-radius: 12px 12px 0 0; }
  .wizard-steps { display: flex; justify-content: space-between; padding: 20px; border-bottom: 2px solid #f0f0f0; }
  .wizard-step { flex: 1; text-align: center; position: relative; }
  .wizard-step::after { content: ''; position: absolute; top: 20px; left: 50%; width: 100%; height: 2px; background: #ddd; z-index: -1; }
  .wizard-step:last-child::after { display: none; }
  .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #ddd; color: #666; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 8px; }
  .wizard-step.active .step-circle { background: #2d5016; color: white; }
  .wizard-step.completed .step-circle { background: #7cb342; color: white; }
  .wizard-body { padding: 30px; }
  .form-section { display: none; }
  .form-section.active { display: block; }
  .btn-primary-custom { background: #2d5016; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; }
  .btn-primary-custom:hover { background: #7cb342; }
  .btn-secondary-custom { background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px; }
  .alert { padding: 12px 16px; border-radius: 6px; margin-bottom: 16px; }
  .alert-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
  .alert-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
  .alert-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
  .radicado-badge { display: inline-block; background: #2d5016; color: white; padding: 8px 16px; border-radius: 20px; font-weight: bold; font-size: 16px; margin: 10px 0; }
  .compensacion-result { background: #e8f5e9; padding: 16px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #7cb342; }
  .compensacion-result .numero { font-size: 32px; font-weight: bold; color: #2d5016; }
  .autocomplete-list { position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; width: calc(100% - 32px); margin-top: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .autocomplete-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
  .autocomplete-item:hover { background: #f8f9fa; }
  .autocomplete-item small { color: #6c757d; font-style: italic; display: block; margin-top: 2px; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #2d5016; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .historial-table { margin-top: 20px; }
  .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 600; }
  .badge-radicada { background: #ffc107; color: #000; }
  .badge-aprobada { background: #28a745; color: white; }
  .badge-negada { background: #dc3545; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
  <!-- Header -->
  <div class="wizard-header">
    <h1 style="margin: 0; font-size: 28px;">üå≥ Gesti√≥n Arb√≥rea</h1>
    <p style="margin: 8px 0 0 0; opacity: 0.9;">Sistema simplificado de radicaci√≥n, visita t√©cnica y permisos</p>
  </div>

  <!-- Steps indicator -->
  <div class="wizard-steps">
    <div class="wizard-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Radicaci√≥n</div>
    </div>
    <div class="wizard-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Visita T√©cnica</div>
    </div>
    <div class="wizard-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Permiso</div>
    </div>
  </div>

  <!-- Wizard body -->
  <div class="wizard-body">
    <div id="alerts-container"></div>

    <!-- FASE 1: Radicaci√≥n -->
    <div class="form-section active" id="section-1">
      <h3>üìù Radicaci√≥n de Solicitud</h3>
      <p class="text-muted">Ingresa los datos b√°sicos del solicitante y el √°rbol</p>

      <form id="form-radicacion">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nombre del solicitante *</label>
            <input type="text" class="form-control" id="solicitante_nombre" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Documento de identidad *</label>
            <input type="text" class="form-control" id="solicitante_documento" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tel√©fono de contacto *</label>
            <input type="tel" class="form-control" id="solicitante_contacto" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Correo electr√≥nico</label>
            <input type="email" class="form-control" id="solicitante_correo">
          </div>
          <div class="col-12">
            <label class="form-label">Ubicaci√≥n (direcci√≥n/vereda) *</label>
            <input type="text" class="form-control" id="ubicacion_direccion" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tipo de solicitud *</label>
            <select class="form-select" id="tipo_solicitud" required>
              <option value="Poda">Poda</option>
              <option value="Tala">Tala</option>
              <option value="Trasplante">Trasplante</option>
              <option value="Emergencia">Emergencia</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Especie del √°rbol *</label>
            <div style="position: relative;">
              <input type="text" class="form-control" id="arbol_especie_comun" required autocomplete="off">
              <div id="autocomplete-especies" class="autocomplete-list" style="display: none;"></div>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label">DAP - Di√°metro a la altura del pecho (cm) *</label>
            <input type="number" class="form-control" id="arbol_dap_cm" step="0.1" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Altura aproximada (metros)</label>
            <input type="number" class="form-control" id="arbol_altura_m" step="0.1">
          </div>
          <div class="col-12">
            <label class="form-label">Motivo de la solicitud *</label>
            <textarea class="form-control" id="motivo_solicitud" rows="3" required></textarea>
          </div>
        </div>

        <div style="margin-top: 24px; text-align: right;">
          <button type="submit" class="btn-primary-custom" id="btn-guardar-radicado">
            üíæ Guardar y Radicar
          </button>
        </div>
      </form>

      <div id="radicado-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-success">
          <strong>‚úÖ Radicado creado exitosamente</strong>
          <div class="radicado-badge" id="numero-radicado"></div>
          <p style="margin: 10px 0 0 0;">Ahora puedes programar la visita t√©cnica.</p>
        </div>
        <button class="btn-primary-custom" onclick="showSection(2)">Siguiente: Visita T√©cnica ‚Üí</button>
      </div>
    </div>

    <!-- FASE 2: Visita T√©cnica -->
    <div class="form-section" id="section-2">
      <h3>üîç Registro de Visita T√©cnica</h3>
      <p class="text-muted">Documenta la inspecci√≥n realizada al √°rbol</p>

      <div class="alert alert-info" id="radicado-info-2">
        <strong>Radicado:</strong> <span id="radicado-numero-2"></span>
      </div>

      <form id="form-visita">
        <input type="hidden" id="radicado_id_visita">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Fecha de visita *</label>
            <input type="date" class="form-control" id="visita_fecha" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">T√©cnico responsable *</label>
            <input type="text" class="form-control" id="visita_tecnico" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Estado fitosanitario</label>
            <select class="form-select" id="arbol_fitosanitario">
              <option>Buen estado</option>
              <option>Estado regular</option>
              <option>Mal estado</option>
              <option>Seco/muerto</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nivel de riesgo final *</label>
            <select class="form-select" id="visita_riesgo_final" required>
              <option value="Bajo">Bajo</option>
              <option value="Medio">Medio</option>
              <option value="Alto">Alto</option>
              <option value="Muy Alto">Muy Alto</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Observaciones de la visita *</label>
            <textarea class="form-control" id="visita_observaciones" rows="4" required></textarea>
          </div>
        </div>

        <div style="margin-top: 24px; text-align: right;">
          <button type="button" class="btn-secondary-custom" onclick="showSection(1)">‚Üê Anterior</button>
          <button type="submit" class="btn-primary-custom">üíæ Guardar Visita</button>
        </div>
      </form>

      <div id="visita-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-success">
          <strong>‚úÖ Visita t√©cnica registrada</strong>
          <p style="margin: 10px 0 0 0;">Procede a emitir el dictamen y permiso.</p>
        </div>
        <button class="btn-primary-custom" onclick="showSection(3)">Siguiente: Permiso y Compensaci√≥n ‚Üí</button>
      </div>
    </div>

    <!-- FASE 3: Permiso y Compensaci√≥n -->
    <div class="form-section" id="section-3">
      <h3>‚úÖ Emisi√≥n de Permiso y Compensaci√≥n</h3>
      <p class="text-muted">Dictamina y calcula la compensaci√≥n ambiental</p>

      <div class="alert alert-info" id="radicado-info-3">
        <strong>Radicado:</strong> <span id="radicado-numero-3"></span>
      </div>

      <form id="form-permiso">
        <input type="hidden" id="radicado_id_permiso">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Decisi√≥n *</label>
            <select class="form-select" id="dictamen_decision" required onchange="toggleCompensacion()">
              <option value="">Seleccionar...</option>
              <option value="Aprobado">‚úÖ Aprobado</option>
              <option value="Negado">‚ùå Negado</option>
              <option value="Condicionado">‚ö†Ô∏è Condicionado</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Vigencia del permiso (d√≠as) *</label>
            <input type="number" class="form-control" id="permiso_vigencia_dias" value="15" min="1" max="15" required>
            <small class="text-muted">M√°ximo 15 d√≠as</small>
          </div>

          <div id="compensacion-section" style="display: none; width: 100%;">
            <div class="col-12">
              <hr style="margin: 20px 0;">
              <h4>üå± Compensaci√≥n Ambiental</h4>
            </div>
            <div class="col-md-6">
              <label class="form-label">Coeficiente de compensaci√≥n</label>
              <input type="number" class="form-control" id="compensacion_coeficiente" value="1.5" step="0.1">
              <small class="text-muted">Seg√∫n especie y DAP (1.0 - 2.0)</small>
            </div>
            <div class="col-md-6">
              <label class="form-label">M√©todo</label>
              <select class="form-select" id="compensacion_metodo">
                <option value="Autom√°tico">Autom√°tico (DAP/10 √ó coef)</option>
                <option value="Manual">Manual</option>
              </select>
            </div>
            <div class="col-12">
              <button type="button" class="btn-secondary-custom" onclick="calcularCompensacion()">üßÆ Calcular Compensaci√≥n</button>
            </div>
            <div class="col-12">
              <div id="resultado-compensacion" class="compensacion-result" style="display: none;">
                <div class="numero" id="compensacion-arboles-display">0</div>
                <div style="margin-top: 8px;">√Årboles a plantar</div>
                <small id="calculo-detalles" class="text-muted"></small>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Especie recomendada para compensar</label>
              <input type="text" class="form-control" id="compensacion_especie_recomendada">
            </div>
            <div class="col-12">
              <label class="form-label">Sitio y plazo de plantaci√≥n</label>
              <textarea class="form-control" id="compensacion_sitio" rows="2"></textarea>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Obligaciones y condiciones</label>
            <textarea class="form-control" id="permiso_obligaciones" rows="3"></textarea>
          </div>
        </div>

        <div style="margin-top: 24px; text-align: right;">
          <button type="button" class="btn-secondary-custom" onclick="showSection(2)">‚Üê Anterior</button>
          <button type="submit" class="btn-primary-custom">‚úÖ Emitir Permiso</button>
        </div>
      </form>

      <div id="permiso-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-success">
          <strong>‚úÖ Permiso emitido exitosamente</strong>
          <p style="margin: 10px 0 0 0;">El expediente est√° completo.</p>
        </div>
        <button class="btn-primary-custom" onclick="location.reload()">Nuevo Radicado</button>
        <button class="btn-secondary-custom" onclick="verHistorial()">Ver Historial</button>
      </div>
    </div>

    <!-- Historial -->
    <div class="historial-table">
      <h4>üìã Radicados Recientes</h4>
      <table class="table table-sm">
        <thead>
          <tr>
            <th>Radicado</th>
            <th>Solicitante</th>
            <th>Especie</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="historial-tbody">
          <tr>
            <td colspan="5" class="text-center text-muted">Cargando...</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
let radicadoActual = null;
let especiesCache = [];

// === NAVEGACI√ìN WIZARD ===
function showSection(step) {
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  
  document.getElementById(`section-${step}`).classList.add('active');
  document.querySelector(`[data-step="${step}"]`).classList.add('active');
  
  // Scroll top
  document.querySelector('.wizard-body').scrollIntoView({ behavior: 'smooth' });
}

// === ALERTAS ===
function showAlert(message, type = 'success') {
  const container = document.getElementById('alerts-container');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  alert.innerHTML = message;
  container.innerHTML = '';
  container.appendChild(alert);
  
  setTimeout(() => alert.remove(), 5000);
}

// === AUTOCOMPLETE ESPECIES ===
document.getElementById('arbol_especie_comun').addEventListener('input', async (e) => {
  const query = e.target.value.trim();
  const list = document.getElementById('autocomplete-especies');
  
  if (query.length < 2) {
    list.style.display = 'none';
    return;
  }
  
  try {
    const resp = await fetch(`/api/riesgo/especies/search?q=${encodeURIComponent(query)}`);
    const especies = await resp.json();
    
    if (especies.length === 0) {
      list.style.display = 'none';
      return;
    }
    
    list.innerHTML = especies.map(e => `
      <div class="autocomplete-item" onclick="selectEspecie('${e.nombre_comun}', '${e.nombre_cientifico}', ${e.coeficiente_compensacion})">
        <strong>${e.nombre_comun}</strong>
        <small>${e.nombre_cientifico} - Coef: ${e.coeficiente_compensacion}</small>
      </div>
    `).join('');
    
    list.style.display = 'block';
  } catch (err) {
    console.error('Error autocomplete:', err);
  }
});

function selectEspecie(comun, cientifico, coef) {
  document.getElementById('arbol_especie_comun').value = comun;
  document.getElementById('autocomplete-especies').style.display = 'none';
  document.getElementById('compensacion_coeficiente').value = coef;
}

// Cerrar autocomplete al hacer click fuera
document.addEventListener('click', (e) => {
  if (!e.target.matches('#arbol_especie_comun')) {
    document.getElementById('autocomplete-especies').style.display = 'none';
  }
});

// === FASE 1: RADICACI√ìN ===
document.getElementById('form-radicacion').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const btn = document.getElementById('btn-guardar-radicado');
  btn.disabled = true;
  btn.innerHTML = 'üíæ Guardando... <span class="spinner"></span>';
  
  const data = {
    solicitante_nombre: document.getElementById('solicitante_nombre').value,
    solicitante_documento: document.getElementById('solicitante_documento').value,
    solicitante_contacto: document.getElementById('solicitante_contacto').value,
    solicitante_correo: document.getElementById('solicitante_correo').value,
    ubicacion_direccion: document.getElementById('ubicacion_direccion').value,
    tipo_solicitud: document.getElementById('tipo_solicitud').value,
    arbol_especie_comun: document.getElementById('arbol_especie_comun').value,
    arbol_dap_cm: parseFloat(document.getElementById('arbol_dap_cm').value),
    arbol_altura_m: parseFloat(document.getElementById('arbol_altura_m').value) || null,
    motivo_solicitud: document.getElementById('motivo_solicitud').value,
    usuario_creador: 'admin'
  };
  
  try {
    const resp = await fetch('/api/riesgo/arborea', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      radicadoActual = result;
      document.getElementById('numero-radicado').textContent = result.numero_radicado;
      document.getElementById('radicado-confirmacion').style.display = 'block';
      document.getElementById('form-radicacion').style.display = 'none';
      
      // Marcar paso como completado
      document.querySelector('[data-step="1"]').classList.add('completed');
      
      showAlert(`‚úÖ Radicado <strong>${result.numero_radicado}</strong> creado exitosamente`, 'success');
      cargarHistorial();
    } else {
      showAlert(`‚ùå Error: ${result.error || 'No se pudo crear el radicado'}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error de conexi√≥n: ${err.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üíæ Guardar y Radicar';
  }
});

// === FASE 2: VISITA ===
document.getElementById('form-visita').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!radicadoActual) {
    showAlert('‚ùå Primero debes crear un radicado', 'error');
    return;
  }
  
  const data = {
    visita_fecha: document.getElementById('visita_fecha').value,
    visita_tecnico: document.getElementById('visita_tecnico').value,
    arbol_fitosanitario: document.getElementById('arbol_fitosanitario').value,
    visita_riesgo_final: document.getElementById('visita_riesgo_final').value,
    visita_observaciones: document.getElementById('visita_observaciones').value
  };
  
  try {
    const resp = await fetch(`/api/riesgo/arborea/${radicadoActual.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      document.getElementById('visita-confirmacion').style.display = 'block';
      document.getElementById('form-visita').style.display = 'none';
      document.querySelector('[data-step="2"]').classList.add('completed');
      showAlert('‚úÖ Visita t√©cnica registrada', 'success');
    } else {
      showAlert(`‚ùå Error: ${result.error}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  }
});

// === FASE 3: PERMISO ===
function toggleCompensacion() {
  const decision = document.getElementById('dictamen_decision').value;
  const section = document.getElementById('compensacion-section');
  section.style.display = (decision === 'Aprobado') ? 'block' : 'none';
}

async function calcularCompensacion() {
  const dap = parseFloat(document.getElementById('arbol_dap_cm').value) || radicadoActual?.dap || 0;
  const coef = parseFloat(document.getElementById('compensacion_coeficiente').value) || 1.5;
  
  try {
    const resp = await fetch('/api/riesgo/calcular-compensacion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dap_cm: dap, coeficiente: coef })
    });
    
    const result = await resp.json();
    
    if (result.success) {
      document.getElementById('compensacion-arboles-display').textContent = result.arboles_plantar;
      document.getElementById('calculo-detalles').textContent = result.detalles;
      document.getElementById('resultado-compensacion').style.display = 'block';
    }
  } catch (err) {
    console.error('Error:', err);
  }
}

document.getElementById('form-permiso').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!radicadoActual) {
    showAlert('‚ùå Primero debes crear un radicado', 'error');
    return;
  }
  
  const data = {
    dictamen_decision: document.getElementById('dictamen_decision').value,
    permiso_vigencia_dias: parseInt(document.getElementById('permiso_vigencia_dias').value),
    compensacion_coeficiente: parseFloat(document.getElementById('compensacion_coeficiente').value),
    compensacion_metodo: document.getElementById('compensacion_metodo').value,
    compensacion_especie_recomendada: document.getElementById('compensacion_especie_recomendada').value,
    compensacion_sitio: document.getElementById('compensacion_sitio').value,
    permiso_obligaciones: document.getElementById('permiso_obligaciones').value
  };
  
  try {
    const resp = await fetch(`/api/riesgo/arborea/${radicadoActual.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      document.getElementById('permiso-confirmacion').style.display = 'block';
      document.getElementById('form-permiso').style.display = 'none';
      document.querySelector('[data-step="3"]').classList.add('completed');
      showAlert('‚úÖ Permiso emitido exitosamente', 'success');
      cargarHistorial();
    } else {
      showAlert(`‚ùå Error: ${result.error}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  }
});

// === HISTORIAL ===
async function cargarHistorial() {
  try {
    const resp = await fetch('/api/riesgo/arborea?per_page=5');
    const data = await resp.json();
    
    const tbody = document.getElementById('historial-tbody');
    
    if (data.radicados && data.radicados.length > 0) {
      tbody.innerHTML = data.radicados.map(r => `
        <tr>
          <td><strong>${r.numero_radicado}</strong></td>
          <td>${r.solicitante_nombre}</td>
          <td>${r.arbol_especie_comun}</td>
          <td><span class="badge badge-${r.estado.toLowerCase()}">${r.estado}</span></td>
          <td>
            <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${r.id})">Ver</button>
          </td>
        </tr>
      `).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin registros</td></tr>';
    }
  } catch (err) {
    console.error('Error cargar historial:', err);
  }
}

function verDetalle(id) {
  window.location.href = `/riesgo/arborea/${id}`;
}

// Cargar historial al iniciar
document.addEventListener('DOMContentLoaded', () => {
  cargarHistorial();
  
  // Configurar fecha de visita con fecha actual
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('visita_fecha').value = today;
});
</script>
{% endblock %}
