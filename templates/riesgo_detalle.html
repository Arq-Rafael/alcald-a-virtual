{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-2">
  <h1>Incidente #{{ inc['consecutivo'] }}</h1>
  <div>
    <a class="btn btn-secondary" href="{{ url_for('riesgo_list') }}">Volver</a>
  </div>
</div>

<div class="row">
  <div class="col-lg-8">
    <div class="card mb-3">
      <div class="card-header">Ficha</div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-sm-3">Tipo</dt>
          <dd class="col-sm-9">{{ inc['tipo'] }}</dd>
          <dt class="col-sm-3">Alerta</dt>
          <dd class="col-sm-9"><span class="badge bg-{{ 'danger' if inc['nivel']=='Rojo' else ('warning' if inc['nivel']=='Amarillo' else 'success') }}">{{ inc['nivel'] }}</span></dd>
          <dt class="col-sm-3">Estado</dt>
          <dd class="col-sm-9"><span class="badge bg-info">{{ inc['estado'] }}</span></dd>
          <dt class="col-sm-3">Reportado</dt>
          <dd class="col-sm-9">{{ inc['fecha_reporte'] }}</dd>

          <dt class="col-sm-3">Dirección</dt>
          <dd class="col-sm-9">{{ inc['direccion'] }}{% if inc['sector'] %} — {{ inc['sector'] }}{% endif %}</dd>
          <dt class="col-sm-3">Ubicación</dt>
          <dd class="col-sm-9">{{ inc['lat'] }}, {{ inc['lon'] }}</dd>

          <dt class="col-sm-3">Descripción</dt>
          <dd class="col-sm-9">{{ inc['descripcion'] }}</dd>

          <dt class="col-sm-3">Reporte</dt>
          <dd class="col-sm-9">{{ inc['reportado_por'] }} / {{ inc['contacto'] }}</dd>

          <dt class="col-sm-3">Impacto</dt>
          <dd class="col-sm-9">
            Afectados: {{ inc['afectados'] or 0 }},
            Heridos: {{ inc['heridos'] or 0 }},
            Fallecidos: {{ inc['fallecidos'] or 0 }},
            Viviendas: {{ inc['viv_afectadas'] or 0 }}
          </dd>

          <dt class="col-sm-3">Recursos</dt>
          <dd class="col-sm-9">{{ inc['recursos'] or 'N/A' }}</dd>
        </dl>
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-header">Bitácora</div>
      <div class="card-body p-0">
        <ul class="list-group list-group-flush">
          {% for l in bitacora %}
          <li class="list-group-item d-flex justify-content-between">
            <div><strong>{{ l['evento'] }}</strong> — {{ l['detalle'] }} <small class="text-muted">por {{ l['user'] }}</small></div>
            <small class="text-muted">{{ l['ts'] }}</small>
          </li>
          {% else %}
          <li class="list-group-item text-muted">Sin eventos</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Gestión</span>
        <span class="badge bg-{{ inc['semaforo'] }}">{{ inc['hrs_restantes'] if inc['hrs_restantes'] is not none else '—' }} h</span>
      </div>
      <div class="card-body">
        <form method="post">
          <div class="mb-2">
            <label class="form-label">Estado</label>
            <select name="estado" class="form-select">
              {% for e in ['Abierto','En respuesta','Cerrado'] %}
              <option value="{{e}}" {% if inc['estado']==e %}selected{% endif %}>{{e}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Alerta</label>
            <select name="nivel" class="form-select">
              {% for n in ['Verde','Amarillo','Rojo'] %}
              <option value="{{n}}" {% if inc['nivel']==n %}selected{% endif %}>{{n}}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Recursos desplegados</label>
            <input name="recursos" class="form-control" value="{{ inc['recursos'] or '' }}">
          </div>
          <button class="btn btn-primary w-100">Guardar cambios</button>
        </form>
        {% if inc['estado'] != 'Cerrado' %}
        <form class="mt-2" method="post" action="{{ url_for('riesgo_cerrar', incidente_id=inc['id']) }}"
              onsubmit="return confirm('¿Cerrar el incidente?');">
          <button class="btn btn-outline-danger w-100">Cerrar incidente</button>
        </form>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <div class="card-header">Soportes</div>
      <div class="card-body">
        <form action="{{ url_for('riesgo_subir', incidente_id=inc['id']) }}" method="post" enctype="multipart/form-data" class="mb-2">
          <input type="file" name="file" class="form-control mb-2" required>
          <button class="btn btn-success w-100">Subir</button>
        </form>
        <ul class="list-group">
          {% for a in archivos %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>{{ a['filename'] }}</span>
            <small class="text-muted">{{ a['uploaded_en'] }}</small>
          </li>
          {% else %}
          <li class="list-group-item text-muted">Sin archivos</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}
