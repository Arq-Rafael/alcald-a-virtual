{% extends "base.html" %}
{% block content %}
<div class="container-fluid my-3">
  <div class="glass-panel p-4 mb-3">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="estado-chip estado-{{ (lic['estado'] or 'radicada')|lower|replace(' ','-')|replace('á','a')|replace('é','e')|replace('í','i')|replace('ó','o')|replace('ú','u') }}">{{ lic['estado'] }}</span>
          {% if dias_habiles is defined and semaforo_color is defined %}
          <span class="badge bg-{{ semaforo_color }} px-3 py-2" title="Días hábiles transcurridos">{{ dias_habiles }} días hábiles</span>
          {% endif %}
        </div>
        <h3 class="fw-bold mb-1">Licencia #{{ lic['consecutivo'] }}</h3>
        <p class="text-muted mb-0">{{ lic['direccion'] }} — {{ lic['solicitante'] }}</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a class="action-btn btn-view" href="{{ url_for('solicitudes.licencias_pdf', licencia_id=lic['id']) }}" data-tooltip="Generar PDF">
          <i class="bi bi-file-earmark-text"></i>
        </a>
        {% if lic['acta_path'] %}
        <a class="action-btn btn-upload" href="{{ url_for('solicitudes.licencias_descargar_acta', licencia_id=lic['id']) }}" data-tooltip="Descargar acta">
          <i class="bi bi-download"></i>
        </a>
        {% else %}
        <a class="action-btn btn-upload" href="#card-acta" data-tooltip="Cargar acta" onclick="scrollToAnchor('card-acta')">
          <i class="bi bi-clipboard-plus"></i>
        </a>
        {% endif %}
        <a class="action-btn btn-track" href="{{ url_for('solicitudes.licencias_list') }}" data-tooltip="Volver a la lista">
          <i class="bi bi-arrow-left"></i>
        </a>
      </div>
    </div>

    <!-- Sección SLA y próximas acciones -->
    <div class="glass-panel p-4 mb-3">
      <div class="row g-3">
        <!-- Progreso del trámite -->
        <div class="col-md-6">
          <div class="d-flex justify-content-between mb-2">
            <h6 class="fw-bold">Progreso del trámite</h6>
            <small class="text-muted">{{ (dias_habiles|int * 100 / 90)|round(0)|int }}%</small>
          </div>
          <div class="progress" style="height: 8px; border-radius: 10px; background: rgba(0,0,0,0.08);">
            <div class="progress-bar" style="width: {{ (dias_habiles|int * 100 / 90)|round(0)|int }}%; background: linear-gradient(90deg, #7cb342, #9ccc65); border-radius: 10px;"></div>
          </div>
          <small class="text-muted d-block mt-2">{{ dias_habiles }} de 90 días hábiles trascurridos</small>
        </div>
        
        <!-- SLA Visual -->
        <div class="col-md-6">
          <h6 class="fw-bold mb-2">SLA</h6>
          <div class="d-flex gap-2">
            {% if dias_habiles <= 30 %}
            <div class="sla-badge sla-green"><i class="bi bi-check-lg me-1"></i>En tiempo</div>
            <div class="sla-info">Plazo: 30 días hábiles</div>
            {% elif dias_habiles <= 45 %}
            <div class="sla-badge sla-amber"><i class="bi bi-exclamation-lg me-1"></i>Próximo a vencer</div>
            <div class="sla-info">{{ 45 - dias_habiles }} días hábiles restantes</div>
            {% else %}
            <div class="sla-badge sla-red"><i class="bi bi-x-circle me-1"></i>Vencido</div>
            <div class="sla-info">Requiere revisión urgente</div>
            {% endif %}
          </div>
        </div>

        <!-- Próximas acciones -->
        <div class="col-12 mt-3">
          <h6 class="fw-bold mb-2">Próximas acciones recomendadas</h6>
          <div class="action-timeline">
            {% if lic['estado'] == 'Radicada' %}
            <div class="action-step active"><i class="bi bi-check-circle-fill me-2"></i>Radicación registrada</div>
            <div class="action-step"><i class="bi bi-hourglass-split me-2"></i>Enviar a revisión</div>
            <div class="action-step"><i class="bi bi-file-text me-2"></i>Documentación completa</div>
            {% elif lic['estado'] == 'En revisión' %}
            <div class="action-step done"><i class="bi bi-check-circle-fill me-2"></i>Radicación registrada</div>
            <div class="action-step active"><i class="bi bi-hourglass-split me-2"></i>En revisión</div>
            <div class="action-step"><i class="bi bi-file-text me-2"></i>Documentación completa</div>
            {% elif lic['estado'] == 'Subsanación' %}
            <div class="action-step done"><i class="bi bi-check-circle-fill me-2"></i>Radicación registrada</div>
            <div class="action-step done"><i class="bi bi-check-circle-fill me-2"></i>Revisión completada</div>
            <div class="action-step active"><i class="bi bi-alert-triangle me-2"></i>Subsanación requerida</div>
            {% elif lic['estado'] == 'Aprobada' %}
            <div class="action-step done"><i class="bi bi-check-circle-fill me-2"></i>Aprobado</div>
            <div class="action-step"><i class="bi bi-file-earmark-pdf me-2"></i>Generar resolución</div>
            {% elif lic['estado'] == 'Negada' %}
            <div class="action-step done"><i class="bi bi-x-circle-fill me-2"></i>Negada</div>
            <div class="action-step"><i class="bi bi-arrow-counterclockwise me-2"></i>Reapresentación disponible</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <!-- Columna izquierda: expediente + bitácora -->
      <div class="col-xl-8">
        <div class="glass-panel p-4 mb-3" id="card-expediente">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0"><i class="bi bi-folder2-open me-2"></i>Expediente</h5>
            <span class="mini-chip">Actualizado {{ lic['actualizado_en'][:10] if lic['actualizado_en'] else 'hoy' }}</span>
          </div>

          <div class="row g-3 small text-muted">
            <div class="col-md-6">
              <p class="label">Tipo y modalidad</p>
              <p class="value">{{ lic['tipo'] }}{% if lic['objeto'] %} — {{ lic['objeto'] }}{% endif %}{% if lic['modalidad'] %} ({{ lic['modalidad'] }}){% endif %}</p>
            </div>
            <div class="col-md-6">
              <p class="label">Dirección</p>
              <p class="value">{{ lic['direccion'] or 'N/D' }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Cédula catastral</p>
              <p class="value">{{ lic['chip'] or 'N/D' }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Matrícula inmobiliaria</p>
              <p class="value">{{ lic['matricula'] or 'N/D' }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Clasificación del suelo</p>
              <p class="value">{{ lic['clasificacion_suelo'] or 'N/A' }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Uso</p>
              <p class="value">{{ lic['uso'] }}{% if lic['uso']=='Otro' and lic['uso_otro'] %}: {{ lic['uso_otro'] }}{% endif %}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Áreas</p>
              <p class="value">{{ lic['area_const'] or 0 }} m² construida / {{ lic['area_lote'] or 0 }} m² lote</p>
            </div>
            <div class="col-md-4">
              <p class="label">Tipo vivienda</p>
              <p class="value">{{ lic['tipo_vivienda'] or 'N/A' }}</p>
            </div>
            <div class="col-md-6">
              <p class="label">Solicitante</p>
              <p class="value">{{ lic['solicitante'] }} ({{ lic['tipo_doc_solicitante'] }} {{ lic['doc_solicitante'] }})</p>
            </div>
            <div class="col-md-6">
              <p class="label">Responsable técnico</p>
              <p class="value">{{ lic['responsable'] or 'N/D' }} ({{ lic['matricula_prof'] or 'N/D' }})</p>
            </div>
            <div class="col-md-4">
              <p class="label">BIC</p>
              <p class="value">{{ lic['bic'] or 'No' }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Valor</p>
              <p class="value">${{ '%.0f'|format(lic['valor'] or 0) }}</p>
            </div>
            <div class="col-md-4">
              <p class="label">Observaciones</p>
              <p class="value">{{ lic['observaciones'] or 'Sin observaciones' }}</p>
            </div>
          </div>
        </div>

        <div class="glass-panel p-4" id="card-bitacora">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0"><i class="bi bi-clock-history me-2"></i>Bitácora</h5>
            <span class="mini-chip">{{ bitacora|length }} eventos</span>
          </div>
          <div class="timeline">
            {% for l in bitacora %}
            <div class="timeline-item">
              <div class="bullet"></div>
              <div class="content">
                <div class="d-flex justify-content-between">
                  <strong>{{ l['evento'] }}</strong>
                  <small class="text-muted">{{ l['ts'] }}</small>
                </div>
                <p class="mb-1 text-muted small">{{ l['detalle'] }}</p>
                <small class="text-muted">{{ l['user'] }}</small>
              </div>
            </div>
            {% else %}
            <p class="text-muted mb-0">Sin eventos</p>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Columna derecha: gestión, acta, soportes, admin -->
      <div class="col-xl-4">
        <div class="glass-panel p-4 mb-3" id="card-estado">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0">Gestión y estado</h6>
            <span class="mini-chip">Seguimiento</span>
          </div>
          <form method="post" class="row g-3">
            <div class="col-12">
              <label class="form-label form-label-premium">Estado</label>
              <select name="estado" class="form-select form-control-glass">
                {% for e in ['Radicada','En revisión','Subsanación','Aprobada','Negada'] %}
                <option value="{{e}}" {% if lic['estado']==e %}selected{% endif %}>{{e}}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-12">
              <label class="form-label form-label-premium">Observaciones</label>
              <textarea name="observaciones" class="form-control form-control-glass" rows="3">{{ lic['observaciones'] or '' }}</textarea>
            </div>
            <div class="col-12">
              <label class="form-label form-label-premium">Valor ($)</label>
              <input type="number" step="0.01" name="valor" class="form-control form-control-glass" value="{{ lic['valor'] or 0 }}">
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-premium"><i class="bi bi-save2 me-2"></i>Guardar cambios</button>
            </div>
          </form>

          {% if is_admin %}
          <hr class="my-3">
          <form action="{{ url_for('solicitudes.licencias_set_consecutivo', licencia_id=lic['id']) }}" method="post" class="mb-2">
            <label class="form-label form-label-premium">Consecutivo manual (admin)</label>
            <div class="input-group">
              <input type="number" name="nuevo_consecutivo" class="form-control" placeholder="Ej. 125" required>
              <button class="btn btn-outline-dark">Cambiar</button>
            </div>
          </form>
          <form action="{{ url_for('solicitudes.licencias_eliminar', licencia_id=lic['id']) }}" method="post"
            onsubmit="return confirm('¿Eliminar este expediente?');">
            <button class="btn btn-outline-danger w-100">Eliminar expediente</button>
          </form>
          {% endif %}
        </div>

        <div class="glass-panel p-4 mb-3" id="card-acta">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0">Acta de observaciones</h6>
            {% if acta_dias_rest is not none %}
            <span class="badge bg-{{ acta_color|default('warning') }}">Restan {{ acta_dias_rest }} días hábiles</span>
            {% endif %}
          </div>
          {% if lic['acta_path'] %}
          <p class="text-muted small mb-3">
            <strong>Fecha del acta:</strong> {{ lic['acta_fecha'] or 'N/A' }}<br>
            <strong>Vence:</strong> {{ lic['acta_vence'] or 'N/A' }}
          </p>
          <a class="btn btn-outline-secondary w-100" href="{{ url_for('solicitudes.licencias_descargar_acta', licencia_id=lic['id']) }}">
            <i class="bi bi-download me-2"></i>Descargar acta
          </a>
          {% else %}
          <form action="{{ url_for('solicitudes.licencias_subir_acta', licencia_id=lic['id']) }}" method="post" enctype="multipart/form-data">
            <label class="form-label form-label-premium">Adjuntar acta (PDF)</label>
            <input type="file" name="acta_file" class="form-control mb-3" required>
            <button class="btn btn-warning w-100">Cargar acta y fijar plazo (15 días hábiles)</button>
          </form>
          {% endif %}
        </div>

        <div class="glass-panel p-4" id="card-soportes">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0">Soportes</h6>
            <span class="mini-chip">{{ archivos|length }} archivos</span>
          </div>
          <form action="{{ url_for('solicitudes.licencias_subir', licencia_id=lic['id']) }}" method="post" enctype="multipart/form-data" class="mb-3">
            <label class="form-label form-label-premium">Adjuntar archivo</label>
            <input type="file" name="file" class="form-control mb-2" required>
            <button class="btn btn-success w-100"><i class="bi bi-upload me-2"></i>Subir soporte</button>
          </form>
          <div class="list-group list-group-flush">
            {% for a in archivos %}
            <a class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" href="{{ url_for('solicitudes.licencias_archivo_descargar', archivo_id=a['id']) }}">
              <span>{{ a['filename'] }}</span>
              <small class="text-muted">{{ a['uploaded_en'] }}</small>
            </a>
            {% else %}
            <div class="list-group-item text-muted">Sin archivos</div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.estado-chip {
  border-radius: 999px;
  padding: 6px 14px;
  font-weight: 700;
  color: #0f172a;
  background: linear-gradient(135deg, #7ce7ff, #64b5f6);
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.4);
}
.estado-en-revision { background: linear-gradient(135deg, #ffe082, #ffca28); }
.estado-subsanacion { background: linear-gradient(135deg, #ffc58f, #ff8f70); }
.estado-aprobada { background: linear-gradient(135deg, #7cb342, #9ccc65); }
.estado-negada { background: linear-gradient(135deg, #ff8a80, #d32f2f); color: #fff; }

.mini-chip {
  background: rgba(15, 23, 42, 0.06);
  padding: 6px 10px;
  border-radius: 10px;
  font-size: 0.78rem;
  color: #475569;
  border: 1px solid rgba(15, 23, 42, 0.08);
}

.label { text-transform: uppercase; font-size: 0.72rem; letter-spacing: 0.04em; }
.value { color: #0f172a; font-weight: 600; margin-bottom: 0; }

.timeline { position: relative; }
.timeline::before {
  content: "";
  position: absolute;
  left: 12px;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(180deg, rgba(99,164,255,0.6), rgba(143,203,255,0));
}
.timeline-item { position: relative; padding-left: 36px; margin-bottom: 16px; }
.timeline-item .bullet {
  position: absolute; left: 6px; top: 4px;
  width: 12px; height: 12px; border-radius: 50%;
  background: linear-gradient(135deg, #6a85f1, #8fcbff);
  box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}
.timeline-item .content { background: rgba(255,255,255,0.72); border-radius: 12px; padding: 12px; border: 1px solid rgba(255,255,255,0.4); }

.flash { box-shadow: 0 0 0 3px rgba(99,164,255,0.35); transition: box-shadow 0.6s ease; }

.sla-badge {
  border-radius: 10px;
  padding: 8px 12px;
  font-weight: 600;
  font-size: 0.85rem;
  display: inline-flex;
  align-items: center;
}
.sla-green { background: linear-gradient(135deg, rgba(122, 179, 66, 0.15), rgba(156, 204, 101, 0.1)); color: #2d4d0f; }
.sla-amber { background: linear-gradient(135deg, rgba(255, 202, 40, 0.15), rgba(255, 193, 7, 0.1)); color: #5c4500; }
.sla-red { background: linear-gradient(135deg, rgba(211, 47, 47, 0.15), rgba(255, 106, 106, 0.1)); color: #5c0000; }
.sla-info { font-size: 0.85rem; color: #666; }

.action-timeline {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 12px;
}
.action-step {
  padding: 10px 14px;
  border-radius: 12px;
  background: rgba(255,255,255,0.65);
  border: 2px solid rgba(15,23,42,0.08);
  font-size: 0.85rem;
  font-weight: 500;
  color: #64748b;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
}
.action-step.active {
  background: linear-gradient(135deg, rgba(122, 179, 66, 0.12), rgba(156, 204, 101, 0.08));
  border-color: rgba(122, 179, 66, 0.3);
  color: #2d4d0f;
  font-weight: 600;
  box-shadow: 0 4px 12px rgba(122, 179, 66, 0.15);
}
.action-step.done {
  background: linear-gradient(135deg, rgba(122, 179, 66, 0.08), rgba(156, 204, 101, 0.04));
  border-color: rgba(122, 179, 66, 0.2);
  color: #2d4d0f;
}
.action-step i { color: currentColor; }

.action-btn {
  width: 36px; height: 36px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center;
  border: none; color: #fff; position: relative; text-decoration: none;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.action-btn:hover { transform: translateY(-1px); box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
.action-btn::after {
  content: attr(data-tooltip);
  position: absolute; bottom: -36px; left: 50%; transform: translateX(-50%);
  background: rgba(17,24,39,0.92); color: #fff; padding: 6px 10px; border-radius: 10px; font-size: 0.75rem;
  opacity: 0; pointer-events: none; transition: opacity 0.15s ease, transform 0.15s ease; white-space: nowrap;
  box-shadow: 0 10px 25px rgba(0,0,0,0.18);
}
.action-btn:hover::after { opacity: 1; transform: translate(-50%, -2px); }
.btn-view { background: linear-gradient(135deg, #6a85f1, #8fcbff); }
.btn-upload { background: linear-gradient(135deg, #ffb64d, #ff8858); }
.btn-track { background: linear-gradient(135deg, #7bd88f, #52c41a); }
</style>

<script>
function scrollToAnchor(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.scrollIntoView({ behavior: 'smooth', block: 'start' });
  el.classList.add('flash');
  setTimeout(() => el.classList.remove('flash'), 1200);
}

(() => {
  const params = new URLSearchParams(window.location.search);
  const focus = params.get('focus');
  if (focus === 'soportes') scrollToAnchor('card-soportes');
  if (focus === 'estado') scrollToAnchor('card-estado');
})();
</script>
{% endblock %}