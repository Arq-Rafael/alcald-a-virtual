{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-start mb-3 flex-wrap">
    <div>
      <h1 class="h3">Informe de Progreso de Metas #{{ informe.id }}</h1>
      <small class="text-muted">Alcaldía Municipal de Supatá — {{ informe.meta.meta_producto }}</small>
    </div>
    <div class="text-end">
      <div><strong>Contrato:</strong> {{ informe.contrato_num }}</div>
      <div><strong>Fecha:</strong> {{ informe.fecha_informe.strftime('%Y-%m-%d') }}</div>
      <div><strong>Oficina:</strong> {{ session.get('user_office','-') }}</div>
    </div>
  </div>

  <!-- Barra de progreso -->
  {% set pct = informe.meta.porcentaje_cumplimiento() %}
  <div class="mb-3">
    <div class="d-flex gap-2 align-items-center">
      <div><strong>Cumplimiento:</strong> {{ '%0.1f'|format(pct) }}%</div>
      <div class="flex-grow-1">
        <div class="progress" style="height: 14px;">
          <div class="progress-bar {% if pct >= 75 %}bg-success{% elif pct >= 40 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar" style="width: {{ pct }}%;" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
      <div>
        {% if pct >= 75 %}
          <span class="badge bg-success">En marcha</span>
        {% elif pct >= 40 %}
          <span class="badge bg-warning text-dark">Advertencia</span>
        {% else %}
          <span class="badge bg-danger">Retrasado</span>
        {% endif %}
      </div>
    </div>
    <div class="small text-muted mt-1">
      {% if pct < 40 %}
        Recomendación: Revisa responsables y acelera acciones.
      {% elif pct < 75 %}
        Recomendación: Monitorea de cerca, posible desvío.
      {% else %}
        Recomendación: Avance saludable.
      {% endif %}
    </div>
  </div>

  <!-- Meta y descripción -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">Meta del Plan</h5>
      <p>{{ informe.meta.meta_producto }}</p>
      <h5 class="card-title mt-3">Descripción de cumplimiento</h5>
      <p>{{ informe.descripcion }}</p>
    </div>
  </div>

  <!-- Evidencias -->
  <div class="mb-4">
    <h5>Evidencias fotográficas</h5>
    <div class="row g-3">
      {% for foto in informe.fotos %}
      <div class="col-md-6">
        <div class="card">
          <img src="{{ url_for('static', filename='uploads/informes_metas/' ~ foto.filename) }}" class="card-img-top" alt="Evidencia">
          <div class="card-body">
            <p class="card-text small text-muted">{{ foto.caption if foto.caption else 'Evidencia visual' }}</p>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Firmas -->
  <div class="row mt-5">
    <div class="col-md-6">
      <div class="border p-3">
        <div class="mb-2"><strong>Responsable del informe</strong></div>
        <div>Nombre: {{ session.get('user') }}</div>
        <div>Cargo: ________________________</div>
        <div class="mt-3">Firma: ________________________</div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="border p-3">
        <div class="mb-2"><strong>Revisor / Secretario</strong></div>
        <div>Nombre: ________________________</div>
        <div>Cargo: ________________________</div>
        <div class="mt-3">Firma: ________________________</div>
      </div>
    </div>
  </div>
</div>

<!-- Impresión limpia -->
<style>
  @media print {
    .btn { display: none; }
    body { font-size: 12px; }
    .card { box-shadow: none !important; }
  }
</style>
{% endblock %}
