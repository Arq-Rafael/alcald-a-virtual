{% extends "base.html" %}
{% block content %}
<div class="container-fluid my-4">
  <div class="glass-panel p-4 mb-4">
    <div class="d-flex flex-wrap justify-content-between align-items-start gap-3">
      <div>
        <h2 class="fw-bold mb-1" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
          <i class="bi bi-building-gear me-2"></i>Licencias Urbanísticas
        </h2>
        <p class="text-muted mb-0">Radica, hace seguimiento y carga soportes desde una sola vista.</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-premium px-4" data-bs-toggle="modal" data-bs-target="#modalRadicar">
          <i class="bi bi-plus-circle me-2"></i>Radicar licencia
        </button>
        <a class="btn btn-outline-secondary px-3" style="border-radius: 12px;" href="{{ url_for('solicitudes.licencias_nueva') }}">
          <i class="bi bi-window-plus me-2"></i>Pantalla completa
        </a>
      </div>
    </div>

    <!-- KPIs rápidos -->
    {% set total = rows|length %}
    {% set rad = rows|selectattr('estado','equalto','Radicada')|list|length %}
    {% set rev = rows|selectattr('estado','equalto','En revisión')|list|length %}
    {% set sub = rows|selectattr('estado','equalto','Subsanación')|list|length %}
    {% set apr = rows|selectattr('estado','equalto','Aprobada')|list|length %}
    {% set neg = rows|selectattr('estado','equalto','Negada')|list|length %}
    <div class="row g-2 mb-4">
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">Total</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ total }}</h3>
            <span class="badge kpi-badge kpi-neutral">Todo</span>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">Radicadas</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ rad }}</h3>
            <span class="badge kpi-badge kpi-blue">On time</span>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">En revisión</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ rev }}</h3>
            <span class="badge kpi-badge kpi-amber">Analizando</span>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">Subsanación</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ sub }}</h3>
            <span class="badge kpi-badge kpi-orange">Ajustes</span>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">Aprobadas</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ apr }}</h3>
            <span class="badge kpi-badge kpi-green">OK</span>
          </div>
        </div>
      </div>
      <div class="col-lg col-md-4 col-sm-6">
        <div class="kpi-card">
          <p class="text-muted small mb-1">Negadas</p>
          <div class="d-flex align-items-baseline gap-2">
            <h3 class="mb-0 fw-bold">{{ neg }}</h3>
            <span class="badge kpi-badge kpi-red">Alertas</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <form class="row g-2 mb-3 align-items-end" method="get">
      <div class="col-lg-2 col-md-3">
        <label class="form-label form-label-premium small">Estado</label>
        <select name="estado" class="form-select form-control-glass">
          <option value="">Todos</option>
          {% for e in ['Radicada','En revisión','Subsanación','Aprobada','Negada'] %}
          <option value="{{e}}" {% if request.args.get('estado')==e %}selected{% endif %}>{{e}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-lg-7 col-md-6">
        <label class="form-label form-label-premium small">Búsqueda</label>
        <input type="text" class="form-control form-control-glass" name="q"
          placeholder="Dirección, solicitante, cédula catastral o matrícula..."
          value="{{ request.args.get('q','') }}">
      </div>
      <div class="col-lg-3 col-md-3 d-flex gap-2">
        <button class="btn btn-premium flex-fill">
          <i class="bi bi-funnel me-1"></i>Filtrar
        </button>
        <a class="btn btn-outline-secondary" href="{{ url_for('solicitudes.licencias_list') }}" 
           style="border-radius: 12px;" title="Limpiar filtros">
          <i class="bi bi-x-circle"></i>
        </a>
      </div>
    </form>
  </div>

  <!-- Tabla de resultados con acciones directas -->
  <div class="glass-panel p-4">
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead>
          <tr class="border-bottom">
            <th class="fw-bold text-muted">#</th>
            <th class="fw-bold text-muted">Dirección</th>
            <th class="fw-bold text-muted">Solicitante</th>
            <th class="fw-bold text-muted">Uso</th>
            <th class="fw-bold text-muted">Área (m²)</th>
            <th class="fw-bold text-muted">Estado</th>
            <th class="fw-bold text-muted">SLA</th>
            <th class="fw-bold text-muted">Actualizado</th>
            <th class="fw-bold text-muted text-end">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for r in rows %}
          <tr class="row-licencia">
            <td><strong class="text-primary">#{{ r['consecutivo'] }}</strong></td>
            <td>{{ r['direccion'] or '-' }}</td>
            <td>{{ r['solicitante'] or '-' }}</td>
            <td>{{ r['uso'] or '-' }}</td>
            <td>{{ (r['area_const'] or 0)|round(2) }}</td>
            <td>
              <span class="estado-chip estado-{{ (r['estado'] or 'radicada')|lower|replace(' ','-')|replace('á','a')|replace('é','e')|replace('í','i')|replace('ó','o')|replace('ú','u') }}">{{ r['estado'] }}</span>
            </td>
            <td>
              <span class="badge bg-{{ r['semaforo_color'] }} rounded-pill px-3 py-2" title="Días hábiles transcurridos">
                {{ r['dias_habiles'] }} días
              </span>
            </td>
            <td class="text-muted small">{{ r['actualizado_en'][:10] if r['actualizado_en'] else '-' }}</td>
            <td class="text-end">
              <div class="d-flex justify-content-end gap-2 action-buttons-wrapper">
                <a class="action-btn btn-track" 
                   href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id'], focus='estado') }}" 
                   data-bs-toggle="tooltip" 
                   data-bs-placement="top" 
                   title="Seguimiento / Estado">
                  <i class="bi bi-activity"></i>
                </a>
                <a class="action-btn btn-upload" 
                   href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id'], focus='soportes') }}" 
                   data-bs-toggle="tooltip" 
                   data-bs-placement="top" 
                   title="Cargar información">
                  <i class="bi bi-upload"></i>
                </a>
                <a class="action-btn btn-view" 
                   href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id']) }}" 
                   data-bs-toggle="tooltip" 
                   data-bs-placement="top" 
                   title="Ver detalles">
                  <i class="bi bi-eye"></i>
                </a>
                <button class="action-btn btn-delete" 
                        data-bs-toggle="tooltip" 
                        data-bs-placement="top" 
                        title="Eliminar licencia"
                        onclick="if(confirm('¿Eliminar esta licencia permanentemente?')) { fetch('{{ url_for('solicitudes.licencias_eliminar', licencia_id=r['id']) }}', {method:'POST'}).then(r => r.text()).then(() => location.reload()).catch(e => alert('Solo administradores pueden eliminar')); }">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted py-5">
              <i class="bi bi-inbox display-4 d-block mb-3 opacity-25"></i>
              <p class="mb-0">No se encontraron licencias</p>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Modal de radicación rápida -->
<div class="modal fade" id="modalRadicar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass-panel">
      <div class="modal-header border-0 pb-0">
        <div>
          <h5 class="modal-title fw-bold">Radicar licencia</h5>
          <p class="text-muted mb-0">Radica sin salir de la lista. Luego podrás ampliar la info en detalle.</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-3">
        <form action="{{ url_for('solicitudes.licencias_nueva') }}" method="post" class="row g-3">
          <div class="col-md-4">
            <label class="form-label form-label-premium">Tipo de trámite</label>
            <select name="tipo" class="form-select form-control-glass" required>
              <option value="Licencia de Construcción">Licencia de Construcción</option>
              <option value="Licencia de Parcelación">Licencia de Parcelación</option>
              <option value="Licencia de Urbanización">Licencia de Urbanización</option>
              <option value="Licencia de Subdivisión">Licencia de Subdivisión</option>
              <option value="Reconocimiento de la existencia de una edificacion">Reconocimiento de edificación</option>
              <option value="Otras actuaciones">Otras actuaciones</option>
              <option value="Revalidación">Revalidación</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Modalidad</label>
            <input name="modalidad" class="form-control form-control-glass" placeholder="Obra nueva / Adecuación">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Objeto</label>
            <select name="objeto" class="form-select form-control-glass">
              <option value="">(N/A)</option>
              <option value="Prórroga">Prórroga</option>
              <option value="Modificación de licencia vigente">Modificación de licencia vigente</option>
              <option value="Revalidación">Revalidación</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label form-label-premium">Dirección</label>
            <input name="direccion" class="form-control form-control-glass" required placeholder="Calle 10 # 5-20">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Cédula catastral</label>
            <input name="chip" class="form-control form-control-glass">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Matrícula</label>
            <input name="matricula" class="form-control form-control-glass">
          </div>

          <div class="col-md-4">
            <label class="form-label form-label-premium">Solicitante</label>
            <input name="solicitante" class="form-control form-control-glass" required>
          </div>
          <div class="col-md-2">
            <label class="form-label form-label-premium">Tipo doc</label>
            <select name="tipo_doc_solicitante" class="form-select form-control-glass">
              <option>CC</option>
              <option>NIT</option>
              <option>CE</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Documento</label>
            <input name="doc_solicitante" class="form-control form-control-glass">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Uso</label>
            <select name="uso" class="form-select form-control-glass">
              <option>Vivienda</option>
              <option>Comercio y/o Servicios</option>
              <option>Institucional</option>
              <option>Industrial</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label form-label-premium">Área construida (m²)</label>
            <input name="area_const" type="number" step="0.01" class="form-control form-control-glass">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Área lote (m²)</label>
            <input name="area_lote" type="number" step="0.01" class="form-control form-control-glass">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Valor ($)</label>
            <input name="valor" type="number" step="0.01" class="form-control form-control-glass">
          </div>

          <div class="col-12">
            <label class="form-label form-label-premium">Observaciones</label>
            <textarea name="observaciones" rows="2" class="form-control form-control-glass" placeholder="Notas rápidas"></textarea>
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-premium px-4">
              <i class="bi bi-check-circle me-2"></i>Radicar y abrir expediente
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.row-licencia:hover {
  background: rgba(255, 255, 255, 0.55);
  transform: translateY(-1px);
  box-shadow: 0 4px 14px rgba(0,0,0,0.05);
}

.kpi-card {
  background: rgba(255,255,255,0.65);
  border-radius: 16px;
  padding: 14px 16px;
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: 0 6px 20px rgba(0,0,0,0.05);
}

.kpi-badge { border-radius: 999px; padding: 4px 10px; font-size: 0.75rem; }
.kpi-neutral { background: #f1f3f5; color: #343a40; }
.kpi-blue { background: linear-gradient(135deg, #63a4ff, #3f87f5); color: #fff; }
.kpi-amber { background: linear-gradient(135deg, #f6d365, #fda085); color: #5c3b00; }
.kpi-orange { background: linear-gradient(135deg, #ffb88c, #de6262); color: #5c2c10; }
.kpi-green { background: linear-gradient(135deg, #a5d6a7, #81c784); color: #1b5e20; }
.kpi-red { background: linear-gradient(135deg, #ff6a6a, #d32f2f); color: #fff; }

.estado-chip {
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 0.85rem;
  font-weight: 600;
  color: #0f172a;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
}
.estado-radicada { background: linear-gradient(135deg, #7ce7ff, #64b5f6); }
.estado-en-revision { background: linear-gradient(135deg, #ffe082, #ffca28); }
.estado-subsanacion { background: linear-gradient(135deg, #ffc58f, #ff8f70); }
.estado-aprobada { background: linear-gradient(135deg, #7cb342, #9ccc65); }
.estado-negada { background: linear-gradient(135deg, #ff8a80, #d32f2f); color: #fff; }

.action-btn {
  width: 36px; height: 36px;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  color: #fff;
  position: relative;
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
}
.action-btn:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  color: #fff;
}

.action-buttons-wrapper {
  position: relative;
  z-index: 1;
}

.btn-view { background: linear-gradient(135deg, #6a85f1, #8fcbff); }
.btn-view:hover { background: linear-gradient(135deg, #5a75e1, #7fbbef); }

.btn-upload { background: linear-gradient(135deg, #ffb64d, #ff8858); }
.btn-upload:hover { background: linear-gradient(135deg, #ffa63d, #ff7848); }

.btn-track { background: linear-gradient(135deg, #7bd88f, #52c41a); }
.btn-track:hover { background: linear-gradient(135deg, #6bc87f, #42b40a); }

.btn-delete { background: linear-gradient(135deg, #c62828, #e53935); }
.btn-delete:hover { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
</style>

<script>
// Inicializar tooltips de Bootstrap
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl, {
      trigger: 'hover',
      delay: { show: 200, hide: 0 }
    });
  });
});
</script>
{% endblock %}