{% extends "base.html" %}
{% block content %}
<div class="bg-animated" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #fff5e1 0%, #ffe0b2 50%, #fff9c4 100%);"></div>

<div class="container-fluid" style="max-width: 1400px; padding: 30px 20px;">
  
  <!-- Header mejorado -->
  <div style="margin-bottom: 40px;">
    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 25px; flex-wrap: wrap;">
      <div>
        <h2 style="font-size: 32px; font-weight: 700; color: #1a1a1a; margin: 0; background: linear-gradient(135deg, #FF9800, #FF6F00); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;">
          <i class="bi bi-building-fill me-2"></i>Licencias Urban√≠sticas
        </h2>
        <p style="color: #999; font-size: 15px; margin: 0;">Gestiona tus tr√°mites de licencias de construcci√≥n, parcelaci√≥n y m√°s</p>
      </div>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('solicitudes.licencias_nueva') }}" style="padding: 12px 24px; border-radius: 12px; border: none; background: linear-gradient(135deg, #FF9800, #FF6F00); color: white; font-weight: 600; text-decoration: none; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);">
          <i class="bi bi-plus-circle"></i>Nueva Licencia
        </a>
        <button class="btn btn-outline-secondary px-3" style="border-radius: 12px;" data-bs-toggle="modal" data-bs-target="#modalRadicar">
          <i class="bi bi-lightning-fill me-2" style="color: #FF9800;"></i>Radicar aqu√≠
        </button>
      </div>
    </div>

    <!-- KPIs mejorados -->
    {% set total = rows|length %}
    {% set rad = rows|selectattr('estado','equalto','Radicada')|list|length %}
    {% set rev = rows|selectattr('estado','equalto','En revisi√≥n')|list|length %}
    {% set sub = rows|selectattr('estado','equalto','Subsanaci√≥n')|list|length %}
    {% set apr = rows|selectattr('estado','equalto','Aprobada')|list|length %}
    {% set neg = rows|selectattr('estado','equalto','Negada')|list|length %}
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 22px; margin-bottom: 24px; align-items: start;">
      <!-- Main column: filtros + tabla -->
      <div>
        <div style="background: white; border-radius: 12px; padding: 18px; margin-bottom: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.06);">
          <form class="d-flex gap-2 align-items-end" method="get" style="width: 100%; flex-wrap: nowrap; gap:12px;">
            <div style="flex: 0 0 220px;">
              <label style="font-weight: 600; color: #333; font-size: 13px; display: block; margin-bottom: 6px;">Estado</label>
              <select name="estado" style="width: 100%; padding: 10px 12px; border: 1px solid #e6e6e6; border-radius: 10px; font-size: 13px; color: #333; background: white;">
                <option value="">Todos</option>
                {% for e in ['Radicada','En revisi√≥n','Subsanaci√≥n','Aprobada','Negada'] %}
                <option value="{{e}}" {% if request.args.get('estado')==e %}selected{% endif %}>{{e}}</option>
                {% endfor %}
              </select>
            </div>
            <div style="flex: 1; min-width: 220px;">
              <label style="font-weight: 600; color: #333; font-size: 13px; display: block; margin-bottom: 6px;">Buscar</label>
              <input type="text" name="q" style="width: 100%; padding: 10px 12px; border: 1px solid #e6e6e6; border-radius: 10px; font-size: 13px; color: #333;" placeholder="Direcci√≥n, solicitante, c√©dula o matr√≠cula..." value="{{request.args.get('q','')}}">
            </div>
            <div style="display:flex; gap:10px;">
              <button type="submit" style="padding: 10px 18px; border-radius: 10px; border: none; background: #2E7D32; color: white; font-weight: 600; cursor: pointer; font-size: 13px;">üîç Buscar</button>
              <a href="{{ url_for('solicitudes.licencias_list') }}" style="padding: 10px 14px; border-radius: 10px; border: 1px solid #ddd; background: white; color: #666; font-weight: 600; text-decoration: none;">‚Üª Limpiar</a>
            </div>
          </form>
        </div>

        <div class="glass-panel p-3" style="border-radius:12px; padding: 12px;">
          <div class="table-responsive">
            <table class="table table-hover align-middle" style="margin-bottom:0;">
              <thead>
                <tr class="border-bottom">
                  <th class="fw-bold text-muted">#</th>
                  <th class="fw-bold text-muted">Direcci√≥n</th>
                  <th class="fw-bold text-muted">Solicitante</th>
                  <th class="fw-bold text-muted">Uso</th>
                  <th class="fw-bold text-muted">√Årea (m¬≤)</th>
                  <th class="fw-bold text-muted">Estado</th>
                  <th class="fw-bold text-muted">SLA</th>
                  <th class="fw-bold text-muted">Actualizado</th>
                  <th class="fw-bold text-muted text-end">Acciones</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rows %}
                <tr class="row-licencia">
                  <td><strong class="text-primary">#{{ r['consecutivo'] }}</strong></td>
                  <td>{{ r['direccion'] or '-' }}</td>
                  <td>{{ r['solicitante'] or '-' }}</td>
                  <td>{{ r['uso'] or '-' }}</td>
                  <td>{{ (r['area_const'] or 0)|round(2) }}</td>
                  <td>
                    <span class="estado-chip estado-{{ (r['estado'] or 'radicada')|lower|replace(' ','-')|replace('√°','a')|replace('√©','e')|replace('√≠','i')|replace('√≥','o')|replace('√∫','u') }}">{{ r['estado'] }}</span>
                  </td>
                  <td>
                    <span class="badge bg-{{ r['semaforo_color'] }} rounded-pill px-3 py-2" title="D√≠as h√°biles transcurridos">{{ r['dias_habiles'] }} d√≠as</span>
                  </td>
                  <td class="text-muted small">{{ r['actualizado_en'][:10] if r['actualizado_en'] else '-' }}</td>
                  <td class="text-end">
                    <div class="d-flex justify-content-end gap-2 action-buttons-wrapper">
                      <a class="action-btn btn-track" href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id'], focus='estado') }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Seguimiento / Estado"><i class="bi bi-activity"></i></a>
                      <a class="action-btn btn-upload" href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id'], focus='soportes') }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Cargar informaci√≥n"><i class="bi bi-upload"></i></a>
                      <a class="action-btn btn-view" href="{{ url_for('solicitudes.licencias_detalle', licencia_id=r['id']) }}" data-bs-toggle="tooltip" data-bs-placement="top" title="Ver detalles"><i class="bi bi-eye"></i></a>
                      <button class="action-btn btn-delete" data-bs-toggle="tooltip" data-bs-placement="top" title="Eliminar licencia" onclick="if(confirm('¬øEliminar esta licencia permanentemente?')) { fetch('{{ url_for('solicitudes.licencias_eliminar', licencia_id=r['id']) }}', {method:'POST'}).then(r => r.text()).then(() => location.reload()).catch(e => alert('Solo administradores pueden eliminar')); }"><i class="bi bi-trash"></i></button>
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="9" class="text-center text-muted py-5"><i class="bi bi-inbox display-4 d-block mb-3 opacity-25"></i><p class="mb-0">No se encontraron licencias</p></td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sidebar: tarjetas verticales KPI -->
      <div>
        <div style="display: flex; flex-direction: column; gap: 14px;">
          <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04);">
            <p style="margin: 0 0 6px 0; color: #888; font-weight: 700; text-transform: uppercase; font-size: 12px;">Subsanaci√≥n</p>
            <div style="display:flex; align-items:center; gap:12px;">
              <h2 style="margin:0; font-size:28px; color:#1b5e20;">{{ sub }}</h2>
              <span style="padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,#ffb88c,#de6262); color:#5c2c10; font-weight:700;">Ajustes</span>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04);">
            <p style="margin: 0 0 6px 0; color: #888; font-weight: 700; text-transform: uppercase; font-size: 12px;">Aprobadas</p>
            <div style="display:flex; align-items:center; gap:12px;">
              <h2 style="margin:0; font-size:28px; color:#2e7d32;">{{ apr }}</h2>
              <span style="padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,#a5d6a7,#81c784); color:#1b5e20; font-weight:700;">OK</span>
            </div>
          </div>

          <div style="background: rgba(255,255,255,0.9); border-radius: 12px; padding: 18px; box-shadow: 0 6px 18px rgba(0,0,0,0.04);">
            <p style="margin: 0 0 6px 0; color: #888; font-weight: 700; text-transform: uppercase; font-size: 12px;">Negadas</p>
            <div style="display:flex; align-items:center; gap:12px;">
              <h2 style="margin:0; font-size:28px; color:#c62828;">{{ neg }}</h2>
              <span style="padding:6px 12px; border-radius:999px; background:linear-gradient(135deg,#ff6a6a,#d32f2f); color:#fff; font-weight:700;">Alertas</span>
            </div>
          </div>
        </div>
      </div>
    </div>
</div>

<!-- Modal de radicaci√≥n r√°pida -->
<div class="modal fade" id="modalRadicar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content glass-panel">
      <div class="modal-header border-0 pb-0">
        <div>
          <h5 class="modal-title fw-bold">Radicar licencia</h5>
          <p class="text-muted mb-0">Radica sin salir de la lista. Luego podr√°s ampliar la info en detalle.</p>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body pt-3">
        <form action="{{ url_for('solicitudes.licencias_nueva') }}" method="post" class="row g-3">
          <div class="col-md-4">
            <label class="form-label form-label-premium">Tipo de tr√°mite</label>
            <select name="tipo" class="form-select form-control-glass" required>
              <option value="Licencia de Construcci√≥n">Licencia de Construcci√≥n</option>
              <option value="Licencia de Parcelaci√≥n">Licencia de Parcelaci√≥n</option>
              <option value="Licencia de Urbanizaci√≥n">Licencia de Urbanizaci√≥n</option>
              <option value="Licencia de Subdivisi√≥n">Licencia de Subdivisi√≥n</option>
              <option value="Reconocimiento de la existencia de una edificacion">Reconocimiento de edificaci√≥n</option>
              <option value="Otras actuaciones">Otras actuaciones</option>
              <option value="Revalidaci√≥n">Revalidaci√≥n</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Modalidad</label>
            <input name="modalidad" class="form-control form-control-glass" placeholder="Obra nueva / Adecuaci√≥n">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Objeto</label>
            <select name="objeto" class="form-select form-control-glass">
              <option value="">(N/A)</option>
              <option value="Pr√≥rroga">Pr√≥rroga</option>
              <option value="Modificaci√≥n de licencia vigente">Modificaci√≥n de licencia vigente</option>
              <option value="Revalidaci√≥n">Revalidaci√≥n</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label form-label-premium">Direcci√≥n</label>
            <input name="direccion" class="form-control form-control-glass" required placeholder="Calle 10 # 5-20">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">C√©dula catastral</label>
            <input name="chip" class="form-control form-control-glass">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Matr√≠cula</label>
            <input name="matricula" class="form-control form-control-glass">
          </div>

          <div class="col-md-4">
            <label class="form-label form-label-premium">Solicitante</label>
            <input name="solicitante" class="form-control form-control-glass" required>
          </div>
          <div class="col-md-2">
            <label class="form-label form-label-premium">Tipo doc</label>
            <select name="tipo_doc_solicitante" class="form-select form-control-glass">
              <option>CC</option>
              <option>NIT</option>
              <option>CE</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Documento</label>
            <input name="doc_solicitante" class="form-control form-control-glass">
          </div>
          <div class="col-md-3">
            <label class="form-label form-label-premium">Uso</label>
            <select name="uso" class="form-select form-control-glass">
              <option>Vivienda</option>
              <option>Comercio y/o Servicios</option>
              <option>Institucional</option>
              <option>Industrial</option>
              <option>Otro</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label form-label-premium">√Årea construida (m¬≤)</label>
            <input name="area_const" type="number" step="0.01" class="form-control form-control-glass">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">√Årea lote (m¬≤)</label>
            <input name="area_lote" type="number" step="0.01" class="form-control form-control-glass">
          </div>
          <div class="col-md-4">
            <label class="form-label form-label-premium">Valor ($)</label>
            <input name="valor" type="number" step="0.01" class="form-control form-control-glass">
          </div>

          <div class="col-12">
            <label class="form-label form-label-premium">Observaciones</label>
            <textarea name="observaciones" rows="2" class="form-control form-control-glass" placeholder="Notas r√°pidas"></textarea>
          </div>

          <div class="col-12 text-end">
            <button type="submit" class="btn btn-premium px-4">
              <i class="bi bi-check-circle me-2"></i>Radicar y abrir expediente
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
.row-licencia:hover {
  background: rgba(255, 255, 255, 0.55);
  transform: translateY(-1px);
  box-shadow: 0 4px 14px rgba(0,0,0,0.05);
}

.kpi-card {
  background: rgba(255,255,255,0.65);
  border-radius: 16px;
  padding: 14px 16px;
  border: 1px solid rgba(255,255,255,0.35);
  box-shadow: 0 6px 20px rgba(0,0,0,0.05);
}

.kpi-badge { border-radius: 999px; padding: 4px 10px; font-size: 0.75rem; }
.kpi-neutral { background: #f1f3f5; color: #343a40; }
.kpi-blue { background: linear-gradient(135deg, #63a4ff, #3f87f5); color: #fff; }
.kpi-amber { background: linear-gradient(135deg, #f6d365, #fda085); color: #5c3b00; }
.kpi-orange { background: linear-gradient(135deg, #ffb88c, #de6262); color: #5c2c10; }
.kpi-green { background: linear-gradient(135deg, #a5d6a7, #81c784); color: #1b5e20; }
.kpi-red { background: linear-gradient(135deg, #ff6a6a, #d32f2f); color: #fff; }

.estado-chip {
  border-radius: 999px;
  padding: 6px 14px;
  font-size: 0.85rem;
  font-weight: 600;
  color: #0f172a;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.35);
}
.estado-radicada { background: linear-gradient(135deg, #7ce7ff, #64b5f6); }
.estado-en-revision { background: linear-gradient(135deg, #ffe082, #ffca28); }
.estado-subsanacion { background: linear-gradient(135deg, #ffc58f, #ff8f70); }
.estado-aprobada { background: linear-gradient(135deg, #7cb342, #9ccc65); }
.estado-negada { background: linear-gradient(135deg, #ff8a80, #d32f2f); color: #fff; }

.action-btn {
  width: 36px; height: 36px;
  border-radius: 12px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border: none;
  color: #fff;
  position: relative;
  text-decoration: none;
  transition: all 0.2s ease;
  cursor: pointer;
}
.action-btn:hover { 
  transform: translateY(-2px); 
  box-shadow: 0 8px 16px rgba(0,0,0,0.15);
  color: #fff;
}

.action-buttons-wrapper {
  position: relative;
  z-index: 1;
}

.btn-view { background: linear-gradient(135deg, #6a85f1, #8fcbff); }
.btn-view:hover { background: linear-gradient(135deg, #5a75e1, #7fbbef); }

.btn-upload { background: linear-gradient(135deg, #ffb64d, #ff8858); }
.btn-upload:hover { background: linear-gradient(135deg, #ffa63d, #ff7848); }

.btn-track { background: linear-gradient(135deg, #7bd88f, #52c41a); }
.btn-track:hover { background: linear-gradient(135deg, #6bc87f, #42b40a); }

.btn-delete { background: linear-gradient(135deg, #c62828, #e53935); }
.btn-delete:hover { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
</style>

<script>
// Inicializar tooltips de Bootstrap
document.addEventListener('DOMContentLoaded', function() {
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl, {
      trigger: 'hover',
      delay: { show: 200, hide: 0 }
    });
  });
});
</script>
{% endblock %}