{% extends "base.html" %}
{% block title %}Gesti√≥n Arb√≥rea - Sistema de Radicaci√≥n{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gestion_riesgo.css') }}">
<style>
  .wizard-container { max-width: 1000px; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); }
  .wizard-header { background: linear-gradient(135deg, #2d5016 0%, #7cb342 100%); color: white; padding: 30px; border-radius: 12px 12px 0 0; }
  .wizard-header h1 { margin: 0; font-size: 28px; }
  .wizard-steps { display: flex; justify-content: space-between; padding: 24px; border-bottom: 2px solid #f0f0f0; background: #fafafa; }
  .wizard-step { flex: 1; text-align: center; position: relative; }
  .wizard-step::after { content: ''; position: absolute; top: 20px; left: 50%; width: 100%; height: 2px; background: #ddd; z-index: -1; }
  .wizard-step:last-child::after { display: none; }
  .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #ddd; color: #666; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; margin-bottom: 8px; transition: all 0.3s; }
  .wizard-step.active .step-circle { background: #2d5016; color: white; transform: scale(1.1); }
  .wizard-step.completed .step-circle { background: #7cb342; color: white; }
  .wizard-body { padding: 40px; }
  .form-section { display: none; }
  .form-section.active { display: block; animation: slideIn 0.3s ease-in; }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  .btn-primary-custom { background: #2d5016; color: white; border: none; padding: 12px 28px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
  .btn-primary-custom:hover { background: #7cb342; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  .btn-secondary-custom { background: #6c757d; color: white; border: none; padding: 12px 28px; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 10px; transition: all 0.3s; }
  .btn-secondary-custom:hover { background: #5a6268; }
  .btn-danger-custom { background: #dc3545; color: white; border: none; padding: 12px 28px; border-radius: 6px; font-weight: 600; cursor: pointer; }
  .btn-danger-custom:hover { background: #c82333; }
  .alert { padding: 16px 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid; }
  .alert-success { background: #d4edda; color: #155724; border-left-color: #28a745; }
  .alert-error { background: #f8d7da; color: #721c24; border-left-color: #dc3545; }
  .alert-info { background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8; }
  .alert-warning { background: #fff3cd; color: #856404; border-left-color: #ffc107; }
  .radicado-badge { display: inline-block; background: #2d5016; color: white; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 18px; margin: 12px 0; }
  .estado-badge { display: inline-block; padding: 6px 12px; border-radius: 16px; font-weight: 600; font-size: 12px; }
  .estado-radicada { background: #ffc107; color: #000; }
  .estado-pendiente { background: #17a2b8; color: white; }
  .estado-aprobada { background: #28a745; color: white; }
  .estado-negada { background: #dc3545; color: white; }
  .data-summary { background: #f8f9fa; border-left: 4px solid #2d5016; padding: 16px; margin: 16px 0; border-radius: 4px; }
  .data-summary strong { color: #2d5016; }
  .form-group-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #e9ecef; }
  .form-group-section h4 { margin-top: 0; color: #2d5016; font-size: 16px; }
  .file-upload { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.3s; }
  .file-upload:hover { border-color: #2d5016; background: #f8f9fa; }
  .file-upload.dragover { border-color: #2d5016; background: #e8f5e9; }
  .uploaded-files { margin-top: 12px; }
  .file-item { background: white; padding: 10px; margin: 6px 0; border-radius: 4px; border-left: 3px solid #7cb342; display: flex; justify-content: space-between; align-items: center; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #2d5016; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 8px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  .btn-small { padding: 4px 8px; font-size: 12px; }
  .table-sm td { padding: 8px; }
  .badge { padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
  .autocomplete-list { position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; width: calc(100% - 32px); margin-top: 4px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
  .autocomplete-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; }
  .autocomplete-item:hover { background: #f8f9fa; }
  .autocomplete-item small { color: #6c757d; font-style: italic; display: block; margin-top: 2px; }
  .compensacion-result { background: #e8f5e9; padding: 20px; border-radius: 8px; margin: 16px 0; border-left: 4px solid #7cb342; text-align: center; }
  .compensacion-numero { font-size: 36px; font-weight: bold; color: #2d5016; }
  .historial-container { margin-top: 40px; padding-top: 40px; border-top: 2px solid #f0f0f0; }
  
  /* ESTILOS DE BOTONES MEJORADOS */
  .actions-cell { white-space: nowrap; padding: 8px !important; }
  .btn-group-actions { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
  
  .action-btn { 
    display: inline-flex; 
    align-items: center; 
    justify-content: center; 
    padding: 6px 12px; 
    border: none; 
    border-radius: 6px; 
    font-size: 13px; 
    font-weight: 600;
    cursor: pointer; 
    transition: all 0.3s ease; 
    text-decoration: none;
    white-space: nowrap;
    gap: 4px;
  }
  
  /* Bot√≥n CONTINUAR - Verde destacado */
  .action-btn.btn-continue { 
    background: linear-gradient(135deg, #7cb342 0%, #558b2f 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(124, 179, 66, 0.3);
    min-width: 110px;
  }
  .action-btn.btn-continue:hover { 
    background: linear-gradient(135deg, #9ccc65 0%, #7cb342 100%);
    box-shadow: 0 4px 12px rgba(124, 179, 66, 0.4);
    transform: translateY(-2px);
  }
  .action-btn.btn-continue:active { transform: translateY(0); }
  
  /* Bot√≥n EDITAR - Naranja/Amber */
  .action-btn.btn-edit { 
    background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(255, 167, 38, 0.3);
  }
  .action-btn.btn-edit:hover { 
    background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%);
    box-shadow: 0 4px 12px rgba(255, 167, 38, 0.4);
    transform: translateY(-2px);
  }
  
  /* Bot√≥n DICTAMEN - Azul */
  .action-btn.btn-dictamen { 
    background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
    color: white;
    box-shadow: 0 2px 8px rgba(66, 165, 245, 0.3);
    min-width: 110px;
  }
  .action-btn.btn-dictamen:hover { 
    background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
    box-shadow: 0 4px 12px rgba(66, 165, 245, 0.4);
    transform: translateY(-2px);
  }
  
  /* Botones INFO - Gris */
  .action-btn.btn-info { 
    background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%);
    color: white;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    padding: 6px 10px;
    min-width: 45px;
  }
  .action-btn.btn-info:hover { 
    background: linear-gradient(135deg, #b0bec5 0%, #90a4ae 100%);
    box-shadow: 0 3px 9px rgba(0, 0, 0, 0.2);
    transform: translateY(-1px);
  }
  
  /* Bot√≥n ELIMINAR - Rojo */
  .action-btn.btn-delete { 
    background: linear-gradient(135deg, #ef5350 0%, #e53935 100%);
    color: white;
    box-shadow: 0 2px 6px rgba(239, 83, 80, 0.3);
    padding: 6px 10px;
    min-width: 45px;
  }
  .action-btn.btn-delete:hover { 
    background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
    box-shadow: 0 4px 10px rgba(239, 83, 80, 0.4);
    transform: translateY(-2px);
  }
  
  /* Tooltips mejorados */
  .action-btn[data-title] { position: relative; }
  .action-btn[data-title]::after { 
    content: attr(data-title); 
    position: absolute; 
    background: rgba(0, 0, 0, 0.85); 
    color: white; 
    padding: 6px 10px; 
    border-radius: 4px; 
    font-size: 11px; 
    white-space: nowrap; 
    bottom: 100%; 
    left: 50%; 
    transform: translateX(-50%); 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.3s; 
    margin-bottom: 8px; 
    font-weight: 500; 
    z-index: 1000;
  }
  .action-btn:hover[data-title]::after { opacity: 1; }
  .action-btn[data-title]::before { 
    content: ''; 
    position: absolute; 
    background: rgba(0, 0, 0, 0.85); 
    width: 6px; 
    height: 6px; 
    bottom: 100%; 
    left: 50%; 
    transform: translateX(-50%) rotate(45deg); 
    opacity: 0; 
    pointer-events: none; 
    transition: opacity 0.3s; 
    margin-bottom: -2px; 
    z-index: 1000;
  }
  .action-btn:hover[data-title]::before { opacity: 1; }
  
  /* Responsive para pantallas peque√±as */
  @media (max-width: 768px) {
    .btn-group-actions { gap: 4px; }
    .action-btn { 
      padding: 5px 10px; 
      font-size: 12px;
      min-width: auto;
    }
    .action-btn.btn-continue,
    .action-btn.btn-dictamen { 
      min-width: 90px;
    }
  }
  
  /* Estado de bot√≥n desactivado */
  .action-btn:disabled { 
    opacity: 0.5; 
    cursor: not-allowed;
    transform: none !important;
  }
  .action-btn:disabled:hover { 
    transform: none !important;
    box-shadow: none;
  }
</style>
{% endblock %}

{% block content %}
<div class="wizard-container">
  <!-- Header -->
  <div class="wizard-header">
    <h1>üå≥ Gesti√≥n Arb√≥rea - Sistema de Radicaci√≥n</h1>
    <p style="margin: 8px 0 0 0; opacity: 0.95;">Radicaci√≥n ‚Üí Visita T√©cnica ‚Üí Dictamen CMGR ‚Üí Compensaci√≥n</p>
  </div>

  <!-- Steps indicator -->
  <div class="wizard-steps">
    <div class="wizard-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Radicaci√≥n</div>
    </div>
    <div class="wizard-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Visita T√©cnica</div>
    </div>
    <div class="wizard-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Dictamen CMGR</div>
    </div>
  </div>

  <!-- Wizard body -->
  <div class="wizard-body">
    <div id="alerts-container"></div>

    <!-- ============ FASE 1: RADICACI√ìN ============ -->
    <div class="form-section active" id="section-1">
      <h3>üìù FASE 1: Radicaci√≥n de Solicitud</h3>
      <p class="text-muted">Registra los datos iniciales del solicitante y el √°rbol</p>

      <form id="form-radicacion">
        <div class="row g-3">
          <!-- SOLICITANTE -->
          <div class="col-md-6">
            <label class="form-label">Nombre del solicitante *</label>
            <input type="text" class="form-control" id="solicitante_nombre" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Documento de identidad *</label>
            <input type="text" class="form-control" id="solicitante_documento" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tel√©fono de contacto *</label>
            <input type="tel" class="form-control" id="solicitante_contacto" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Correo electr√≥nico</label>
            <input type="email" class="form-control" id="solicitante_correo">
          </div>

          <!-- UBICACI√ìN Y SOLICITUD -->
          <div class="col-12">
            <label class="form-label">Ubicaci√≥n (direcci√≥n/vereda) *</label>
            <input type="text" class="form-control" id="ubicacion_direccion" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tipo de solicitud *</label>
            <select class="form-select" id="tipo_solicitud" required>
              <option value="Poda">Poda</option>
              <option value="Tala">Tala</option>
              <option value="Trasplante">Trasplante</option>
              <option value="Emergencia">Emergencia</option>
            </select>
          </div>

          <!-- √ÅRBOL -->
          <div class="col-md-6">
            <label class="form-label">Especie del √°rbol *</label>
            <div class="input-group">
              <select class="form-select" id="arbol_especie_select">
                <option value="">Cargando especies...</option>
              </select>
              <button type="button" class="btn btn-outline-secondary btn-small" id="toggle_especie_manual">Especie no listada</button>
            </div>
            <input type="text" class="form-control" id="arbol_especie_manual" placeholder="Ingrese especie manualmente" style="display:none; margin-top:8px;" required>
            <small class="text-muted">Puedes seleccionar de la lista o escribir manualmente.</small>
          </div>
          <div class="col-md-4">
            <label class="form-label">DAP (cm) *</label>
            <input type="number" class="form-control" id="arbol_dap_cm" step="0.1" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Altura (m)</label>
            <input type="number" class="form-control" id="arbol_altura_m" step="0.1">
          </div>
          <div class="col-md-4">
            <label class="form-label">Di√°metro copa (m)</label>
            <input type="number" class="form-control" id="arbol_copa_m" step="0.1">
          </div>

          <!-- MOTIVO -->
          <div class="col-12">
            <label class="form-label">Motivo de la solicitud *</label>
            <textarea class="form-control" id="motivo_solicitud" rows="2" required></textarea>
          </div>
        </div>

        <div style="margin-top: 28px; text-align: right;">
          <button type="submit" class="btn-primary-custom" id="btn-guardar-radicado">
            üíæ Guardar y Radicar
          </button>
        </div>
      </form>

      <!-- Confirmaci√≥n Fase 1 -->
      <div id="radicado-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-success">
          <strong>‚úÖ ¬°Radicado creado exitosamente!</strong>
          <div class="radicado-badge" id="numero-radicado"></div>
          <p style="margin: 10px 0 0 0;"><strong>Pr√≥ximo paso:</strong> El t√©cnico diligenciar√° el informe de visita t√©cnica.</p>
        </div>
        <button class="btn-primary-custom" onclick="showSection(2)">Siguiente: Visita T√©cnica ‚Üí</button>
      </div>
    </div>

    <!-- ============ FASE 2: VISITA T√âCNICA + INFORME PDF ============ -->
    <div class="form-section" id="section-2">
      <h3>üîç FASE 2: Visita T√©cnica e Informe</h3>
      <p class="text-muted">El t√©cnico registra hallazgos, toma fotos y genera PDF para aprobaci√≥n del CMGR</p>

      <!-- Resumen de datos Fase 1 -->
      <div class="data-summary">
        <strong>Radicado:</strong> <span id="radicado-numero-2" class="radicado-badge"></span><br>
        <strong>Solicitante:</strong> <span id="solicitante-resumen"></span><br>
        <strong>√Årbol:</strong> <span id="arbol-resumen"></span> (DAP: <span id="dap-resumen"></span> cm)
      </div>

      <form id="form-visita">
        <input type="hidden" id="radicado_id_visita">

        <!-- DATOS DE VISITA -->
        <div class="form-group-section">
          <h4>üìã Datos de la Visita</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Fecha de visita *</label>
              <input type="date" class="form-control" id="visita_fecha" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">T√©cnico responsable *</label>
              <input type="text" class="form-control" id="visita_tecnico" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Estado fitosanitario</label>
              <select class="form-select" id="arbol_fitosanitario">
                <option>Buen estado</option>
                <option>Estado regular</option>
                <option>Mal estado</option>
                <option>Seco/muerto</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nivel de riesgo *</label>
              <select class="form-select" id="visita_riesgo_final" required>
                <option value="Bajo">Bajo</option>
                <option value="Medio">Medio</option>
                <option value="Alto">Alto</option>
                <option value="Muy Alto">Muy Alto</option>
              </select>
            </div>
          </div>
        </div>

        <!-- INFORME T√âCNICO -->
        <div class="form-group-section">
          <h4>üìÑ Informe T√©cnico</h4>
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Descripci√≥n t√©cnica y observaciones *</label>
              <textarea class="form-control" id="visita_observaciones" rows="5" required placeholder="Describe: condici√≥n general, anomal√≠as, recomendaciones..."></textarea>
              <small class="text-muted">M√≠nimo 50 caracteres. Este texto se incluir√° en el PDF.</small>
            </div>
            <div class="col-12">
              <label class="form-label">Diagn√≥stico y recomendaciones *</label>
              <textarea class="form-control" id="diagnostico_recomendaciones" rows="3" required placeholder="¬øQu√© se recomienda? ¬øSe recomienda aprobaci√≥n?"></textarea>
            </div>
          </div>
        </div>

        <!-- FOTOGRAF√çAS -->
        <div class="form-group-section">
          <h4>üì∏ Fotograf√≠as de la Inspecci√≥n</h4>
          <div class="file-upload" id="file-upload-area">
            <p>üì∑ Arrastra fotos aqu√≠ o haz clic para seleccionar</p>
            <input type="file" id="file-input" multiple accept="image/*" style="display:none;">
            <small class="text-muted">M√°ximo 5 MB por foto. Formatos: JPG, PNG</small>
          </div>
          <div class="uploaded-files" id="uploaded-files"></div>
          <input type="hidden" id="archivos_visita">
        </div>

        <div style="margin-top: 28px; text-align: right;">
          <button type="button" class="btn-secondary-custom" onclick="showSection(1)">‚Üê Anterior</button>
          <button type="submit" class="btn-primary-custom" id="btn-guardar-visita">
            üíæ Guardar Visita e Informe
          </button>
        </div>
      </form>

      <!-- Confirmaci√≥n Fase 2 -->
      <div id="visita-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-info">
          <strong>‚úÖ Informe registrado - Pendiente aprobaci√≥n del CMGR</strong>
          <p style="margin: 10px 0 0 0;">
            El informe est√° listo para ser revisado. El CMGR realizar√° el dictamen en la siguiente fase.
          </p>
        </div>
        <div style="margin: 16px 0;">
          <button class="btn-secondary-custom" onclick="descargarPDF()">
            üì• Descargar Informe PDF
          </button>
          <button class="btn-primary-custom" onclick="showSection(3)">Siguiente: Dictamen CMGR ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- ============ FASE 3: DICTAMEN Y COMPENSACI√ìN ============ -->
    <div class="form-section" id="section-3">
      <h3>‚úÖ FASE 3: Dictamen del CMGR y Compensaci√≥n</h3>
      <p class="text-muted">Basado en el informe t√©cnico, se emite dictamen y se calcula la compensaci√≥n</p>

      <!-- Resumen de datos -->
      <div class="data-summary">
        <strong>Radicado:</strong> <span id="radicado-numero-3" class="radicado-badge"></span><br>
        <strong>Solicitante:</strong> <span id="solicitante-resumen-3"></span><br>
        <strong>√Årbol:</strong> <span id="arbol-resumen-3"></span><br>
        <strong>Estado actual:</strong> <span id="estado-resumen-3" class="estado-badge estado-pendiente">PENDIENTE APROBACI√ìN</span>
      </div>

      <form id="form-permiso">
        <input type="hidden" id="radicado_id_permiso">

        <!-- DICTAMEN CMGR -->
        <div class="form-group-section">
          <h4>üìã Dictamen del CMGR</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Decisi√≥n *</label>
              <select class="form-select" id="dictamen_decision" required onchange="toggleCompensacion(); mostrarDiagnostico()">
                <option value="">Seleccionar decisi√≥n...</option>
                <option value="Aprobado">‚úÖ APROBADO</option>
                <option value="Negado">‚ùå NEGADO</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Integrantes del CMGR *</label>
              <input type="text" class="form-control" id="permiso_firmante1" placeholder="Nombre y cargo" required>
            </div>
            <div class="col-12">
              <label class="form-label">Justificaci√≥n del dictamen *</label>
              <textarea class="form-control" id="permiso_obligaciones" rows="3" required placeholder="Explicar la decisi√≥n del CMGR..."></textarea>
            </div>
          </div>
        </div>

        <!-- COMPENSACI√ìN (solo si aprobado) -->
        <div id="compensacion-section" style="display: none;">
          <div class="form-group-section">
            <h4>üå± Compensaci√≥n Ambiental</h4>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Vigencia del permiso (d√≠as)</label>
                <input type="number" class="form-control" id="permiso_vigencia_dias" value="15" min="1" max="15">
                <small class="text-muted">M√°ximo 15 d√≠as</small>
              </div>
              <div class="col-md-6">
                <label class="form-label">Coeficiente de compensaci√≥n</label>
                <input type="number" class="form-control" id="compensacion_coeficiente" value="1.5" step="0.1">
              </div>
              <div class="col-12">
                <button type="button" class="btn-secondary-custom" onclick="calcularCompensacion()">üßÆ Calcular Compensaci√≥n</button>
              </div>
              <div class="col-12">
                <div id="resultado-compensacion" class="compensacion-result" style="display: none;">
                  <div style="font-size: 14px; color: #666; margin-bottom: 8px;">√Årboles a compensar:</div>
                  <div class="compensacion-numero" id="compensacion-arboles-display">0</div>
                  <small id="calculo-detalles" class="text-muted"></small>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label">Especie recomendada para compensaci√≥n</label>
                <input type="text" class="form-control" id="compensacion_especie_recomendada">
              </div>
              <div class="col-12">
                <label class="form-label">Sitio y plazo de plantaci√≥n</label>
                <textarea class="form-control" id="compensacion_sitio" rows="2" placeholder="Lugar espec√≠fico y fechas"></textarea>
              </div>
            </div>
          </div>
        </div>

        <div style="margin-top: 28px; text-align: right;">
          <button type="button" class="btn-secondary-custom" onclick="showSection(2)">‚Üê Anterior</button>
          <button type="submit" class="btn-primary-custom" id="btn-emitir-permiso">
            ‚úÖ Emitir Dictamen
          </button>
        </div>
      </form>

      <!-- Confirmaci√≥n Fase 3 -->
      <div id="permiso-confirmacion" style="display: none; margin-top: 24px;">
        <div class="alert alert-success">
          <strong>‚úÖ ¬°Dictamen emitido exitosamente!</strong>
          <p style="margin: 10px 0 0 0;">El expediente est√° completo y procesado.</p>
        </div>
        <div style="margin: 16px 0;">
          <button class="btn-secondary-custom" onclick="descargarDictamenPDF()">üì• Descargar Permiso/Dictamen PDF</button>
        </div>
        <button class="btn-primary-custom" onclick="location.reload()">üîÑ Nuevo Radicado</button>
        <button class="btn-secondary-custom" onclick="verHistorial()">üìã Ver Historial</button>
      </div>
    </div>

    <!-- HISTORIAL -->
    <div class="historial-container">
      <h4>üìã Radicados Recientes</h4>
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Radicado</th>
              <th>Solicitante</th>
              <th>Especie</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="historial-tbody">
            <tr>
              <td colspan="5" class="text-center text-muted">Cargando...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
let radicadoActual = null;
let fotosActuales = [];

// === NAVEGACI√ìN WIZARD ===
function showSection(step) {
  document.querySelectorAll('.form-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  
  document.getElementById(`section-${step}`).classList.add('active');
  document.querySelector(`[data-step="${step}"]`).classList.add('active');
  
  document.querySelector('.wizard-body').scrollIntoView({ behavior: 'smooth' });
}

// === ALERTAS ===
function showAlert(message, type = 'success') {
  const container = document.getElementById('alerts-container');
  const alert = document.createElement('div');
  alert.className = `alert alert-${type}`;
  alert.innerHTML = message;
  container.innerHTML = '';
  container.appendChild(alert);
  
  setTimeout(() => alert.remove(), 6000);
}

// === ESPECIE: Selecci√≥n o entrada manual ===
document.getElementById('toggle_especie_manual').addEventListener('click', () => {
  const manual = document.getElementById('arbol_especie_manual');
  const select = document.getElementById('arbol_especie_select');
  const btn = document.getElementById('toggle_especie_manual');
  const willShow = manual.style.display === 'none' || manual.style.display === '';
  
  if (willShow) {
    // Activar modo manual
    manual.style.display = 'block';
    manual.focus();
    select.value = '';
    btn.textContent = 'üìã Usar lista de especies';
    btn.className = 'btn btn-outline-primary btn-small';
  } else {
    // Volver a modo select
    manual.style.display = 'none';
    manual.value = '';
    btn.textContent = '‚úèÔ∏è Especie no listada';
    btn.className = 'btn btn-outline-secondary btn-small';
  }
});

// === FASE 1: RADICACI√ìN ===
document.getElementById('form-radicacion').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const btn = document.getElementById('btn-guardar-radicado');
  const especieManualInput = document.getElementById('arbol_especie_manual');
  const especieSelect = document.getElementById('arbol_especie_select');
  
  const especieManual = especieManualInput.value.trim();
  const especieSeleccionada = especieSelect.value;
  const especieFinal = especieManual || especieSeleccionada;
  
  // Validar que se haya especificado una especie
  if (!especieFinal) {
    showAlert('‚ùå Debes seleccionar una especie o ingresarla manualmente', 'error');
    return;
  }
  
  btn.disabled = true;
  btn.innerHTML = 'üíæ Guardando... <span class="spinner"></span>';

  const data = {
    solicitante_nombre: document.getElementById('solicitante_nombre').value,
    solicitante_documento: document.getElementById('solicitante_documento').value,
    solicitante_contacto: document.getElementById('solicitante_contacto').value,
    solicitante_correo: document.getElementById('solicitante_correo').value,
    ubicacion_direccion: document.getElementById('ubicacion_direccion').value,
    tipo_solicitud: document.getElementById('tipo_solicitud').value,
    arbol_especie_comun: especieFinal,
    arbol_dap_cm: parseFloat(document.getElementById('arbol_dap_cm').value),
    arbol_altura_m: parseFloat(document.getElementById('arbol_altura_m').value) || null,
    arbol_copa_m: parseFloat(document.getElementById('arbol_copa_m').value) || null,
    motivo_solicitud: document.getElementById('motivo_solicitud').value,
    usuario_creador: 'admin'
  };
  
  try {
    const resp = await fetch('/api/riesgo/arborea', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      radicadoActual = result;
      document.getElementById('numero-radicado').textContent = result.numero_radicado;
      document.getElementById('radicado-confirmacion').style.display = 'block';
      document.getElementById('form-radicacion').style.display = 'none';
      document.querySelector('[data-step="1"]').classList.add('completed');
      
      showAlert(`‚úÖ Radicado <strong>${result.numero_radicado}</strong> creado exitosamente`, 'success');
      cargarHistorial();
    } else {
      showAlert(`‚ùå Error: ${result.error || 'No se pudo crear el radicado'}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üíæ Guardar y Radicar';
  }
});

// === PREPARAR FASE 2 ===
function mostrarDatos2() {
  document.getElementById('radicado-numero-2').textContent = radicadoActual.numero_radicado;
  document.getElementById('solicitante-resumen').textContent = radicadoActual.solicitante_nombre;
  document.getElementById('arbol-resumen').textContent = radicadoActual.arbol_especie_comun;
  document.getElementById('dap-resumen').textContent = radicadoActual.arbol_dap_cm;
  document.getElementById('radicado_id_visita').value = radicadoActual.id;
  document.getElementById('visita_fecha').valueAsDate = new Date();
}

// === SUBIDA DE FOTOS ===
const fileUploadArea = document.getElementById('file-upload-area');
const fileInput = document.getElementById('file-input');

fileUploadArea.addEventListener('click', () => fileInput.click());

fileUploadArea.addEventListener('dragover', (e) => {
  e.preventDefault();
  fileUploadArea.classList.add('dragover');
});

fileUploadArea.addEventListener('dragleave', () => {
  fileUploadArea.classList.remove('dragover');
});

fileUploadArea.addEventListener('drop', (e) => {
  e.preventDefault();
  fileUploadArea.classList.remove('dragover');
  const files = e.dataTransfer.files;
  manejarArchivos(files);
});

fileInput.addEventListener('change', () => {
  manejarArchivos(fileInput.files);
});

function manejarArchivos(files) {
  for (let file of files) {
    if (file.size > 5 * 1024 * 1024) {
      showAlert(`‚ùå ${file.name} es muy grande (m√°x 5 MB)`, 'error');
      continue;
    }
    fotosActuales.push(file);
  }
  mostrarFotos();
}

function mostrarFotos() {
  const container = document.getElementById('uploaded-files');
  container.innerHTML = fotosActuales.map((f, i) => `
    <div class="file-item">
      <span>üì∑ ${f.name}</span>
      <button type="button" class="btn btn-sm btn-danger-custom" onclick="eliminarFoto(${i})">Eliminar</button>
    </div>
  `).join('');
}

function eliminarFoto(i) {
  fotosActuales.splice(i, 1);
  mostrarFotos();
}

// === FASE 2: VISITA ===
document.getElementById('form-visita').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!radicadoActual) {
    showAlert('‚ùå Primero debes crear un radicado', 'error');
    return;
  }
  
  const btn = document.getElementById('btn-guardar-visita');
  btn.disabled = true;
  btn.innerHTML = 'üíæ Guardando... <span class="spinner"></span>';
  
  const data = {
    visita_fecha: document.getElementById('visita_fecha').value,
    visita_tecnico: document.getElementById('visita_tecnico').value,
    arbol_fitosanitario: document.getElementById('arbol_fitosanitario').value,
    visita_riesgo_final: document.getElementById('visita_riesgo_final').value,
    visita_observaciones: document.getElementById('visita_observaciones').value,
    diagnostico_recomendaciones: document.getElementById('diagnostico_recomendaciones').value
  };
  
  try {
    const resp = await fetch(`/api/riesgo/arborea/${radicadoActual.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      radicadoActual.estado = 'Pendiente';
      document.getElementById('visita-confirmacion').style.display = 'block';
      document.getElementById('form-visita').style.display = 'none';
      document.querySelector('[data-step="2"]').classList.add('completed');
      showAlert('‚úÖ Visita t√©cnica registrada - Pendiente aprobaci√≥n del CMGR', 'info');
    } else {
      showAlert(`‚ùå Error: ${result.error}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'üíæ Guardar Visita e Informe';
  }
});

// === PREPARAR FASE 3 ===
function prepararFase3() {
  document.getElementById('radicado-numero-3').textContent = radicadoActual.numero_radicado;
  document.getElementById('solicitante-resumen-3').textContent = radicadoActual.solicitante_nombre;
  document.getElementById('arbol-resumen-3').textContent = radicadoActual.arbol_especie_comun;
  document.getElementById('radicado_id_permiso').value = radicadoActual.id;
}

function toggleCompensacion() {
  const decision = document.getElementById('dictamen_decision').value;
  const section = document.getElementById('compensacion-section');
  section.style.display = (decision === 'Aprobado') ? 'block' : 'none';
}

function mostrarDiagnostico() {
  // Mostrar diagn√≥stico de Fase 2
  const decision = document.getElementById('dictamen_decision').value;
  if (decision) {
    console.log('Decisi√≥n:', decision);
  }
}

async function calcularCompensacion() {
  const dap = parseFloat(document.getElementById('arbol_dap_cm').value) || radicadoActual.arbol_dap_cm || 0;
  const coef = parseFloat(document.getElementById('compensacion_coeficiente').value) || 1.5;
  
  try {
    const resp = await fetch('/api/riesgo/calcular-compensacion', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ dap_cm: dap, coeficiente: coef })
    });
    
    const result = await resp.json();
    
    if (result.success) {
      document.getElementById('compensacion-arboles-display').textContent = result.arboles_plantar;
      document.getElementById('calculo-detalles').textContent = `(${dap}/10) √ó ${coef} = ${result.arboles_plantar} √°rboles`;
      document.getElementById('resultado-compensacion').style.display = 'block';
    }
  } catch (err) {
    console.error('Error:', err);
  }
}

// === FASE 3: PERMISO ===
document.getElementById('form-permiso').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  if (!radicadoActual) {
    showAlert('‚ùå Primero debes completar las fases anteriores', 'error');
    return;
  }
  
  const btn = document.getElementById('btn-emitir-permiso');
  btn.disabled = true;
  btn.innerHTML = '‚úÖ Emitiendo... <span class="spinner"></span>';
  
  const data = {
    dictamen_decision: document.getElementById('dictamen_decision').value,
    permiso_vigencia_dias: parseInt(document.getElementById('permiso_vigencia_dias').value) || 15,
    compensacion_coeficiente: parseFloat(document.getElementById('compensacion_coeficiente').value),
    compensacion_metodo: 'Autom√°tico',
    compensacion_especie_recomendada: document.getElementById('compensacion_especie_recomendada').value,
    compensacion_sitio: document.getElementById('compensacion_sitio').value,
    permiso_obligaciones: document.getElementById('permiso_obligaciones').value,
    permiso_firmante1: document.getElementById('permiso_firmante1').value
  };
  
  try {
    const resp = await fetch(`/api/riesgo/arborea/${radicadoActual.id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    
    const result = await resp.json();
    
    if (resp.ok && result.success) {
      document.getElementById('permiso-confirmacion').style.display = 'block';
      document.getElementById('form-permiso').style.display = 'none';
      document.querySelector('[data-step="3"]').classList.add('completed');
      showAlert('‚úÖ Dictamen emitido exitosamente', 'success');
      cargarHistorial();
      // Actualizar estado visual
      const decision = document.getElementById('dictamen_decision').value;
      const estadoBadge = document.getElementById('estado-resumen-3');
      if (decision === 'Aprobado') {
        estadoBadge.textContent = 'APROBADA';
        estadoBadge.className = 'estado-badge estado-aprobada';
        radicadoActual.estado = 'Aprobada';
      } else if (decision === 'Negado') {
        estadoBadge.textContent = 'NEGADA';
        estadoBadge.className = 'estado-badge estado-negada';
        radicadoActual.estado = 'Negada';
      }
    } else {
      showAlert(`‚ùå Error: ${result.error}`, 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.innerHTML = '‚úÖ Emitir Dictamen';
  }
});

// === HISTORIAL ===
async function cargarHistorial() {
  try {
    const resp = await fetch('/api/riesgo/arborea?per_page=10');
    const data = await resp.json();
    const tbody = document.getElementById('historial-tbody');
    
    if (data.radicados && data.radicados.length > 0) {
      tbody.innerHTML = data.radicados.map(r => {
        const isRadicada = r.estado === 'Radicada'; // Reci√©n creado, sin informe
        const isVisitada = r.estado === 'Visitada'; // Tiene informe, pendiente dictamen
        const hasInforme = r.estado === 'Visitada' || r.estado === 'Aprobada' || r.estado === 'Negada';
        const hasPermiso = r.estado === 'Aprobada' || r.estado === 'Negada';
        
        return `
          <tr>
            <td><strong>${r.numero_radicado}</strong></td>
            <td>${r.solicitante_nombre}</td>
            <td>${r.arbol_especie_comun}</td>
            <td><span class="badge badge-${r.estado.toLowerCase()}">${r.estado}</span></td>
            <td class="actions-cell">
              <div class="btn-group-actions">
                ${isRadicada ? `<button class="action-btn btn-continue" data-title="Continuar con Informe" onclick="continuarConRadicado(${r.id})">‚ñ∂Ô∏è Continuar</button>` : ''}
                ${isRadicada ? `<button class="action-btn btn-edit" data-title="Editar Radicado" onclick="editarRadicado(${r.id})">‚úèÔ∏è</button>` : ''}
                ${isVisitada ? `<button class="action-btn btn-dictamen" data-title="Continuar con Dictamen" onclick="continuarConDictamen(${r.id})">‚ñ∂Ô∏è Dictamen</button>` : ''}
                ${hasInforme ? `<button class="action-btn btn-info" data-title="Descargar Informe" onclick="descargarPDF(${r.id})">üìÑ</button>` : ''}
                ${hasPermiso ? `<button class="action-btn btn-info" data-title="Descargar Permiso" onclick="descargarPermisoPDF(${r.id})">üìã</button>` : ''}
                ${isRadicada ? `<button class="action-btn btn-delete" data-title="Eliminar" onclick="confirmarEliminar(${r.id}, '${r.numero_radicado}')">üóëÔ∏è</button>` : ''}
              </div>
            </td>
          </tr>
        `;
      }).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Sin registros</td></tr>';
    }
  } catch (err) {
    console.error('Error:', err);
  }
}

function descargarPDF(id) {
  window.open(`/api/riesgo/arborea/${id}/pdf/informe`, '_blank');
}

function descargarPermisoPDF(id) {
  window.open(`/api/riesgo/arborea/${id}/pdf/dictamen`, '_blank');
}

async function continuarConRadicado(id) {
  try {
    const resp = await fetch(`/api/riesgo/arborea/${id}`);
    const data = await resp.json();
    
    if (resp.ok && data.radicado) {
      radicadoActual = data.radicado;
      mostrarDatos2(); // Cargar datos en Fase 2
      showSection(2); // Ir a Fase 2
      document.querySelector('.wizard-container').scrollIntoView({ behavior: 'smooth' });
      showAlert('‚úÖ Cargado. Ahora completa el informe t√©cnico.', 'success');
    } else {
      showAlert('‚ùå Error al cargar radicado', 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  }
}

async function editarRadicado(id) {
  try {
    const resp = await fetch(`/api/riesgo/arborea/${id}`);
    const data = await resp.json();
    
    if (resp.ok && data.radicado) {
      const r = data.radicado;
      radicadoActual = r;
      
      // Cargar datos en Fase 1 para edici√≥n
      document.getElementById('solicitante_nombre').value = r.solicitante_nombre || '';
      document.getElementById('solicitante_documento').value = r.solicitante_documento || '';
      document.getElementById('solicitante_contacto').value = r.solicitante_contacto || '';
      document.getElementById('solicitante_correo').value = r.solicitante_correo || '';
      document.getElementById('ubicacion_direccion').value = r.ubicacion_direccion || '';
      document.getElementById('tipo_solicitud').value = r.tipo_solicitud || 'Poda';
      document.getElementById('arbol_especie_select').value = r.arbol_especie_comun || '';
      document.getElementById('arbol_dap_cm').value = r.arbol_dap_cm || '';
      document.getElementById('arbol_altura_m').value = r.arbol_altura_m || '';
      document.getElementById('arbol_copa_m').value = r.arbol_copa_m || '';
      document.getElementById('motivo_solicitud').value = r.motivo_solicitud || '';
      
      // Mostrar Fase 1 para edici√≥n
      document.getElementById('radicado-confirmacion').style.display = 'none';
      showSection(1);
      document.querySelector('.wizard-container').scrollIntoView({ behavior: 'smooth' });
      showAlert('‚ÜîÔ∏è En modo edici√≥n. Modifica los datos necesarios y vuelve a guardar.', 'info');
    } else {
      showAlert('‚ùå Error al cargar radicado', 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  }
}

async function continuarConDictamen(id) {
  try {
    const resp = await fetch(`/api/riesgo/arborea/${id}`);
    const data = await resp.json();
    
    if (resp.ok && data.radicado) {
      radicadoActual = data.radicado;
      prepararFase3(); // Cargar datos en Fase 3
      showSection(3); // Ir a Fase 3
      document.querySelector('.wizard-container').scrollIntoView({ behavior: 'smooth' });
      showAlert('‚úÖ Cargado. Ahora emite el dictamen del CMGR.', 'success');
    } else {
      showAlert('‚ùå Error al cargar radicado', 'error');
    }
  } catch (err) {
    showAlert(`‚ùå Error: ${err.message}`, 'error');
  }
}

async function confirmarEliminar(id, numeroRadicado) {
  if (confirm(`¬øEst√°s seguro de que deseas eliminar el radicado ${numeroRadicado}? Esta acci√≥n no se puede deshacer.`)) {
    try {
      const resp = await fetch(`/api/riesgo/arborea/${id}`, {
        method: 'DELETE',
        headers: { 'X-Usuario-Actual': 'admin', 'Content-Type': 'application/json' }
      });
      const result = await resp.json();
      
      if (resp.ok && result.success) {
        showAlert('‚úÖ Radicado eliminado exitosamente', 'success');
        cargarHistorial();
      } else {
        showAlert(`‚ùå Error: ${result.mensaje || result.error}`, 'error');
      }
    } catch (err) {
      showAlert(`‚ùå Error: ${err.message}`, 'error');
    }
  }
}

function verDetalle(id) {
  // Abrir PDF adecuado seg√∫n estado (si tiene dictamen, abrir dictamen; si no, informe)
  window.open(`/api/riesgo/arborea/${id}/pdf/informe`, '_blank');
}

function verHistorial() {
  document.querySelector('.historial-container').scrollIntoView({ behavior: 'smooth' });
}

// === INICIALIZACI√ìN ===
document.addEventListener('DOMContentLoaded', () => {
  cargarHistorial();
  cargarEspecies();
  
  // Observe section changes
  const observer = new MutationObserver((mutations) => {
    if (document.getElementById('section-2').classList.contains('active') && radicadoActual) {
      mostrarDatos2();
    }
    if (document.getElementById('section-3').classList.contains('active') && radicadoActual) {
      prepararFase3();
    }
  });
  
  observer.observe(document.getElementById('section-2'), { attributes: true, attributeFilter: ['class'] });
  observer.observe(document.getElementById('section-3'), { attributes: true, attributeFilter: ['class'] });
});

async function cargarEspecies() {
  try {
    const resp = await fetch('/api/riesgo/especies?per_page=500');
    const data = await resp.json();
    const sel = document.getElementById('arbol_especie_select');
    sel.innerHTML = '<option value="">Seleccione especie...</option>' +
      (data.especies || []).map(e => `<option value="${e.nombre_comun}">${e.nombre_comun} (${e.nombre_cientifico})</option>`).join('');
  } catch (err) {
    console.error('Error cargando especies', err);
  }
}
</script>
{% endblock %}
