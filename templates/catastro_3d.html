{# templates/catastro_3d.html - Geoportal Catastro Municipal - RediseÃ±o Institucional #}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal â€” AlcaldÃ­a Virtual SupatÃ¡</title>

    <!-- MapLibre GL con fallback local -->
    <link id="ml-css-cdn" href="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.css" rel="stylesheet">
    <script id="ml-js-cdn" src="https://unpkg.com/maplibre-gl@3.7.0/dist/maplibre-gl.js"></script>
    <script>
        function makePanelDraggable(panel, handleSelector) {
            if (!panel) return;
            const handle = panel.querySelector(handleSelector) || panel;
            let dragging = false, offsetX = 0, offsetY = 0;
            handle.style.cursor = 'move';
            handle.addEventListener('mousedown', (e) => {
                dragging = true;
                const rect = panel.getBoundingClientRect();
                offsetX = e.clientX - rect.left;
                offsetY = e.clientY - rect.top;
                panel.style.position = 'absolute';
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            });
            function onMove(e) {
                if (!dragging) return;
                const newLeft = Math.max(0, Math.min(window.innerWidth  - panel.offsetWidth,  e.clientX - offsetX));
                const newTop  = Math.max(0, Math.min(window.innerHeight - panel.offsetHeight, e.clientY - offsetY));
                panel.style.left = newLeft + 'px';
                panel.style.top  = newTop  + 'px';
            }
            function onUp() {
                dragging = false;
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
        }

        (function setupMapLibreFallback(){
            const localCssHref = "{{ url_for('static', filename='lib/maplibre/maplibre-gl.css') }}";
            const localJsSrc   = "{{ url_for('static', filename='lib/maplibre/maplibre-gl.js') }}";
            function ensureLocalAssets(){
                if(!document.getElementById('ml-css-local')){
                    const link = document.createElement('link');
                    link.id = 'ml-css-local'; link.rel = 'stylesheet'; link.href = localCssHref;
                    document.head.appendChild(link);
                }
                if(!document.getElementById('ml-js-local')){
                    const script = document.createElement('script');
                    script.id = 'ml-js-local'; script.defer = true; script.src = localJsSrc;
                    document.head.appendChild(script);
                }
            }
            const cdnJs = document.getElementById('ml-js-cdn');
            if(cdnJs) cdnJs.addEventListener('error', ensureLocalAssets);
            setTimeout(()=>{ if(!window.maplibregl) ensureLocalAssets(); }, 1200);
            window.__ensureMapLibreReady = function(){
                ensureLocalAssets();
                return new Promise((resolve, reject)=>{
                    let waited = 0; const max = 5000;
                    (function check(){
                        if(window.maplibregl) return resolve();
                        waited += 100;
                        if(waited >= max) return reject(new Error('MapLibre no cargÃ³'));
                        setTimeout(check, 100);
                    })();
                });
            };
        })();
    </script>

    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           GEOPORTAL CATASTRO â€” RediseÃ±o Institucional Azul
           Paleta: #0f4c81 Â· #1565c0 Â· #0ea5e9 Â· glass dark
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        :root {
            --geo-dark:        #060f1e;
            --geo-primary:     #0f4c81;
            --geo-mid:         #1565c0;
            --geo-light:       #0ea5e9;
            --geo-accent:      #38bdf8;
            --geo-glass:       rgba(6, 15, 30, 0.91);
            --geo-glass-mid:   rgba(10, 25, 52, 0.87);
            --geo-border:      rgba(14, 165, 233, 0.16);
            --geo-border-hi:   rgba(56, 189, 248, 0.38);
            --geo-text:        #e2e8f0;
            --geo-text-dim:    #94a3b8;
            --geo-text-label:  #5b7494;
            --shadow-panel:    0 20px 60px rgba(0,0,0,0.60), 0 0 0 1px rgba(14,165,233,0.07), inset 0 1px 0 rgba(255,255,255,0.06);
            --shadow-hover:    0 8px 24px rgba(14,165,233,0.18);
            --r-panel:   20px;
            --r-card:    12px;
            --r-btn:     9px;
            --r-input:   9px;
            --t-fast:    0.14s ease;
            --t-smooth:  0.24s cubic-bezier(0.4, 0, 0.2, 1);
            --t-spring:  0.38s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        *, *::before, *::after {
            margin: 0; padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', sans-serif;
        }

        body {
            background: linear-gradient(130deg, #060f1e 0%, #0d2040 55%, #091830 100%);
            color: var(--geo-text);
            overflow: hidden;
        }

        /* â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        /* â”€â”€ LOADING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .loading-overlay {
            position: absolute; inset: 0;
            background: linear-gradient(130deg, #060f1e 0%, #0d2040 100%);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 9999; gap: 16px;
            transition: opacity 0.5s ease;
        }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .loading-icon {
            width: 60px; height: 60px;
            background: linear-gradient(130deg, var(--geo-primary), var(--geo-light));
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px;
            box-shadow: 0 0 40px rgba(14,165,233,0.35);
            animation: pulse-glow 2s ease-in-out infinite;
        }
        @keyframes pulse-glow {
            0%,100% { box-shadow: 0 0 40px rgba(14,165,233,0.35); }
            50%      { box-shadow: 0 0 60px rgba(14,165,233,0.55); }
        }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid rgba(14,165,233,0.15);
            border-top-color: var(--geo-light);
            border-radius: 50%;
            animation: spin 0.85s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 0.95rem; color: var(--geo-text-dim); font-weight: 500; }
        .loading-sub  { font-size: 0.75rem; color: var(--geo-text-label); }

        /* â”€â”€ BACK BUTTON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .back-btn {
            position: absolute; top: 16px; left: 50%;
            transform: translateX(-50%);
            background: var(--geo-glass);
            border: 1px solid var(--geo-border);
            color: var(--geo-text-dim);
            padding: 5px 14px;
            border-radius: 20px;
            font-size: 0.75rem; font-weight: 600;
            cursor: pointer; z-index: 999;
            transition: var(--t-smooth);
            backdrop-filter: blur(20px);
            text-decoration: none;
            display: flex; align-items: center; gap: 6px;
            white-space: nowrap;
        }
        .back-btn:hover {
            color: var(--geo-text);
            border-color: var(--geo-border-hi);
            background: var(--geo-glass-mid);
            box-shadow: var(--shadow-hover);
        }

        /* â”€â”€ CONTROL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .control-panel {
            position: absolute; left: 16px; top: 16px;
            width: 308px;
            max-height: calc(100vh - 32px);
            background: var(--geo-glass);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border-radius: var(--r-panel);
            border: 1px solid var(--geo-border);
            box-shadow: var(--shadow-panel);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: width var(--t-smooth);
            z-index: 1000;
        }
        .control-panel.compact { width: 60px; }

        /* Panel header */
        .panel-header {
            padding: 16px 14px 12px;
            border-bottom: 1px solid var(--geo-border);
            background: rgba(15, 76, 129, 0.10);
            flex-shrink: 0;
            cursor: move;
        }
        .panel-header-top {
            display: flex; align-items: center;
            justify-content: space-between; gap: 8px;
            margin-bottom: 10px;
        }
        .panel-logo {
            width: 34px; height: 34px; flex-shrink: 0;
            background: linear-gradient(130deg, var(--geo-primary), var(--geo-light));
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 17px;
            box-shadow: 0 4px 12px rgba(14,165,233,0.22);
        }
        .panel-title-group { flex: 1; min-width: 0; }
        .panel-title-group h2 {
            font-size: 0.88rem; font-weight: 800;
            color: var(--geo-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            letter-spacing: -0.2px;
        }
        .panel-title-group p {
            font-size: 0.67rem; color: var(--geo-text-label);
            font-weight: 500; margin-top: 1px;
        }
        .panel-actions { display: flex; gap: 4px; flex-shrink: 0; }
        .icon-btn {
            width: 28px; height: 28px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--geo-border);
            border-radius: 7px; color: var(--geo-text-dim);
            font-size: 13px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--t-smooth);
        }
        .icon-btn:hover {
            background: rgba(14,165,233,0.12);
            border-color: var(--geo-border-hi);
            color: var(--geo-accent);
        }

        /* Status pill */
        .status-pill {
            background: rgba(14,165,233,0.09);
            border: 1px solid rgba(14,165,233,0.18);
            border-radius: 16px; padding: 4px 10px;
            font-size: 0.66rem; font-weight: 600;
            color: var(--geo-accent);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* Compact hides content */
        .compact .panel-title-group,
        .compact .panel-body,
        .compact .status-pill { display: none; }
        .compact .panel-header { padding: 10px 8px; }
        .compact .panel-header-top { justify-content: center; margin-bottom: 0; }
        .compact .panel-actions { display: none; }

        /* Panel body */
        .panel-body {
            flex: 1; overflow-y: auto; overflow-x: hidden;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(14,165,233,0.25) transparent;
        }
        .panel-body::-webkit-scrollbar { width: 4px; }
        .panel-body::-webkit-scrollbar-thumb {
            background: rgba(14,165,233,0.22); border-radius: 4px;
        }

        /* â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .search-box { position: relative; margin-bottom: 8px; }
        .search-box input {
            width: 100%; padding: 8px 34px 8px 11px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--geo-border);
            border-radius: var(--r-input);
            color: var(--geo-text); font-size: 0.82rem; font-weight: 500;
            transition: var(--t-smooth);
        }
        .search-box input::placeholder { color: var(--geo-text-label); }
        .search-box input:focus {
            outline: none; border-color: var(--geo-light);
            background: rgba(14,165,233,0.06);
            box-shadow: 0 0 0 3px rgba(14,165,233,0.10);
        }
        .search-icon {
            position: absolute; right: 10px; top: 50%;
            transform: translateY(-50%);
            color: var(--geo-text-label); font-size: 14px; pointer-events: none;
        }

        /* â”€â”€ ACCORDION SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .control-section {
            margin-bottom: 5px;
            border: 1px solid var(--geo-border);
            border-radius: var(--r-card);
            overflow: hidden;
        }
        .section-header {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 8px 11px;
            background: rgba(15,76,129,0.10);
            cursor: pointer; user-select: none;
            transition: var(--t-smooth);
        }
        .section-header:hover { background: rgba(14,165,233,0.10); }
        .section-title {
            display: flex; align-items: center; gap: 6px;
            font-size: 0.69rem; font-weight: 800;
            color: var(--geo-text);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .section-icon { font-size: 13px; }
        .section-arrow {
            font-size: 10px; color: var(--geo-text-dim);
            transition: transform var(--t-smooth); flex-shrink: 0;
        }
        .control-section.collapsed .section-arrow { transform: rotate(-90deg); }
        .section-body {
            padding: 9px;
            background: rgba(0,0,0,0.18);
        }
        .control-section.collapsed .section-body { display: none; }

        /* â”€â”€ SEGMENTED 2D/3D â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .segmented {
            display: flex;
            background: rgba(0,0,0,0.30);
            border: 1px solid var(--geo-border);
            border-radius: var(--r-btn);
            padding: 3px; gap: 3px;
        }
        .toggle-btn {
            flex: 1; padding: 7px 8px;
            background: transparent; border: none;
            border-radius: 7px;
            color: var(--geo-text-dim);
            font-size: 0.80rem; font-weight: 700;
            cursor: pointer; transition: var(--t-smooth);
            text-align: center; letter-spacing: 0.3px;
        }
        .toggle-btn.active {
            background: linear-gradient(130deg, var(--geo-primary), var(--geo-mid));
            color: #fff;
            box-shadow: 0 4px 12px rgba(15,76,129,0.40);
        }
        .toggle-btn:hover:not(.active) {
            background: rgba(14,165,233,0.10);
            color: var(--geo-accent);
        }

        /* â”€â”€ LAYER TOGGLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .layer-toggle {
            display: flex; align-items: center; gap: 9px;
            padding: 8px 9px;
            background: rgba(255,255,255,0.025);
            border: 1px solid transparent;
            border-radius: var(--r-btn);
            margin-bottom: 4px; cursor: pointer;
            transition: var(--t-smooth);
        }
        .layer-toggle:last-child { margin-bottom: 0; }
        .layer-toggle:hover {
            background: rgba(14,165,233,0.08);
            border-color: rgba(14,165,233,0.14);
        }
        .layer-toggle input[type="checkbox"] {
            width: 15px; height: 15px;
            accent-color: var(--geo-light);
            cursor: pointer; flex-shrink: 0;
        }
        .layer-info { flex: 1; min-width: 0; }
        .layer-info h4 {
            font-size: 0.80rem; font-weight: 600;
            color: var(--geo-text);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .layer-info p {
            font-size: 0.66rem; color: var(--geo-text-label); margin: 0;
        }

        /* â”€â”€ FORM CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .form-group { margin-bottom: 7px; }
        .form-group:last-child { margin-bottom: 0; }
        .form-label {
            display: block; font-size: 0.66rem; font-weight: 700;
            color: var(--geo-text-label);
            text-transform: uppercase; letter-spacing: 0.4px;
            margin-bottom: 4px;
        }
        select, input[type="number"] {
            width: 100%; padding: 7px 10px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--geo-border);
            border-radius: var(--r-input);
            color: var(--geo-text); font-size: 0.81rem; font-weight: 500;
            transition: var(--t-smooth); cursor: pointer;
        }
        select option { background: #0d1f3c; color: var(--geo-text); }
        select:focus, input[type="number"]:focus {
            outline: none; border-color: var(--geo-light);
            background: rgba(14,165,233,0.06);
            box-shadow: 0 0 0 3px rgba(14,165,233,0.10);
        }
        input[type="range"] {
            width: 100%; background: transparent; border: none;
            accent-color: var(--geo-light); cursor: pointer; padding: 0;
        }
        .range-label {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 5px;
        }
        .range-value { font-size: 0.78rem; font-weight: 700; color: var(--geo-accent); }

        /* Active filter chips */
        .active-filters-row {
            display: none; align-items: center; gap: 5px;
            flex-wrap: wrap; margin-bottom: 7px;
            padding: 6px 8px;
            background: rgba(14,165,233,0.06);
            border: 1px solid rgba(14,165,233,0.14);
            border-radius: var(--r-btn);
        }
        .active-filters-label {
            font-size: 0.62rem; font-weight: 700;
            color: var(--geo-text-dim);
            text-transform: uppercase; letter-spacing: 0.4px; flex-shrink: 0;
        }
        #activeChips { display: flex; flex-wrap: wrap; gap: 4px; flex: 1; }
        .filter-chip {
            background: rgba(14,165,233,0.14);
            border: 1px solid rgba(14,165,233,0.28);
            color: var(--geo-accent);
            padding: 2px 7px; border-radius: 10px;
            font-size: 0.66rem; font-weight: 600;
            cursor: pointer; transition: var(--t-smooth);
        }
        .filter-chip:hover {
            background: rgba(239,68,68,0.18);
            border-color: rgba(239,68,68,0.38);
            color: #f87171;
        }

        /* Reset button */
        .btn-reset {
            width: 100%; padding: 6px 10px;
            background: rgba(239,68,68,0.07);
            border: 1px solid rgba(239,68,68,0.18);
            border-radius: var(--r-btn); color: #f87171;
            font-size: 0.76rem; font-weight: 600;
            cursor: pointer; transition: var(--t-smooth); margin-top: 7px;
        }
        .btn-reset:hover {
            background: rgba(239,68,68,0.14);
            border-color: rgba(239,68,68,0.38);
        }

        /* â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .action-btn {
            width: 100%; padding: 8px 12px;
            background: linear-gradient(130deg, var(--geo-primary), var(--geo-mid));
            border: none; border-radius: var(--r-btn);
            color: #fff; font-weight: 700; font-size: 0.80rem;
            cursor: pointer; transition: var(--t-smooth);
            margin-top: 5px;
            box-shadow: 0 4px 12px rgba(15,76,129,0.28);
            letter-spacing: 0.2px;
        }
        .action-btn:first-child { margin-top: 0; }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(15,76,129,0.40);
            background: linear-gradient(130deg, var(--geo-mid), var(--geo-light));
        }
        .action-btn:active { transform: translateY(0); }
        .action-btn.btn-excel {
            background: linear-gradient(130deg, #065f46, #059669);
            box-shadow: 0 4px 12px rgba(5,150,105,0.28);
        }
        .action-btn.btn-excel:hover { box-shadow: 0 8px 20px rgba(5,150,105,0.40); }

        /* â”€â”€ STATS / KPI PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-panel {
            position: absolute; bottom: 16px; right: 16px;
            background: var(--geo-glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: var(--r-panel);
            border: 1px solid var(--geo-border);
            box-shadow: var(--shadow-panel);
            min-width: 260px; max-width: 300px;
            z-index: 1000; overflow: hidden;
            resize: both;
        }
        .stats-header {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 12px 16px 10px;
            border-bottom: 1px solid var(--geo-border);
            background: rgba(15,76,129,0.10);
            cursor: move;
        }
        .stats-header h3 {
            font-size: 0.72rem; font-weight: 800;
            color: var(--geo-text);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .stats-live-badge {
            background: rgba(34,197,94,0.13);
            border: 1px solid rgba(34,197,94,0.28);
            color: #4ade80;
            font-size: 0.60rem; font-weight: 700;
            padding: 2px 8px; border-radius: 10px;
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .kpi-grid {
            display: grid; grid-template-columns: 1fr 1fr;
            gap: 1px; background: var(--geo-border);
        }
        .kpi-card {
            padding: 13px 14px;
            background: var(--geo-glass); text-align: left;
            transition: var(--t-smooth);
        }
        .kpi-card:hover { background: rgba(14,165,233,0.06); }
        .kpi-icon { font-size: 17px; margin-bottom: 5px; display: block; }
        .kpi-value {
            font-size: 1.05rem; font-weight: 800;
            color: var(--geo-accent);
            line-height: 1.2; letter-spacing: -0.4px;
        }
        .kpi-label {
            font-size: 0.62rem; font-weight: 600;
            color: var(--geo-text-label);
            text-transform: uppercase; letter-spacing: 0.4px; margin-top: 2px;
        }

        /* â”€â”€ PREDIO INFO PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .predio-info {
            position: absolute; bottom: 16px; left: 340px;
            width: 370px;
            background: var(--geo-glass);
            backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: var(--r-panel);
            border: 1px solid var(--geo-border);
            box-shadow: var(--shadow-panel);
            display: none; z-index: 1000;
            animation: slideUp 0.38s cubic-bezier(0.34,1.56,0.64,1);
            resize: both; overflow: auto;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(14px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .predio-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px 11px;
            border-bottom: 1px solid var(--geo-border);
            background: rgba(15,76,129,0.10);
            cursor: move;
        }
        .predio-header h3 {
            font-size: 0.90rem; font-weight: 800; color: var(--geo-text);
        }
        .close-btn {
            width: 28px; height: 28px;
            background: rgba(239,68,68,0.09);
            border: 1px solid rgba(239,68,68,0.22);
            color: #f87171; border-radius: 8px;
            cursor: pointer; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            transition: var(--t-smooth);
        }
        .close-btn:hover {
            background: rgba(239,68,68,0.20);
            border-color: rgba(239,68,68,0.50);
        }
        .predio-grid {
            display: grid; grid-template-columns: repeat(2, 1fr);
            gap: 8px; padding: 14px 16px 16px;
        }
        .predio-field {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--geo-border);
            padding: 9px 12px; border-radius: var(--r-btn);
        }
        .predio-field.full { grid-column: 1 / -1; }
        .predio-field label {
            font-size: 0.62rem; font-weight: 700;
            color: var(--geo-text-label);
            text-transform: uppercase; letter-spacing: 0.4px;
            display: block; margin-bottom: 4px;
        }
        .predio-field .value {
            font-size: 0.85rem; font-weight: 600; color: var(--geo-text);
        }

        /* â”€â”€ LEGEND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .legend {
            position: absolute; top: 16px; right: 16px;
            width: 210px;
            background: var(--geo-glass);
            backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
            border-radius: var(--r-panel);
            border: 1px solid var(--geo-border);
            box-shadow: var(--shadow-panel);
            z-index: 1000; overflow: hidden;
            transition: var(--t-smooth);
        }
        .legend-header {
            display: flex; align-items: center;
            justify-content: space-between;
            padding: 11px 13px;
            border-bottom: 1px solid var(--geo-border);
            background: rgba(15,76,129,0.10);
            cursor: move;
        }
        .legend-header h4 {
            font-size: 0.72rem; font-weight: 800;
            color: var(--geo-text);
            text-transform: uppercase; letter-spacing: 0.5px;
        }
        .legend-toggle-btn {
            width: 22px; height: 22px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--geo-border);
            border-radius: 6px; color: var(--geo-text-dim);
            font-size: 11px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--t-smooth);
        }
        .legend-toggle-btn:hover {
            background: rgba(14,165,233,0.10); color: var(--geo-accent);
        }
        .legend-body {
            max-height: 400px; overflow-y: auto;
            padding: 8px;
            scrollbar-width: thin;
            scrollbar-color: rgba(14,165,233,0.22) transparent;
        }
        .legend-body::-webkit-scrollbar { width: 4px; }
        .legend-body::-webkit-scrollbar-thumb {
            background: rgba(14,165,233,0.22); border-radius: 4px;
        }
        .legend.legend-collapsed .legend-body { display: none; }
        .legend-search { margin-bottom: 6px; }
        .legend-search input {
            width: 100%; padding: 5px 9px;
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--geo-border);
            border-radius: 7px; color: var(--geo-text); font-size: 0.74rem;
        }
        .legend-search input::placeholder { color: var(--geo-text-label); }
        .legend-search input:focus {
            outline: none; border-color: var(--geo-light);
        }
        .legend-item {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 3px; padding: 5px 7px;
            border-radius: 7px; border: 1px solid transparent;
            cursor: pointer; transition: var(--t-smooth);
        }
        .legend-item:last-child { margin-bottom: 0; }
        .legend-item:hover {
            background: rgba(14,165,233,0.08);
            border-color: rgba(14,165,233,0.14);
        }
        .legend-item.selected {
            background: rgba(14,165,233,0.14);
            border-color: rgba(14,165,233,0.32);
        }
        .legend-color {
            width: 18px; height: 18px; border-radius: 5px;
            border: 1.5px solid rgba(255,255,255,0.18);
            flex-shrink: 0; transition: var(--t-smooth);
        }
        .legend-item:hover .legend-color { transform: scale(1.1); }
        .legend-label {
            font-size: 0.73rem; color: var(--geo-text);
            font-weight: 500; flex: 1; line-height: 1.3;
        }

        /* â”€â”€ RESPONSIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media (max-width: 768px) {
            .control-panel {
                width: calc(100vw - 32px);
                max-height: 48vh;
                top: auto; bottom: 16px; left: 16px;
            }
            .predio-info {
                left: 16px; right: 16px; width: auto; bottom: 220px;
            }
            .stats-panel {
                bottom: 16px; left: 16px; right: auto;
                max-width: calc(100vw - 32px); min-width: 0;
            }
            .legend { top: auto; bottom: 200px; right: 16px; width: 180px; }
            .back-btn { display: none; }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-icon">ğŸ—ºï¸</div>
        <div class="spinner"></div>
        <div class="loading-text">Cargando Geoportal...</div>
        <div class="loading-sub">Catastro Municipal Â· SupatÃ¡, Cundinamarca</div>
    </div>

    <!-- Map Container -->
    <div id="map"></div>

    <!-- Back to system -->
    <a class="back-btn" href="javascript:history.back()">â† Volver al sistema</a>

    <!-- â•â•â•â• CONTROL PANEL â•â•â•â• -->
    <div class="control-panel">
        <div class="panel-header">
            <div class="panel-header-top">
                <div class="panel-logo">ğŸ›ï¸</div>
                <div class="panel-title-group">
                    <h2>Catastro Municipal</h2>
                    <p>SupatÃ¡, Cundinamarca</p>
                </div>
                <div class="panel-actions">
                    <button class="icon-btn" id="compactToggle" title="Modo compacto">âŠŸ</button>
                </div>
            </div>
            <div class="status-pill" id="statusPill">Cargando datosâ€¦</div>
        </div>

        <div class="panel-body">

            <!-- Buscador -->
            <div class="search-box">
                <input type="text" id="searchInput"
                       placeholder="Buscar cÃ³digo predial, propietario, direcciÃ³nâ€¦">
                <span class="search-icon">âŒ•</span>
            </div>

            <!-- VISTA -->
            <div class="control-section" id="sectionVista">
                <div class="section-header section-toggle" data-target="sectionVista">
                    <div class="section-title">
                        <span class="section-icon">ğŸ“</span> Vista
                    </div>
                    <span class="section-arrow">â–¾</span>
                </div>
                <div class="section-body">
                    <div class="segmented">
                        <button class="toggle-btn active" data-view="2d">2D Plano</button>
                        <button class="toggle-btn" data-view="3d">3D Terreno</button>
                    </div>
                </div>
            </div>

            <!-- CAPAS -->
            <div class="control-section" id="sectionCapas">
                <div class="section-header section-toggle" data-target="sectionCapas">
                    <div class="section-title">
                        <span class="section-icon">ğŸ—ºï¸</span> Capas
                    </div>
                    <span class="section-arrow">â–¾</span>
                </div>
                <div class="section-body">
                    <div class="layer-toggle" id="togglePredios">
                        <input type="checkbox" checked id="checkPredios">
                        <div class="layer-info">
                            <h4>Predios Catastrales</h4>
                            <p id="prediosCount">Cargando prediosâ€¦</p>
                        </div>
                    </div>
                    <div class="layer-toggle" id="toggleUsos">
                        <input type="checkbox" checked id="checkUsos">
                        <div class="layer-info">
                            <h4>Usos del Suelo</h4>
                            <p>Normatividad y zonificaciÃ³n</p>
                        </div>
                    </div>
                    <div class="layer-toggle" id="toggleSatellite">
                        <input type="checkbox" checked id="checkSatellite">
                        <div class="layer-info">
                            <h4>Imagen Satelital</h4>
                            <p>Google Satellite Hybrid</p>
                        </div>
                    </div>
                    <div class="layer-toggle" id="toggleRelieve">
                        <input type="checkbox" checked id="checkRelieve">
                        <div class="layer-info">
                            <h4>Relieve 3D</h4>
                            <p>Terreno con exageraciÃ³n</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FILTROS -->
            <div class="control-section" id="sectionFiltros">
                <div class="section-header section-toggle" data-target="sectionFiltros">
                    <div class="section-title">
                        <span class="section-icon">ğŸ”</span> Filtros
                    </div>
                    <span class="section-arrow">â–¾</span>
                </div>
                <div class="section-body">
                    <!-- Chips de filtros activos -->
                    <div class="active-filters-row" id="activeFiltersRow">
                        <span class="active-filters-label">Activos:</span>
                        <div id="activeChips"></div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">CategorÃ­a de Uso</label>
                        <select id="filterCategoria">
                            <option value="">Todas las categorÃ­as</option>
                            <!-- CategorÃ­as cargadas dinÃ¡micamente desde el GeoJSON -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Rango de Ãrea (ha)</label>
                        <select id="filterRango">
                            <option value="">Todos los rangos</option>
                            <option value="<1">Menor a 1 ha</option>
                            <option value="1 - 3 ha">1 â€“ 3 ha</option>
                            <option value="3 - 6 ha">3 â€“ 6 ha</option>
                            <option value="6 - 10 ha">6 â€“ 10 ha</option>
                            <option value=">10 ha">Mayor a 10 ha</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DestinaciÃ³n EconÃ³mica</label>
                        <select id="filterDestEco">
                            <option value="">Todas</option>
                            <option value="D">Desocupado</option>
                            <option value="A">Agropecuario</option>
                            <option value="S">Sin especificar</option>
                        </select>
                    </div>
                    <button class="btn-reset" id="resetFilters">â†º Restablecer filtros</button>
                </div>
            </div>

            <!-- CONTROL 3D (oculto hasta activar modo 3D) -->
            <div class="control-section" id="controls3D" style="display:none;">
                <div class="section-header section-toggle" data-target="controls3D">
                    <div class="section-title">
                        <span class="section-icon">ğŸ”ï¸</span> Control 3D
                    </div>
                    <span class="section-arrow">â–¾</span>
                </div>
                <div class="section-body">
                    <div class="range-label">
                        <label class="form-label" style="margin:0;">ExageraciÃ³n del terreno</label>
                        <span class="range-value" id="exagValue">1.5Ã—</span>
                    </div>
                    <input type="range" id="exagRange" min="0" max="3" step="0.1" value="1.5">
                </div>
            </div>

            <!-- EXPORTAR -->
            <div class="control-section" id="sectionExportar">
                <div class="section-header section-toggle" data-target="sectionExportar">
                    <div class="section-title">
                        <span class="section-icon">ğŸ“¥</span> Exportar
                    </div>
                    <span class="section-arrow">â–¾</span>
                </div>
                <div class="section-body">
                    <button class="action-btn" onclick="exportarPDF()">ğŸ“„ Generar Reporte PDF</button>
                    <button class="action-btn btn-excel" onclick="exportarExcel()">ğŸ“Š Exportar a Excel</button>
                </div>
            </div>

        </div><!-- /panel-body -->
    </div><!-- /control-panel -->

    <!-- â•â•â•â• KPI PANEL â•â•â•â• -->
    <div class="stats-panel" id="statsPanel">
        <div class="stats-header">
            <h3>ğŸ“Š EstadÃ­sticas</h3>
            <span class="stats-live-badge">â— En vivo</span>
        </div>
        <div class="kpi-grid">
            <div class="kpi-card">
                <span class="kpi-icon">ğŸ˜ï¸</span>
                <div class="kpi-value" id="statTotal">5,337</div>
                <div class="kpi-label">Total Predios</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-icon">ğŸ“</span>
                <div class="kpi-value" id="statArea">0 ha</div>
                <div class="kpi-label">Ãrea Total</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-icon">ğŸ’°</span>
                <div class="kpi-value" id="statAvaluo">$0</div>
                <div class="kpi-label">AvalÃºo Catastral</div>
            </div>
            <div class="kpi-card">
                <span class="kpi-icon">ğŸ”</span>
                <div class="kpi-value" id="statFiltered">5,337</div>
                <div class="kpi-label">Predios Filtrados</div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â• PREDIO INFO PANEL â•â•â•â• -->
    <div class="predio-info" id="predioInfo">
        <div class="predio-header">
            <h3>InformaciÃ³n del Predio</h3>
            <button class="close-btn" onclick="closePredioInfo()">Ã—</button>
        </div>
        <div class="predio-grid" id="predioGrid">
            <!-- Dynamic content injected by showPredioInfo() -->
        </div>
    </div>

    <!-- â•â•â•â• LEGEND â•â•â•â• -->
    <div class="legend">
        <div class="legend-header">
            <h4>Usos del Suelo</h4>
            <button class="legend-toggle-btn" id="legendToggle" title="Colapsar leyenda">â–¾</button>
        </div>
        <div class="legend-body">
            <div class="legend-search">
                <input type="text" id="legendSearch" placeholder="Filtrar categorÃ­asâ€¦">
            </div>
            <div id="legendContent">
                <div class="legend-item">
                    <div class="legend-color" style="background:#10b981;"></div>
                    <span class="legend-label">Agropecuario tradicional</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#3b82f6;"></div>
                    <span class="legend-label">ProtecciÃ³n ambiental</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background:#f59e0b;"></div>
                    <span class="legend-label">Desarrollo restringido</span>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LÃ“GICA ORIGINAL â€” NO MODIFICADA
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        let map;
        let prediosData = [];
        let currentView = '2d';
        let currentFilters = { categoria: '', rango: '', destEco: '', search: '' };
        let categoriaField = 'Categoria';

        const SUPATA_CENTER = [-74.244, 5.043];

        async function initMap() {
            map = new maplibregl.Map({
                container: 'map',
                preserveDrawingBuffer: true,
                style: {
                    version: 8,
                    sources: {
                        'osm': {
                            type: 'raster',
                            tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png'],
                            tileSize: 256,
                            attribution: 'Â© OpenStreetMap'
                        },
                        'terrain': {
                            type: 'raster-dem',
                            url: 'https://demotiles.maplibre.org/terrain-tiles/tiles.json',
                            tileSize: 256
                        }
                    },
                    layers: [
                        { id: 'background', type: 'background', paint: { 'background-color': '#0a0e27' } },
                        { id: 'osm', type: 'raster', source: 'osm', paint: { 'raster-opacity': 0.7 } }
                    ],
                    terrain: { source: 'terrain', exaggeration: 0 }
                },
                center: SUPATA_CENTER,
                zoom: 13, pitch: 0, bearing: 0,
                maxZoom: 20, minZoom: 10
            });

            map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
            map.addControl(new maplibregl.ScaleControl(), 'bottom-left');
            map.addControl(new maplibregl.FullscreenControl(), 'bottom-right');

            map.on('load', async () => {
                try {
                    map.addSource('satellite', {
                        type: 'raster',
                        tiles: ['https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}'],
                        tileSize: 256
                    });
                    map.addLayer({
                        id: 'satellite-layer', type: 'raster', source: 'satellite',
                        paint: { 'raster-opacity': 0.8 }
                    });
                    await loadPrediosData();
                    setupEventListeners();
                } catch (err) {
                    console.error('Error inicializando el mapa:', err);
                    alert('Error cargando el Catastro. Ver consola.');
                } finally {
                    hideLoading();
                }
            });

            map.on('error', (e) => { console.error('MapLibre error:', e?.error || e); hideLoading(); });
            setTimeout(hideLoading, 8000);

            try {
                makePanelDraggable(document.querySelector('.control-panel'), '.panel-header');
                makePanelDraggable(document.getElementById('predioInfo'), '.predio-header');
                makePanelDraggable(document.querySelector('.legend'), '.legend-header');
                makePanelDraggable(document.getElementById('statsPanel'), '.stats-header');
            } catch (err) { console.warn('Drag habilitation failed:', err); }
        }

        async function loadPrediosData() {
            try {
                console.log('Cargando predios desde /usos_suelo/geojson...');
                const response = await fetch('/usos_suelo/geojson');
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                const data = await response.json();
                if (!data || !data.features || !Array.isArray(data.features))
                    throw new Error('El GeoJSON no tiene estructura vÃ¡lida');

                prediosData = data.features;
                console.log(`âœ“ Cargados ${prediosData.length} predios`);

                if (prediosData.length === 0) {
                    hideLoading();
                    alert('No se encontraron predios en el GeoJSON.');
                    return;
                }

                const categorias = [...new Set(prediosData.map(f => {
                    const props = f.properties;
                    return props?.Subcategor || props?.Uso || props?.Categoria || 'Sin categorÃ­a';
                }).filter(Boolean))].sort();

                const colores = [
                    '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16',
                    '#6366f1', '#a855f7', '#eab308', '#22c55e', '#0ea5e9',
                    '#f43f5e', '#8b5cf6', '#d946ef', '#06b6d4', '#84cc16'
                ];

                let matchExpr;
                if (categorias.length === 0) {
                    matchExpr = '#94a3b8';
                } else {
                    matchExpr = ['match', ['coalesce', ['get', 'Subcategor'], ['get', 'Uso'], ['get', 'Categoria'], 'Sin categorÃ­a']];
                    categorias.forEach((cat, i) => { matchExpr.push(cat); matchExpr.push(colores[i % colores.length]); });
                    matchExpr.push('#94a3b8');
                }

                const legendContent = document.getElementById('legendContent');
                legendContent.innerHTML = categorias.map((cat, i) => `
                    <div class="legend-item" data-category="${cat}">
                        <div class="legend-color" style="background:${colores[i % colores.length]};"></div>
                        <span class="legend-label">${cat}</span>
                    </div>
                `).join('');

                document.querySelectorAll('.legend-item').forEach((item, idx) => {
                    item.addEventListener('click', () => {
                        document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('selected'));
                        item.classList.add('selected');
                        const selectedCategory = item.getAttribute('data-category');
                        document.getElementById('filterCategoria').value = selectedCategory;
                        currentFilters.categoria = selectedCategory;
                        syncLayerFilters();
                        updateStats();
                    });
                    item.addEventListener('mouseenter', () => {
                        const color = colores[idx % colores.length];
                        if (!item.classList.contains('selected'))
                            item.style.boxShadow = `0 0 20px ${color}55`;
                    });
                    item.addEventListener('mouseleave', () => {
                        if (!item.classList.contains('selected')) item.style.boxShadow = 'none';
                    });
                });

                const filterCategoria = document.getElementById('filterCategoria');
                categorias.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat; opt.textContent = cat;
                    filterCategoria.appendChild(opt);
                });

                map.addSource('predios', { type: 'geojson', data: data });
                map.addLayer({
                    id: 'predios-fill', type: 'fill', source: 'predios',
                    paint: { 'fill-color': matchExpr, 'fill-opacity': 0.6 }
                });
                map.addLayer({
                    id: 'predios-outline', type: 'line', source: 'predios',
                    paint: { 'line-color': '#ffffff', 'line-width': 1.5, 'line-opacity': 0.9 }
                });
                map.addLayer({
                    id: 'predios-highlight', type: 'line', source: 'predios',
                    paint: { 'line-color': '#fbbf24', 'line-width': 3 },
                    filter: ['==', 'OBJECTID', '']
                });

                document.getElementById('statTotal').textContent = prediosData.length.toLocaleString('es-CO');
                document.getElementById('prediosCount').textContent = prediosData.length.toLocaleString('es-CO') + ' predios';
                map.setLayoutProperty('predios-fill', 'visibility', 'visible');
                map.setLayoutProperty('predios-outline', 'visibility', 'visible');

                if (prediosData.length > 0) {
                    const bounds = turf.bbox(data);
                    map.fitBounds([[bounds[0], bounds[1]], [bounds[2], bounds[3]]], { padding: 50, maxZoom: 15 });
                }
                updateStats();
            } catch (error) {
                console.error('Error loading predios:', error);
                hideLoading();
                alert('No se pudo cargar el GeoJSON de predios. Error: ' + error.message);
            }
        }

        function setupEventListeners() {
            map.on('click', 'predios-fill', (e) => {
                if (e.features.length > 0) {
                    const feature = e.features[0];
                    showPredioInfo(feature.properties);
                    highlightPredio(feature.properties.OBJECTID);
                }
            });
            map.on('mouseenter', 'predios-fill', () => { map.getCanvas().style.cursor = 'pointer'; });
            map.on('mouseleave', 'predios-fill', () => { map.getCanvas().style.cursor = ''; });

            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.addEventListener('click', () => switchView(btn.dataset.view));
            });

            document.getElementById('checkPredios').addEventListener('change', (e) => {
                const v = e.target.checked ? 'visible' : 'none';
                map.setLayoutProperty('predios-fill', 'visibility', v);
                map.setLayoutProperty('predios-outline', 'visibility', v);
            });

            document.getElementById('checkRelieve').addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (map.getSource('terrain')) map.setTerrain({ source: 'terrain', exaggeration: 1.5 });
                    else console.warn('Source terrain no disponible aÃºn');
                } else { map.setTerrain(null); }
            });

            document.getElementById('checkSatellite').addEventListener('change', (e) => {
                if (e.target.checked) {
                    if (!map.getSource('satellite')) {
                        map.addSource('satellite', {
                            type: 'raster',
                            tiles: ['https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}'],
                            tileSize: 256
                        });
                        map.addLayer({ id: 'satellite-layer', type: 'raster', source: 'satellite',
                            paint: { 'raster-opacity': 0.8 } }, 'predios-fill');
                    } else {
                        map.setLayoutProperty('satellite-layer', 'visibility', 'visible');
                    }
                } else {
                    if (map.getLayer('satellite-layer'))
                        map.setLayoutProperty('satellite-layer', 'visibility', 'none');
                }
            });

            document.getElementById('filterCategoria').addEventListener('change', applyFilters);
            document.getElementById('filterRango').addEventListener('change', applyFilters);
            document.getElementById('filterDestEco').addEventListener('change', applyFilters);
            document.getElementById('searchInput').addEventListener('input', performSearch);

            document.getElementById('exagRange').addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                document.getElementById('exagValue').textContent = val.toFixed(1) + 'Ã—';
                if (map.getTerrain()) map.setTerrain({ source: 'terrain', exaggeration: val });
            });

            setTimeout(() => {
                if (map.getSource('terrain') && document.getElementById('checkRelieve').checked) {
                    map.setTerrain({ source: 'terrain', exaggeration: 1.5 });
                }
            }, 2000);
        }

        function switchView(view) {
            currentView = view;
            document.querySelectorAll('[data-view]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
            if (view === '3d') {
                map.easeTo({ pitch: 60, bearing: -20, duration: 1000 });
                document.getElementById('controls3D').style.display = 'block';
                document.getElementById('checkRelieve').checked = true;
                map.setTerrain({ source: 'terrain', exaggeration: 1.5 });
            } else {
                map.easeTo({ pitch: 0, bearing: 0, duration: 1000 });
                document.getElementById('controls3D').style.display = 'none';
                document.getElementById('checkRelieve').checked = false;
                map.setTerrain(null);
            }
        }

        function applyFilters() {
            currentFilters.categoria = document.getElementById('filterCategoria').value;
            currentFilters.rango     = document.getElementById('filterRango').value;
            currentFilters.destEco   = document.getElementById('filterDestEco').value;
            syncLayerFilters();
        }

        function performSearch() {
            currentFilters.search = document.getElementById('searchInput').value.trim().toLowerCase();
            syncLayerFilters();
        }

        function buildFilterExpression() {
            const filters = ['all'];
            if (currentFilters.categoria)
                filters.push(['==', ['coalesce', ['get', 'Subcategor'], ['get', 'Uso'], ['get', 'Categoria'], 'Sin categorÃ­a'], currentFilters.categoria]);
            if (currentFilters.rango)
                filters.push(['==', ['get', 'RANGO'], currentFilters.rango]);
            if (currentFilters.destEco)
                filters.push(['==', ['get', 'DEST_ECO'], currentFilters.destEco]);
            if (currentFilters.search) {
                const q = currentFilters.search;
                filters.push(['any',
                    ['>=', ['index-of', q, ['downcase', ['get', 'COD_PRED']]], 0],
                    ['>=', ['index-of', q, ['downcase', ['get', 'NOMBRE']]], 0],
                    ['>=', ['index-of', q, ['downcase', ['get', 'DIRECCIÃ“N']]], 0]
                ]);
            }
            return filters.length === 1 ? null : filters;
        }

        function featureMatches(feature) {
            const p = feature.properties || {};
            if (currentFilters.categoria) {
                const catValue = p.Subcategor || p.Uso || p.Categoria || 'Sin categorÃ­a';
                if (catValue !== currentFilters.categoria) return false;
            }
            if (currentFilters.rango && p.RANGO !== currentFilters.rango) return false;
            if (currentFilters.destEco && p.DEST_ECO !== currentFilters.destEco) return false;
            if (currentFilters.search) {
                const q = currentFilters.search;
                const hay = (
                    (p.COD_PRED || '').toString().toLowerCase().includes(q) ||
                    (p.NOMBRE   || '').toString().toLowerCase().includes(q) ||
                    (p['DIRECCIÃ“N'] || '').toString().toLowerCase().includes(q)
                );
                if (!hay) return false;
            }
            return true;
        }

        function syncLayerFilters() {
            const expr = buildFilterExpression();
            map.setFilter('predios-fill', expr);
            map.setFilter('predios-outline', expr);
            updateStats();
        }

        function showPredioInfo(props) {
            const panel = document.getElementById('predioInfo');
            const grid  = document.getElementById('predioGrid');
            grid.innerHTML = `
                <div class="predio-field full">
                    <label>CÃ³digo Predial</label>
                    <div class="value">${props.COD_PRED || 'N/A'}</div>
                </div>
                <div class="predio-field full">
                    <label>Propietario</label>
                    <div class="value">${props.NOMBRE || 'N/A'}</div>
                </div>
                <div class="predio-field">
                    <label>DirecciÃ³n</label>
                    <div class="value">${props.DIRECCIÃ“N || 'N/A'}</div>
                </div>
                <div class="predio-field">
                    <label>Ãrea</label>
                    <div class="value">${props.AREA_HA ? props.AREA_HA.toFixed(2) + ' ha' : 'N/A'}</div>
                </div>
                <div class="predio-field">
                    <label>AvalÃºo</label>
                    <div class="value">$${props.EVALÃšO ? props.EVALÃšO.toLocaleString('es-CO') : 'N/A'}</div>
                </div>
                <div class="predio-field">
                    <label>Dest. EconÃ³mica</label>
                    <div class="value">${props.DEST_ECO || 'N/A'}</div>
                </div>
                <div class="predio-field full">
                    <label>CategorÃ­a de Uso</label>
                    <div class="value">${props.Categoria || 'N/A'}</div>
                </div>
                <div class="predio-field full">
                    <label>Uso EspecÃ­fico</label>
                    <div class="value">${props.Uso || 'N/A'}</div>
                </div>
                <button class="action-btn" onclick="generarPDFCompleto('${props.COD_PRED}')">
                    ğŸ§© Generar PDF (Uso + Croquis)
                </button>
            `;
            panel.style.display = 'block';
        }

        function highlightPredio(objectId) {
            map.setFilter('predios-highlight', ['==', 'OBJECTID', objectId]);
        }

        function closePredioInfo() {
            document.getElementById('predioInfo').style.display = 'none';
            map.setFilter('predios-highlight', ['==', 'OBJECTID', '']);
        }

        function updateStats() {
            if (!prediosData || prediosData.length === 0) return;
            const filtered   = prediosData.filter(featureMatches);
            const totalArea  = filtered.reduce((s, f) => s + (Number(f.properties.AREA_HA)     || 0), 0);
            const totalAval  = filtered.reduce((s, f) => s + (Number(f.properties['EVALÃšO'])   || 0), 0);
            document.getElementById('statFiltered').textContent = filtered.length.toLocaleString('es-CO');
            document.getElementById('statArea').textContent     = totalArea.toFixed(2) + ' ha';
            document.getElementById('statAvaluo').textContent   = '$' + totalAval.toLocaleString('es-CO');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function exportarPDF() {
            alert('Generando reporte PDF del catastro...');
        }

        function exportarExcel() {
            window.location.href = '/usos_suelo/exportar_excel';
        }

        function generarCertificado(codPred) {
            if (!codPred) return;
            window.open(`/usos_suelo/certificado/${encodeURIComponent(codPred)}`, '_blank');
        }

        async function generarPDFCroquis(codPred) {
            if (!codPred) { alert('Selecciona un predio primero'); return; }
            try {
                const btn = event.target;
                const btnText = btn.textContent;
                btn.textContent = 'â³ Generando PDF...'; btn.disabled = true;
                const canvas = map.getCanvas();
                const imageData = canvas.toDataURL('image/png');
                const predioData = prediosData.find(f => f.properties.COD_PRED === codPred);
                if (!predioData) throw new Error('Predio no encontrado');
                const response = await fetch('/usos_suelo/generar_pdf_croquis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cod_pred: codPred, map_screenshot: imageData,
                        predio_props: predioData.properties,
                        map_center: map.getCenter(), map_zoom: map.getZoom()
                    })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `Croquis_${codPred}.pdf`;
                    document.body.appendChild(a); a.click();
                    document.body.removeChild(a); window.URL.revokeObjectURL(url);
                    btn.textContent = 'âœ“ PDF generado';
                    setTimeout(() => { btn.textContent = btnText; btn.disabled = false; }, 2000);
                } else { throw new Error(`Error HTTP ${response.status}`); }
            } catch (err) {
                console.error('Error generando PDF del croquis:', err);
                alert('No se pudo generar el PDF: ' + err.message);
                const btn = event.target;
                btn.textContent = 'ğŸ—ºï¸ Generar PDF con Croquis'; btn.disabled = false;
            }
        }

        async function generarPDFCompleto(codPred) {
            if (!codPred) { alert('Selecciona un predio primero'); return; }
            try {
                const btn = event.target;
                const prev = btn.textContent;
                btn.textContent = 'â³ Generando PDF...'; btn.disabled = true;
                const canvas = map.getCanvas();
                const imageData = canvas.toDataURL('image/png');
                const predioData = prediosData.find(f => f.properties.COD_PRED === codPred);
                if (!predioData) throw new Error('Predio no encontrado');
                const usoSel = (currentFilters && currentFilters.categoria)
                    ? currentFilters.categoria
                    : (predioData.properties.Uso || predioData.properties.Subcategor || predioData.properties.Categoria);
                const response = await fetch('/usos_suelo/generar_certificado_completo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cod_pred: codPred, uso: usoSel,
                        map_screenshot: imageData, predio_props: predioData.properties
                    })
                });
                if (!response.ok) throw new Error('Error HTTP ' + response.status);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `Certificado_${codPred}.pdf`;
                document.body.appendChild(a); a.click();
                document.body.removeChild(a); window.URL.revokeObjectURL(url);
                btn.textContent = 'âœ“ PDF generado';
                setTimeout(() => { btn.textContent = prev; btn.disabled = false; }, 1800);
            } catch (err) {
                console.error('Error generando certificado completo:', err);
                alert('No se pudo generar el PDF: ' + err.message);
                const btn = event.target;
                btn.textContent = 'ğŸ§© Generar PDF (Uso + Croquis)'; btn.disabled = false;
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            const waitForLib = window.__ensureMapLibreReady ? window.__ensureMapLibreReady() : Promise.resolve();
            waitForLib.then(initMap).catch(err => {
                console.error('MapLibre no estÃ¡ disponible:', err);
                hideLoading();
                alert('No se pudo cargar el visor porque MapLibre no estÃ¡ disponible.');
            });
        });
    </script>

    <!-- â•â•â•â• UI ENHANCEMENTS â€” solo presentaciÃ³n â•â•â•â• -->
    <script>
        // Accordion sections
        document.querySelectorAll('.section-toggle').forEach(header => {
            header.addEventListener('click', () => {
                const id = header.dataset.target;
                const section = document.getElementById(id);
                if (section) section.classList.toggle('collapsed');
            });
        });

        // Compact mode toggle
        document.getElementById('compactToggle')?.addEventListener('click', (e) => {
            e.stopPropagation();
            document.querySelector('.control-panel').classList.toggle('compact');
        });

        // Legend collapse/expand
        document.getElementById('legendToggle')?.addEventListener('click', () => {
            const legend = document.querySelector('.legend');
            legend.classList.toggle('legend-collapsed');
            document.getElementById('legendToggle').textContent =
                legend.classList.contains('legend-collapsed') ? 'â–¸' : 'â–¾';
        });

        // Legend search filter
        document.getElementById('legendSearch')?.addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('#legendContent .legend-item').forEach(item => {
                const label = item.querySelector('.legend-label')?.textContent?.toLowerCase() || '';
                item.style.display = label.includes(q) ? '' : 'none';
            });
        });

        // Reset filters button
        document.getElementById('resetFilters')?.addEventListener('click', () => {
            document.getElementById('filterCategoria').value = '';
            document.getElementById('filterRango').value     = '';
            document.getElementById('filterDestEco').value   = '';
            if (typeof applyFilters === 'function') applyFilters();
            document.querySelectorAll('.legend-item').forEach(el => el.classList.remove('selected'));
            updateFilterChips();
        });

        // Active filter chips
        function updateFilterChips() {
            if (typeof currentFilters === 'undefined') return;
            const chips = [];
            if (currentFilters.categoria) chips.push({ label: currentFilters.categoria, key: 'categoria' });
            if (currentFilters.rango)     chips.push({ label: currentFilters.rango,     key: 'rango' });
            if (currentFilters.destEco)   chips.push({ label: currentFilters.destEco,   key: 'destEco' });
            const row       = document.getElementById('activeFiltersRow');
            const container = document.getElementById('activeChips');
            if (!row || !container) return;
            container.innerHTML = chips.map(c =>
                `<span class="filter-chip" onclick="removeFilterChip('${c.key}')">${c.label} Ã—</span>`
            ).join('');
            row.style.display = chips.length ? 'flex' : 'none';
            updateStatusPill();
        }

        function removeFilterChip(key) {
            if (key === 'categoria') { document.getElementById('filterCategoria').value = ''; currentFilters.categoria = ''; }
            if (key === 'rango')     { document.getElementById('filterRango').value     = ''; currentFilters.rango     = ''; }
            if (key === 'destEco')   { document.getElementById('filterDestEco').value   = ''; currentFilters.destEco   = ''; }
            if (typeof syncLayerFilters === 'function') syncLayerFilters();
            updateFilterChips();
        }

        function updateStatusPill() {
            const pill = document.getElementById('statusPill');
            if (!pill) return;
            const activeLayers = document.querySelectorAll('.layer-toggle input:checked').length;
            const filtered     = document.getElementById('statFiltered')?.textContent || 'â€”';
            pill.textContent   = `Capas activas: ${activeLayers} | Filtrados: ${filtered}`;
        }

        // Hook filter selects â†’ chips
        ['filterCategoria', 'filterRango', 'filterDestEco'].forEach(id => {
            document.getElementById(id)?.addEventListener('change', updateFilterChips);
        });

        // Hook layer checkboxes â†’ status pill
        document.querySelectorAll('.layer-toggle input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', updateStatusPill);
        });

        // Observe statFiltered changes â†’ update status pill
        const sfEl = document.getElementById('statFiltered');
        if (sfEl && window.MutationObserver) {
            new MutationObserver(updateStatusPill)
                .observe(sfEl, { childList: true, characterData: true, subtree: true });
        }
    </script>
</body>
</html>
