{% extends "base.html" %}
{% block content %}
<style>
  .stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    margin-bottom: 1rem;
  }
  .stat-card.danger {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }
  .stat-card.success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  .stat-card.warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: #333;
  }
  .stat-card h5 {
    margin-bottom: 0.5rem;
    font-weight: 600;
  }
  .stat-card .number {
    font-size: 2rem;
    font-weight: bold;
  }
  .panel-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .panel-section h4 {
    border-bottom: 3px solid #667eea;
    padding-bottom: 0.75rem;
    margin-bottom: 1.5rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  .user-row {
    background: #f8f9fa;
    border-left: 4px solid #667eea;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .user-row:hover {
    background: #f0f1ff;
    box-shadow: 0 2px 12px rgba(102, 126, 234, 0.15);
  }
  .user-info {
    flex: 1;
  }
  .user-info .user-name {
    font-weight: 600;
    font-size: 1.1rem;
    color: #333;
  }
  .user-info .user-meta {
    font-size: 0.85rem;
    color: #666;
    margin-top: 0.25rem;
  }
  .user-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .user-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    margin-right: 0.5rem;
    margin-bottom: 0.25rem;
  }
  .badge-admin {
    background: #667eea;
    color: white;
  }
  .badge-user {
    background: #e0e7ff;
    color: #667eea;
  }
  .badge-active {
    background: #d1fae5;
    color: #059669;
  }
  .badge-blocked {
    background: #fee2e2;
    color: #dc2626;
  }
  .form-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    border-left: 4px solid #667eea;
  }
  .btn-sm-custom {
    padding: 0.4rem 0.75rem;
    font-size: 0.85rem;
  }
  .navbar-breadcrumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }
</style>

<div class="container-fluid p-4">
  
  <!-- Header con Breadcrumb -->
  <div class="navbar-breadcrumb">
    <h2 class="mb-0">
      <i class="bi bi-gear-fill"></i> Panel de Administraci√≥n
    </h2>
    <small>Gesti√≥n completa del sistema</small>
  </div>

  <!-- Estad√≠sticas -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="stat-card">
        <h5><i class="bi bi-people-fill"></i> Total Usuarios</h5>
        <div class="number">{{ stats.total }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card success">
        <h5><i class="bi bi-check-circle-fill"></i> Activos</h5>
        <div class="number">{{ stats.activos }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card warning">
        <h5><i class="bi bi-dash-circle-fill"></i> Inactivos</h5>
        <div class="number">{{ stats.inactivos }}</div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="stat-card danger">
        <h5><i class="bi bi-shield-lock-fill"></i> Administradores</h5>
        <div class="number">{{ stats.admins }}</div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 1: CREAR USUARIO MANUAL -->
  <div class="panel-section">
    <h4><i class="bi bi-person-plus-fill"></i> Crear Nuevo Usuario</h4>
    
    <form method="POST" class="form-section">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label"><strong>Usuario</strong></label>
          <input type="text" name="new_usuario" class="form-control" placeholder="ej: juan.perez" required>
          <small class="text-muted">Nombre de usuario √∫nico</small>
        </div>
        
        <div class="col-md-4">
          <label class="form-label"><strong>Email</strong></label>
          <input type="email" name="new_email" class="form-control" placeholder="usuario@alcaldia.gov">
          <small class="text-muted">Para 2FA y notificaciones</small>
        </div>

        <div class="col-md-4">
          <label class="form-label"><strong>Contrase√±a</strong></label>
          <input type="password" name="new_clave" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
          <small class="text-muted">M√≠n 12 caracteres, s√≠mbolos, n√∫meros</small>
        </div>

        <div class="col-md-3">
          <label class="form-label"><strong>Secretar√≠a</strong></label>
          <input type="text" name="new_secretaria" class="form-control" placeholder="ej: Planeaci√≥n">
        </div>

        <div class="col-md-3">
          <label class="form-label"><strong>Rol</strong></label>
          <select name="new_role" class="form-select">
            <option value="user">Usuario Normal</option>
            <option value="admin">Administrador</option>
          </select>
        </div>

        <div class="col-md-6">
          <button type="submit" name="add_user" class="btn btn-primary w-100">
            <i class="bi bi-plus-circle"></i> Crear Usuario
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- SECCI√ìN 2: LISTA DE USUARIOS -->
  <div class="panel-section">
    <h4><i class="bi bi-table"></i> Usuarios Registrados</h4>
    
    {% if usuarios_dict %}
      {% for u in usuarios_dict %}
      <div class="user-row">
        <div class="user-info">
          <div class="user-name">{{ u.usuario }}</div>
          <div class="user-meta">
            <span class="user-badge" 
              {% if u.role == 'admin' %}
                class="user-badge badge-admin"
              {% else %}
                class="user-badge badge-user"
              {% endif %}>
              {{ u.role | upper }}
            </span>
            <span class="user-badge"
              {% if u.activo %}
                class="user-badge badge-active"
              {% else %}
                class="user-badge badge-blocked"
              {% endif %}>
              {{ 'Activo' if u.activo else 'Bloqueado' }}
            </span>
            {% if u.email %}
            <span class="user-badge badge-user" title="2FA por correo">
              2FA
            </span>
            {% endif %}
            {% if u.email %}
            <span style="color: #666; margin-left: 0.5rem;">
              <i class="bi bi-envelope"></i> {{ u.email }}
            </span>
            {% endif %}
            {% if u.secretaria %}
            <span style="color: #666; margin-left: 0.5rem;">
              <i class="bi bi-building"></i> {{ u.secretaria }}
            </span>
            {% endif %}
            <div class="mt-2" style="font-size: 0.8rem; color: #999;">
              Creado: {{ u.creado_en }} | √öltimo acceso: {{ u.ultimo_acceso }}
            </div>
          </div>
        </div>
        <div class="user-actions">
          <!-- Cambiar Contrase√±a -->
          <form method="POST" style="display:inline;">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <input type="hidden" name="change_password_value" id="pwd_{{ u.id }}">
            <button type="button" class="btn btn-sm btn-outline-warning btn-sm-custom" 
              onclick="promptPassword('{{ u.id }}', '{{ u.usuario }}', 'change_password')">
              <i class="bi bi-key"></i> Contrase√±a
            </button>
          </form>

          <!-- Cambiar Rol -->
          <form method="POST" style="display:inline;">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <select name="change_role_value" class="form-select form-select-sm" style="width:auto; display:inline-block;" onchange="this.form.submit()">
              <option>Cambiar rol...</option>
              <option value="user">Usuario</option>
              <option value="admin">Admin</option>
            </select>
          </form>

          <!-- Bloquear/Desbloquear -->
          <form method="POST" style="display:inline;">
            <input type="hidden" name="user_id" value="{{ u.id }}">
            <button type="submit" name="toggle_block" 
              class="btn btn-sm {% if u.bloqueado %}btn-outline-success{% else %}btn-outline-danger{% endif %} btn-sm-custom">
              <i class="bi {% if u.bloqueado %}bi-unlock{% else %}bi-lock{% endif %}"></i>
              {{ 'Desbloquear' if u.bloqueado else 'Bloquear' }}
            </button>
          </form>

          <!-- Eliminar -->
          <form method="POST" style="display:inline;" onsubmit="return confirm('¬øEliminar usuario {{ u.usuario }}?');">
            <input type="hidden" name="delete_user" value="{{ u.usuario }}">
            <button type="submit" class="btn btn-sm btn-outline-danger btn-sm-custom">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </form>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> No hay usuarios registrados
      </div>
    {% endif %}
  </div>

  <!-- SECCI√ìN 3: PERMISOS POR MODULO (POR USUARIO) -->
  <div class="panel-section">
    <h4><i class="bi bi-shield-check"></i> Permisos por Modulo (Usuarios)</h4>

    <form method="POST" class="form-section">
      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Usuario</th>
              {% for mod in module_catalog %}
              <th class="text-center">{{ mod.label }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for u in permissions_users %}
            <tr>
              <td>
                <strong>{{ u.usuario }}</strong>
                {% if u.secretaria %}
                <div class="text-muted" style="font-size: 0.8rem;">{{ u.secretaria }}</div>
                {% endif %}
              </td>
              {% for mod in module_catalog %}
              <td class="text-center">
                <input type="checkbox"
                       name="perm_{{ mod.key }}_{{ u.usuario }}"
                       {% if u.usuario in features_cfg.get(mod.key, []) %}checked{% endif %}>
              </td>
              {% endfor %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <button type="submit" name="update_permissions" class="btn btn-primary">
        <i class="bi bi-save"></i> Guardar permisos
      </button>
    </form>

    <div class="alert alert-info mt-3">
      <i class="bi bi-info-circle"></i> Desmarca un modulo para ocultarlo a un usuario.
      El usuario admin siempre tiene acceso completo.
    </div>
  </div>

  <!-- SECCI√ìN 4: BACKUPS -->
  <div class="panel-section">
    <h4><i class="bi bi-cloud-download"></i> Sistema de Backups</h4>
    
    <form method="POST" class="form-section">
      <div class="row g-3">
        <div class="col-md-12">
          <label class="form-label"><strong>Selecciona los modulos a respaldar</strong></label>
          <div class="d-flex flex-wrap gap-3">
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="backup_modules" value="solicitudes">
              <span class="form-check-label">Solicitudes (CSV)</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="backup_modules" value="licencias">
              <span class="form-check-label">Licencias (PDFs)</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="backup_modules" value="certificados">
              <span class="form-check-label">Certificados (PDFs)</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="backup_modules" value="contratos">
              <span class="form-check-label">Contratos (PDFs)</span>
            </label>
            <label class="form-check">
              <input class="form-check-input" type="checkbox" name="backup_modules" value="riesgo">
              <span class="form-check-label">Gestion del Riesgo (PDFs)</span>
            </label>
          </div>
        </div>
        <div class="col-md-4">
          <button type="submit" name="backup_modulos" class="btn btn-success w-100">
            <i class="bi bi-file-earmark-zip"></i> Crear ZIP descargable
          </button>
        </div>
      </div>
    </form>

    <div class="alert alert-warning">
      <strong><i class="bi bi-info-circle"></i> Informaci√≥n de Backups:</strong>
      <ul class="mt-2 mb-0">
        <li>El sistema genera un ZIP descargable con los modulos seleccionados</li>
        <li>Los archivos se guardan en <code>/backups/archivos</code></li>
        <li>Formato: ZIP con timestamp</li>
      </ul>
    </div>
  </div>

  <!-- SECCI√ìN 5: SEGURIDAD -->
  <div class="panel-section">
    <h4><i class="bi bi-shield-lock"></i> Configuraci√≥n de Seguridad</h4>
    
    <div class="row">
      <div class="col-md-6">
        <div class="alert alert-info">
          <strong>Requisitos de Contrase√±a:</strong>
          <ul class="mt-2 mb-0">
            <li>‚úì M√≠nimo 12 caracteres</li>
            <li>‚úì May√∫sculas y min√∫sculas</li>
            <li>‚úì N√∫meros (0-9)</li>
            <li>‚úì S√≠mbolos especiales (!@#$%)</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="alert alert-warning">
          <strong>Pol√≠ticas de Bloqueo:</strong>
          <ul class="mt-2 mb-0">
            <li>üîí 5 intentos fallidos = bloqueo</li>
            <li>‚è±Ô∏è Duraci√≥n del bloqueo: 30 minutos</li>
            <li>üìß 2FA por email (se activa si el usuario tiene correo)</li>
            <li>üåê Acceso solo desde IP permitidas (si hay whitelist activa)</li>
            <li>üìù Auditor√≠a de todos los accesos y acciones</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 6: ACTUALIZAR MI CORREO (ADMIN ACTUAL) -->
  <div class="panel-section">
    <h4><i class="bi bi-envelope-check"></i> Actualizar mi correo</h4>
    <form method="POST" class="form-section">
      <div class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label"><strong>Correo actual</strong></label>
          <input type="email" class="form-control" value="{{ my_email or '' }}" disabled>
        </div>
        <div class="col-md-6">
          <label class="form-label"><strong>Nuevo correo</strong></label>
          <input type="email" name="my_email" class="form-control" placeholder="admin@alcaldia.gov" required>
          <small class="text-muted">Solo t√∫ puedes cambiar tu correo. Se activar√° 2FA con este email.</small>
        </div>
        <div class="col-12">
          <button type="submit" name="update_my_email" class="btn btn-primary">
            <i class="bi bi-save"></i> Guardar correo y activar 2FA
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- SECCI√ìN 6.1: ENVIAR CORREO RAPIDO -->
  <div class="panel-section">
    <h4><i class="bi bi-send"></i> Enviar correo rapido</h4>
    <form method="POST" class="form-section">
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label"><strong>Para</strong></label>
          <input type="email" name="quick_email_to" class="form-control" placeholder="destino@correo.gov" required>
        </div>
        <div class="col-md-6">
          <label class="form-label"><strong>Asunto</strong></label>
          <input type="text" name="quick_email_subject" class="form-control" placeholder="Asunto del mensaje" required>
        </div>
        <div class="col-12">
          <label class="form-label"><strong>Mensaje</strong></label>
          <textarea name="quick_email_message" class="form-control" rows="4" placeholder="Escribe el mensaje" required></textarea>
        </div>
        <div class="col-12">
          <button type="submit" name="send_quick_email" class="btn btn-primary">
            <i class="bi bi-envelope"></i> Enviar correo
          </button>
        </div>
      </div>
    </form>
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i> Usa Resend API. Si no hay dominio verificado, el envio puede fallar.
    </div>
  </div>

  <!-- SECCI√ìN 7: GESTI√ìN DE CHAT -->
  <div class="panel-section">
    <h4><i class="bi bi-chat-dots"></i> Gesti√≥n de Chat Municipal</h4>
    
    <div class="row g-3 mb-4">
      <div class="col-md-12">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> <strong>Administra las conversaciones del chat municipal.</strong>
          Puedes limpiar conversaciones individuales o eliminar todo el historial.
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-6">
        <button class="btn btn-primary w-100" onclick="loadConversations()">
          <i class="bi bi-arrow-clockwise"></i> Cargar Conversaciones
        </button>
      </div>
      <div class="col-md-6">
        <button class="btn btn-danger w-100" onclick="deleteAllMessages()">
          <i class="bi bi-trash"></i> Eliminar Todos los Mensajes
        </button>
      </div>
    </div>

    <div id="conversationsContainer">
      <div class="alert alert-secondary">
        <i class="bi bi-chat-left-text"></i> Haz clic en "Cargar Conversaciones" para ver el listado.
      </div>
    </div>
  </div>

  <!-- SECCI√ìN 8: AUDITOR√çA Y ALERTAS -->
  <div class="panel-section">
    <h4><i class="bi bi-activity"></i> Auditor√≠a Reciente</h4>
    {% if auditoria %}
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Usuario</th>
            <th>Acci√≥n</th>
            <th>Detalle</th>
            <th>IP</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for log in auditoria %}
          <tr>
            <td>{{ log.timestamp.strftime('%d/%m %H:%M') }}</td>
            <td>{{ log.usuario_nombre }}</td>
            <td>{{ log.accion }}</td>
            <td>{{ log.detalles or '-' }}</td>
            <td>{{ log.ip_address or '-' }}</td>
            <td>
              <span class="badge {% if log.exitoso %}bg-success{% else %}bg-danger{% endif %}">
                {{ 'OK' if log.exitoso else 'Error' }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="alert alert-info mb-0">Sin registros recientes</div>
    {% endif %}
  </div>

</div>

<script>
function promptPassword(userId, username, action) {
  const newPassword = prompt(`Ingresa nueva contrase√±a para ${username}:`);
  if (newPassword && newPassword.trim() !== '') {
    document.getElementById('pwd_' + userId).value = newPassword;
    document.querySelector(`input[value="${userId}"]`).closest('form').submit();
  }
}

// ===== GESTI√ìN DE CHAT =====
async function loadConversations() {
  const container = document.getElementById('conversationsContainer');
  container.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Cargando conversaciones...</p></div>';
  
  try {
    const response = await fetch('/api/chat/conversations');
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Error al cargar conversaciones');
    }
    
    if (data.length === 0) {
      container.innerHTML = `
        <div class="alert alert-warning">
          <i class="bi bi-chat-left-text"></i> No hay conversaciones registradas.
        </div>
      `;
      return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover align-middle">';
    html += '<thead><tr><th>Usuario 1</th><th>Usuario 2</th><th>Mensajes</th><th>√öltimo mensaje</th><th>Acciones</th></tr></thead><tbody>';
    
    data.forEach(conv => {
      const lastMsg = new Date(conv.last_message).toLocaleString('es-CO', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
      
      html += `
        <tr>
          <td><strong>${conv.user1}</strong></td>
          <td><strong>${conv.user2}</strong></td>
          <td><span class="badge bg-primary">${conv.message_count}</span></td>
          <td><small>${lastMsg}</small></td>
          <td>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteConversation('${conv.user1}', '${conv.user2}', ${conv.message_count})">
              <i class="bi bi-trash"></i> Eliminar
            </button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
    
  } catch (error) {
    container.innerHTML = `
      <div class="alert alert-danger">
        <i class="bi bi-exclamation-triangle"></i> <strong>Error:</strong> ${error.message}
      </div>
    `;
  }
}

async function deleteConversation(user1, user2, messageCount) {
  if (!confirm(`¬øEliminar conversaci√≥n entre ${user1} y ${user2}? (${messageCount} mensajes)`)) {
    return;
  }
  
  try {
    const response = await fetch('/api/chat/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: 'conversation',
        user1: user1,
        user2: user2
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Error al eliminar conversaci√≥n');
    }
    
    alert(`‚úÖ Conversaci√≥n eliminada exitosamente (${data.deleted_count} mensajes)`);
    loadConversations(); // Recargar lista
    
  } catch (error) {
    alert(`‚ùå Error: ${error.message}`);
  }
}

async function deleteAllMessages() {
  if (!confirm('‚ö†Ô∏è ¬øELIMINAR TODO EL HISTORIAL DE CHAT?\n\nEsta acci√≥n NO se puede deshacer.')) {
    return;
  }
  
  if (!confirm('üî¥ CONFIRMACI√ìN FINAL: ¬øEst√°s completamente seguro?\n\nSe borrar√°n TODOS los mensajes del sistema.')) {
    return;
  }
  
  try {
    const response = await fetch('/api/chat/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        type: 'all'
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Error al eliminar mensajes');
    }
    
    alert(`‚úÖ Todos los mensajes han sido eliminados (${data.deleted_count} mensajes)`);
    loadConversations(); // Recargar lista (mostrar√° vac√≠o)
    
  } catch (error) {
    alert(`‚ùå Error: ${error.message}`);
  }
}
</script>

{% endblock %}
