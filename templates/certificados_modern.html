{% extends "base.html" %}

{% block title %}Gesti√≥n de Certificados - iOS 26{% endblock %}

{% block styles %}
<style>
/* ========================================
   CERTIFICADOS - DISE√ëO iOS 26 MODERNO
   ======================================== */

.certificados-container {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
  color: white;
  min-height: calc(100vh - 80px);
  padding: 2.5rem 1.5rem;
  position: relative;
  overflow-x: hidden;
}

.certificados-container::before {
  content: '';
  position: absolute;
  top: -100px;
  right: -100px;
  width: 500px;
  height: 500px;
  background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
  border-radius: 50%;
  pointer-events: none;
}

.cert-header {
  text-align: center;
  margin-bottom: 2.5rem;
  animation: slideDown 0.6s cubic-bezier(0.16, 1, 0.3, 1);
}

@keyframes slideDown {
  from { opacity: 0; transform: translateY(-20px); }
  to { opacity: 1; transform: translateY(0); }
}

.cert-header h1 {
  font-size: 2.5rem;
  font-weight: 800;
  color: white;
  margin-bottom: 0.5rem;
  letter-spacing: -1px;
  text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

.cert-header p {
  color: rgba(255, 255, 255, 0.9);
  font-size: 1.1rem;
  font-weight: 500;
}

/* KPI Cards */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-bottom: 2.5rem;
}

.kpi-card {
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(25px);
  border-radius: 24px;
  padding: 2rem 1.5rem;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
}

.kpi-card:nth-child(1) { animation-delay: 0.1s; }
.kpi-card:nth-child(2) { animation-delay: 0.2s; }
.kpi-card:nth-child(3) { animation-delay: 0.3s; }
.kpi-card:nth-child(4) { animation-delay: 0.4s; }

@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(30px); }
  to { opacity: 1; transform: translateY(0); }
}

.kpi-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
}

.kpi-icon {
  width: 56px;
  height: 56px;
  margin: 0 auto 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 16px;
  font-size: 1.5rem;
  color: white;
}

.kpi-icon.total { background: linear-gradient(135deg, #558b2f, #7cb342); }
.kpi-icon.generados { background: linear-gradient(135deg, #388e3c, #66bb6a); }
.kpi-icon.pendientes { background: linear-gradient(135deg, #f57c00, #ffa726); }
.kpi-icon.tiempo { background: linear-gradient(135deg, #0288d1, #29b6f6); }

.kpi-label {
  font-size: 0.9rem;
  color: #558b2f;
  font-weight: 600;
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.kpi-value {
  font-size: 2.5rem;
  font-weight: 800;
  color: #2d5016;
  line-height: 1;
}

/* Content Cards */
.content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 2rem;
  margin-bottom: 2.5rem;
}

.content-card {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(25px);
  border-radius: 24px;
  padding: 2rem;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
  animation-delay: 0.5s;
}

.content-card h2 {
  font-size: 1.4rem;
  font-weight: 700;
  color: #558b2f;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Filtros */
.filter-group {
  margin-bottom: 1.5rem;
}

.filter-label {
  display: block;
  font-size: 0.9rem;
  font-weight: 600;
  color: #558b2f;
  margin-bottom: 0.6rem;
  letter-spacing: 0.3px;
}

.filter-select, .filter-input {
  width: 100%;
  padding: 0.9rem 1.2rem;
  border: 2px solid #e8f5e9;
  border-radius: 14px;
  font-size: 0.95rem;
  color: #2d5016;
  background: white;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
}

.filter-select:focus, .filter-input:focus {
  outline: none;
  border-color: #7cb342;
  box-shadow: 0 0 0 4px rgba(124, 179, 66, 0.1);
}

.btn-generate {
  width: 100%;
  padding: 1rem 1.5rem;
  background: linear-gradient(135deg, #558b2f, #7cb342);
  color: white;
  border: none;
  border-radius: 14px;
  font-size: 1rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  box-shadow: 0 4px 16px rgba(85, 139, 47, 0.3);
}

.btn-generate:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(85, 139, 47, 0.4);
}

.btn-generate:active {
  transform: translateY(0);
}

/* Tabla */
.table-card {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(25px);
  border-radius: 24px;
  padding: 2rem;
  border: 1px solid rgba(255, 255, 255, 0.3);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
  animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) backwards;
  animation-delay: 0.6s;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
}

.table-header h2 {
  font-size: 1.4rem;
  font-weight: 700;
  color: #558b2f;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.badge-count {
  background: linear-gradient(135deg, #f57c00, #ffa726);
  color: white;
  padding: 0.4rem 1rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 700;
}

.table-responsive {
  background: rgba(255, 255, 255, 0.5);
  border-radius: 16px;
  padding: 1rem;
  border: 1px solid rgba(255, 255, 255, 0.3);
}

.cert-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  background: transparent;
}

.cert-table thead th {
  background: rgba(124, 179, 66, 0.15);
  color: #558b2f;
  font-weight: 700;
  padding: 1rem;
  font-size: 0.9rem;
  border-bottom: 2px solid rgba(124, 179, 66, 0.3);
  text-align: left;
}

.cert-table thead th:first-child {
  border-radius: 12px 0 0 0;
}

.cert-table thead th:last-child {
  border-radius: 0 12px 0 0;
  text-align: center;
}

.cert-table tbody td {
  padding: 1rem;
  border-bottom: 1px solid rgba(124, 179, 66, 0.1);
  color: #2d5016;
  font-size: 0.9rem;
}

.cert-table tbody tr:hover {
  background: rgba(124, 179, 66, 0.05);
}

.cert-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: #7cb342;
}

#batchGenerate:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(85, 139, 47, 0.4) !important;
}

#batchGenerate:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}

.badge-sec {
  display: inline-block;
  background: rgba(124, 179, 66, 0.15);
  color: #558b2f;
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
}

.badge-status {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: linear-gradient(135deg, #f57c00, #ffa726);
  color: white;
  padding: 0.4rem 0.8rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 600;
}

/* Chart Container */
#chartSecretarias {
  max-height: 280px;
}

/* Responsive */
@media (max-width: 992px) {
  .content-grid {
    grid-template-columns: 1fr;
  }
  
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (max-width: 576px) {
  .kpi-grid {
    grid-template-columns: 1fr;
  }
  
  .cert-header h1 {
    font-size: 2rem;
  }
  
  .table-responsive {
    overflow-x: auto;
  }
}

/* DataTables custom styling */
.dataTables_wrapper .dataTables_paginate .paginate_button {
  padding: 0.4rem 0.8rem;
  margin: 0 0.2rem;
  border-radius: 8px;
  border: none;
  background: rgba(124, 179, 66, 0.1);
  color: #558b2f !important;
  font-weight: 600;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current {
  background: linear-gradient(135deg, #558b2f, #7cb342);
  color: white !important;
}

.dataTables_wrapper .dataTables_info {
  color: #558b2f;
  font-weight: 600;
  padding: 1rem 0;
}
</style>
{% endblock %}

{% block content %}
<div class="certificados-container">
  
  <!-- Header -->
  <div class="cert-header">
    <h1><i class="bi bi-award-fill"></i> Gesti√≥n de Certificados</h1>
    <p>Administraci√≥n y generaci√≥n de certificados municipales</p>
  </div>

  <!-- KPI Cards -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon total">
        <i class="bi bi-file-earmark-text"></i>
      </div>
      <div class="kpi-label">Total Solicitudes</div>
      <div class="kpi-value">{{ total_solicitudes }}</div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-icon generados">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <div class="kpi-label">Generados</div>
      <div class="kpi-value">{{ generados }}</div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-icon pendientes">
        <i class="bi bi-hourglass-split"></i>
      </div>
      <div class="kpi-label">Pendientes</div>
      <div class="kpi-value">{{ total_solicitudes - generados }}</div>
    </div>
    
    <div class="kpi-card">
      <div class="kpi-icon tiempo">
        <i class="bi bi-speedometer2"></i>
      </div>
      <div class="kpi-label">Tiempo Medio</div>
      <div class="kpi-value">{{ tiempo_medio }}s</div>
    </div>
  </div>

  <!-- Content Grid -->
  <div class="content-grid">
    <!-- Chart -->
    <div class="content-card">
      <h2><i class="bi bi-bar-chart-fill"></i> Estad√≠sticas por Secretar√≠a</h2>
      <canvas id="chartSecretarias"></canvas>
    </div>
    
    <!-- Filtros -->
    <div class="content-card">
      <h2><i class="bi bi-sliders"></i> Filtros y Acciones</h2>
      
      <div class="filter-group">
        <label class="filter-label">Filtrar Secretar√≠a</label>
        <select id="filterSecretaria" class="filter-select">
          <option value="">Todas las Secretar√≠as</option>
          {% for sec in secretarias %}
          <option value="{{ sec }}">{{ sec }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filter-group">
        <label class="filter-label">Buscar Texto</label>
        <input 
          type="text" 
          id="searchText" 
          class="filter-input" 
          placeholder="Buscar por objeto o justificaci√≥n...">
      </div>
      
      <button id="batchGenerate" class="btn-generate">
        <i class="bi bi-lightning-charge-fill"></i>
        Generar Seleccionados
      </button>
    </div>
  </div>

  <!-- Tabla -->
  <div class="table-card">
    <div class="table-header">
      <h2><i class="bi bi-list-check"></i> Solicitudes Pendientes</h2>
      <div style="display: flex; gap: 1rem; align-items: center;">
        <span class="badge-count">{{ pendientes_list|length }} Pendientes</span>
        <button id="batchGenerate" type="button" style="background: linear-gradient(135deg, #558b2f, #7cb342); color: white; border: none; border-radius: 10px; padding: 0.6rem 1.5rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(85, 139, 47, 0.3);">
          <i class="bi bi-files"></i> Generar Seleccionados
        </button>
      </div>
    </div>
    
    <div class="table-responsive">
      <table id="tblPendientes" class="cert-table">
        <thead>
          <tr>
            <th style="width: 50px; text-align: center;">
              <input type="checkbox" id="selectAll" class="cert-checkbox">
            </th>
            <th style="width: 50px;">#</th>
            <th>Secretar√≠a</th>
            <th>Objeto</th>
            <th>Justificaci√≥n</th>
            <th>Fecha</th>
            <th style="text-align: center;">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for sol in pendientes_list %}
          <tr>
            <td style="text-align: center;">
              <input 
                type="checkbox" 
                class="cert-checkbox rowCheck" 
                data-id="{{ sol.id }}">
            </td>
            <td style="font-weight: 700; color: #7cb342;">{{ loop.index }}</td>
            <td><span class="badge-sec">{{ sol.secretaria[:25] }}...</span></td>
            <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              {{ sol.objeto }}
            </td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
              {{ sol.justificacion }}
            </td>
            <td>{{ sol.fecha }}</td>
            <td style="text-align: center;">
              <span class="badge-status">
                <i class="bi bi-clock"></i> Pendiente
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
$(document).ready(function() {
  // Inicializar DataTable
  const table = $('#tblPendientes').DataTable({
    paging: true,
    info: true,
    lengthChange: false,
    pageLength: 10,
    language: {
      url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
    },
    dom: 'rtip',
    order: [[1, 'asc']]
  });

  // Filtro por Secretar√≠a
  $('#filterSecretaria').on('change', function() {
    table.column(2).search(this.value).draw();
  });

  // B√∫squeda global
  $('#searchText').on('keyup', function() {
    table.search(this.value).draw();
  });

  // Seleccionar todo
  $('#selectAll').on('click', function() {
    $('.rowCheck').prop('checked', this.checked);
  });

  // Generar seleccionados - Nueva ruta de lote
  $('#batchGenerate').on('click', function(e) {
    e.preventDefault();
    const btn = $(this);
    const ids = $('.rowCheck:checked').map((_, el) => el.dataset.id).get();
    
    if (!ids.length) {
      alert('‚ö†Ô∏è Por favor selecciona al menos una solicitud para generar.');
      return;
    }
    
    const originalHtml = btn.html();
    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Procesando ' + ids.length + ' certificados...').prop('disabled', true);

    // Crear FormData para enviar m√∫ltiples IDs
    const formData = new FormData();
    ids.forEach(id => {
      formData.append('indices[]', id);
    });
    
    // Generar en lote
    fetch('{{ url_for("certificados.generar_lote") }}', {
      method: 'POST',
      body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            throw new Error(data.error || data.mensaje || 'Error desconocido');
        }
        
        btn.html(`<i class="bi bi-check-circle me-2"></i>‚úÖ √âxito`);
        
        // Iniciar descargas de cada PDF generado
        if (Array.isArray(data.download_urls)) {
          data.download_urls.forEach((url, i) => {
            const a = document.createElement('a');
            a.href = url;
            a.download = '';
            a.style.display = 'none';
            document.body.appendChild(a);
            setTimeout(() => {
              a.click();
              document.body.removeChild(a);
            }, i * 150);
          });
        }

        // Mostrar alerta con el resultado
        let mensaje = `‚úÖ Se generaron ${data.generados} de ${data.total} certificados correctamente.`;
        if (data.errores && data.errores.length > 0) {
          mensaje += `\n\n‚ö†Ô∏è Errores encontrados:\n- ${data.errores.join('\n- ')}`;
        }
        mensaje += `\n\nüìÇ Los PDFs se descargan como archivos individuales (carpeta Descargas del navegador).`;
        alert(mensaje);
        
        // Recargar tabla despu√©s de 2 segundos
        setTimeout(() => location.reload(), 2000);
    })
    .catch(err => {
        console.error('Error completo:', err);
        btn.html(originalHtml).prop('disabled', false);
        alert('‚ùå Error al generar certificados:\n' + err.message);
    });
  });

  // Chart.js
  const ctx = document.getElementById('chartSecretarias');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ sec_labels|tojson }},
        datasets: [{
          label: 'Certificados Generados',
          data: {{ sec_counts|tojson }},
          backgroundColor: 'rgba(124, 179, 66, 0.7)',
          borderColor: 'rgba(124, 179, 66, 1)',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { 
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.05)' },
            ticks: { color: '#558b2f', font: { weight: 600 } }
          },
          x: {
            grid: { display: false },
            ticks: { 
              color: '#558b2f', 
              font: { weight: 600, size: 10 },
              maxRotation: 45,
              minRotation: 45
            }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
