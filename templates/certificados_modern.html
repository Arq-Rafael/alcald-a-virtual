{% extends "base.html" %}

{% block title %}Certificados — Alcaldía Virtual Supatá{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css">
<style>
/* =====================================================
   CERTIFICADOS — Diseño SaaS en armonía con dashboard
   ===================================================== */

.cert-page {
  padding: 1.75rem 2rem;
  max-width: 1380px;
  margin: 0 auto;
  animation: cert-fade-in 0.4s ease both;
}

@keyframes cert-fade-in {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}

/* ---- Banner ---- */
.cert-banner {
  position: relative;
  overflow: hidden;
  border-radius: 18px;
  background: linear-gradient(130deg, #0f4c81 0%, #1565c0 55%, #0ea5e9 100%);
  padding: 1.75rem 2.25rem;
  margin-bottom: 1.75rem;
  box-shadow: 0 8px 32px rgba(15,76,129,0.22);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.5rem;
  flex-wrap: wrap;
}

.cert-banner::before {
  content: '';
  position: absolute;
  right: -80px; top: -80px;
  width: 280px; height: 280px;
  background: rgba(255,255,255,0.07);
  border-radius: 50%;
  pointer-events: none;
}

.cert-banner-left { position: relative; z-index: 1; }

.cert-banner-left h2 {
  font-size: 1.5rem !important;
  font-weight: 800 !important;
  color: #fff !important;
  margin: 0 0 0.25rem !important;
  letter-spacing: -0.3px !important;
}

.cert-banner-left p {
  font-size: 0.88rem;
  color: rgba(255,255,255,0.72);
  margin: 0;
}

.cert-banner-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.55rem 1.1rem;
  border-radius: 10px;
  font-size: 0.82rem;
  font-weight: 600;
  border: none;
  cursor: pointer;
  text-decoration: none !important;
  transition: all 0.18s ease;
  background: rgba(255,255,255,0.12);
  color: #fff;
  border: 1.5px solid rgba(255,255,255,0.3);
  position: relative; z-index: 1;
}

.cert-banner-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }

/* ---- KPI Cards con degradado ---- */
.cert-kpi-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 1rem;
  margin-bottom: 1.75rem;
}

@media (max-width: 900px) {
  .cert-kpi-grid { grid-template-columns: repeat(2, 1fr); }
}

@media (max-width: 500px) {
  .cert-kpi-grid { grid-template-columns: repeat(2, 1fr); }
}

.cert-kpi-card {
  border-radius: 16px;
  padding: 1.25rem 1.25rem 1.1rem;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 0.2rem;
  position: relative;
  overflow: hidden;
  animation: cert-fade-in 0.5s cubic-bezier(0.16,1,0.3,1) both;
  transition: transform 0.2s, box-shadow 0.2s;
}

.cert-kpi-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 28px rgba(0,0,0,0.14);
}

.cert-kpi-card::after {
  content: '';
  position: absolute;
  bottom: -16px; right: -16px;
  width: 70px; height: 70px;
  background: rgba(255,255,255,0.1);
  border-radius: 50%;
}

.cert-kpi-card:nth-child(1) { animation-delay: 0.05s; background: linear-gradient(130deg, #0c3d6b, #0f4c81); }
.cert-kpi-card:nth-child(2) { animation-delay: 0.09s; background: linear-gradient(130deg, #065f46, #059669); }
.cert-kpi-card:nth-child(3) { animation-delay: 0.13s; background: linear-gradient(130deg, #9a3412, #ea580c); }
.cert-kpi-card:nth-child(4) { animation-delay: 0.17s; background: linear-gradient(130deg, #0369a1, #0ea5e9); }

.cert-kpi-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  background: rgba(255,255,255,0.18);
  display: flex; align-items: center; justify-content: center;
  font-size: 1rem; color: #fff;
  margin-bottom: 0.4rem;
  flex-shrink: 0;
  position: relative; z-index: 1;
}

.cert-kpi-num {
  font-size: 2.1rem;
  font-weight: 900;
  color: #fff;
  line-height: 1;
  letter-spacing: -1.5px;
  position: relative; z-index: 1;
}

.cert-kpi-label {
  font-size: 0.78rem;
  font-weight: 700;
  color: rgba(255,255,255,0.92);
  margin-top: 0.1rem;
  position: relative; z-index: 1;
}

/* ---- Content grid ---- */
.cert-content-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 1.25rem;
  margin-bottom: 1.75rem;
}

@media (max-width: 992px) {
  .cert-content-grid { grid-template-columns: 1fr; }
}

/* ---- Card base ---- */
.cert-card {
  background: #fff;
  border: 1.5px solid #e2e8f0;
  border-radius: 16px;
  overflow: hidden;
}

.cert-card-header {
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #f1f5f9;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fafbfc;
}

.cert-card-header h3 {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.cert-card-header h3 i { color: #0f4c81; }
.cert-card-body { padding: 1.5rem; }

/* ---- Filtros ---- */
.cert-filter-label {
  display: block;
  font-size: 0.8rem;
  font-weight: 600;
  color: #374151;
  margin-bottom: 0.4rem;
}

.cert-filter-control {
  width: 100%;
  padding: 0.65rem 0.9rem;
  border: 1.5px solid #e2e8f0;
  border-radius: 10px;
  font-size: 0.875rem;
  color: #1e293b;
  background: #fff;
  transition: border-color 0.18s, box-shadow 0.18s;
  margin-bottom: 1rem;
}

.cert-filter-control:focus {
  outline: none;
  border-color: #0f4c81;
  box-shadow: 0 0 0 3px rgba(15,76,129,0.1);
}

/* ---- Botón generar ---- */
.btn-generate {
  width: 100%;
  padding: 0.75rem 1.5rem;
  background: linear-gradient(130deg, #0f4c81, #1565c0);
  color: #fff;
  border: none;
  border-radius: 10px;
  font-size: 0.9rem;
  font-weight: 700;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 4px 14px rgba(15,76,129,0.25);
}

.btn-generate:hover {
  background: linear-gradient(130deg, #0d3d6b, #0f4c81);
  box-shadow: 0 6px 20px rgba(15,76,129,0.35);
  transform: translateY(-1px);
}

.btn-generate:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

/* ---- Tabla ---- */
.cert-table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #f1f5f9;
  background: #fafbfc;
  flex-wrap: wrap;
  gap: 0.75rem;
}

.cert-table-header h3 {
  font-size: 0.9rem;
  font-weight: 700;
  color: #1e293b;
  margin: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.cert-table-header h3 i { color: #0f4c81; }

.cert-badge-count {
  background: #ffedd5;
  color: #ea580c;
  padding: 0.25rem 0.65rem;
  border-radius: 999px;
  font-size: 0.75rem;
  font-weight: 700;
}

.btn-batch-inline {
  display: inline-flex;
  align-items: center;
  gap: 0.35rem;
  background: linear-gradient(130deg, #0f4c81, #1565c0);
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.45rem 1rem;
  font-weight: 700;
  font-size: 0.8rem;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 3px 10px rgba(15,76,129,0.22);
}

.btn-batch-inline:hover { opacity: 0.9; transform: translateY(-1px); }

.cert-table-wrap {
  padding: 1rem 1.5rem;
  overflow-x: auto;
}

.cert-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.82rem;
}

.cert-table thead th {
  padding: 0.75rem 0.9rem;
  background: #f8fafc;
  color: #64748b;
  font-weight: 700;
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 1.5px solid #e2e8f0;
  white-space: nowrap;
}

.cert-table tbody td {
  padding: 0.75rem 0.9rem;
  border-bottom: 1px solid #f1f5f9;
  color: #374151;
  vertical-align: middle;
}

.cert-table tbody tr:hover td { background: #f8fafc; }
.cert-table tbody tr:last-child td { border-bottom: none; }

.cert-checkbox {
  width: 16px; height: 16px;
  cursor: pointer;
  accent-color: #0f4c81;
}

.badge-sec {
  display: inline-block;
  background: #e0f2fe;
  color: #0369a1;
  padding: 0.22rem 0.65rem;
  border-radius: 8px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-status {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  background: #ffedd5;
  color: #ea580c;
  padding: 0.22rem 0.65rem;
  border-radius: 999px;
  font-size: 0.74rem;
  font-weight: 700;
}

.td-index { font-weight: 700; color: #0f4c81; }
.td-center { text-align: center; }
.th-check  { width: 46px; text-align: center; }
.th-index  { width: 46px; }
.td-ellipsis-200 { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.td-ellipsis-250 { max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* ---- DataTables overrides ---- */
.dataTables_wrapper .dataTables_paginate .paginate_button {
  padding: 0.35rem 0.75rem !important;
  margin: 0 0.15rem !important;
  border-radius: 8px !important;
  border: 1.5px solid #e2e8f0 !important;
  background: #fff !important;
  color: #0f4c81 !important;
  font-weight: 600 !important;
  font-size: 0.8rem !important;
}

.dataTables_wrapper .dataTables_paginate .paginate_button.current,
.dataTables_wrapper .dataTables_paginate .paginate_button.current:hover {
  background: linear-gradient(130deg, #0f4c81, #1565c0) !important;
  color: #fff !important;
  border-color: transparent !important;
}

.dataTables_wrapper .dataTables_paginate .paginate_button:hover:not(.current) {
  background: #e0f2fe !important;
  border-color: #0ea5e9 !important;
}

.dataTables_wrapper .dataTables_info {
  font-size: 0.8rem;
  color: #64748b;
  padding: 1rem 1.5rem !important;
}

.dataTables_wrapper .dataTables_paginate {
  padding: 0.75rem 1.5rem !important;
  border-top: 1px solid #f1f5f9;
}

/* Chart container */
#chartSecretarias { max-height: 260px; }

@media (max-width: 768px) {
  .cert-page { padding: 1.25rem 1rem; }
  .cert-banner { padding: 1.25rem; }
  .cert-banner-left h2 { font-size: 1.25rem !important; }
  .cert-kpi-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
{% endblock %}

{% block content %}
<div class="cert-page">

  <!-- ===== BANNER ===== -->
  <div class="cert-banner">
    <div class="cert-banner-left">
      <h2><i class="bi bi-award-fill me-2"></i>Gestión de Certificados</h2>
      <p>Administración y generación de certificados municipales</p>
    </div>
    <a href="{{ url_for('main.dashboard') }}" class="cert-banner-btn">
      <i class="bi bi-arrow-left"></i> Dashboard
    </a>
  </div>

  <!-- ===== KPI CARDS ===== -->
  <div class="cert-kpi-grid">
    <div class="cert-kpi-card">
      <div class="cert-kpi-icon"><i class="bi bi-file-earmark-text-fill"></i></div>
      <div class="cert-kpi-num">{{ total_solicitudes }}</div>
      <div class="cert-kpi-label">Total Solicitudes</div>
    </div>
    <div class="cert-kpi-card">
      <div class="cert-kpi-icon"><i class="bi bi-check-circle-fill"></i></div>
      <div class="cert-kpi-num">{{ generados }}</div>
      <div class="cert-kpi-label">Generados</div>
    </div>
    <div class="cert-kpi-card">
      <div class="cert-kpi-icon"><i class="bi bi-hourglass-split"></i></div>
      <div class="cert-kpi-num">{{ total_solicitudes - generados }}</div>
      <div class="cert-kpi-label">Pendientes</div>
    </div>
    <div class="cert-kpi-card">
      <div class="cert-kpi-icon"><i class="bi bi-speedometer2"></i></div>
      <div class="cert-kpi-num">{{ tiempo_medio }}s</div>
      <div class="cert-kpi-label">Tiempo Medio</div>
    </div>
  </div>

  <!-- ===== CONTENIDO (gráfica + filtros) ===== -->
  <div class="cert-content-grid">

    <!-- Gráfica -->
    <div class="cert-card">
      <div class="cert-card-header">
        <h3><i class="bi bi-bar-chart-fill"></i> Estadísticas por Secretaría</h3>
      </div>
      <div class="cert-card-body">
        <canvas id="chartSecretarias"></canvas>
      </div>
    </div>

    <!-- Filtros -->
    <div class="cert-card">
      <div class="cert-card-header">
        <h3><i class="bi bi-sliders"></i> Filtros y Acciones</h3>
      </div>
      <div class="cert-card-body">

        <label class="cert-filter-label">Filtrar Secretaría</label>
        <select id="filterSecretaria" class="cert-filter-control">
          <option value="">Todas las Secretarías</option>
          {% for sec in secretarias %}
          <option value="{{ sec }}">{{ sec }}</option>
          {% endfor %}
        </select>

        <label class="cert-filter-label">Buscar Texto</label>
        <input type="text" id="searchText" class="cert-filter-control"
               placeholder="Buscar por objeto o justificación...">

        <button id="batchGenerate" class="btn-generate">
          <i class="bi bi-lightning-charge-fill"></i>
          Generar Seleccionados
        </button>

      </div>
    </div>

  </div>

  <!-- ===== TABLA ===== -->
  <div class="cert-card">
    <div class="cert-table-header">
      <h3><i class="bi bi-list-check"></i> Solicitudes Pendientes</h3>
      <div class="d-flex align-items-center gap-2">
        <span class="cert-badge-count">{{ pendientes_list|length }} Pendientes</span>
        <button id="batchGenerateTop" type="button" class="btn-batch-inline">
          <i class="bi bi-files"></i> Generar Seleccionados
        </button>
      </div>
    </div>

    <div class="cert-table-wrap">
      <table id="tblPendientes" class="cert-table">
        <thead>
          <tr>
            <th class="th-check">
              <input type="checkbox" id="selectAll" class="cert-checkbox">
            </th>
            <th class="th-index">#</th>
            <th>Secretaría</th>
            <th>Objeto</th>
            <th>Justificación</th>
            <th>Fecha</th>
            <th class="td-center">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for sol in pendientes_list %}
          <tr>
            <td class="td-center">
              <input type="checkbox" class="cert-checkbox rowCheck" data-id="{{ sol.id }}">
            </td>
            <td class="td-index">{{ loop.index }}</td>
            <td><span class="badge-sec">{{ sol.secretaria[:25] }}...</span></td>
            <td class="td-ellipsis-200">{{ sol.objeto }}</td>
            <td class="td-ellipsis-250">{{ sol.justificacion }}</td>
            <td>{{ sol.fecha }}</td>
            <td class="td-center">
              <span class="badge-status"><i class="bi bi-clock-fill"></i> Pendiente</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div><!-- /cert-page -->
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
$(document).ready(function() {

  const table = $('#tblPendientes').DataTable({
    paging: true,
    info: true,
    lengthChange: false,
    pageLength: 10,
    language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
    dom: 'rtip',
    order: [[1, 'asc']]
  });

  $('#filterSecretaria').on('change', function() {
    table.column(2).search(this.value).draw();
  });

  $('#searchText').on('keyup', function() {
    table.search(this.value).draw();
  });

  $('#selectAll').on('click', function() {
    $('.rowCheck').prop('checked', this.checked);
  });

  function ejecutarGeneracion(btn) {
    const ids = $('.rowCheck:checked').map((_, el) => el.dataset.id).get();
    if (!ids.length) { alert('⚠️ Por favor selecciona al menos una solicitud.'); return; }
    const originalHtml = btn.html();
    btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Procesando ' + ids.length + '...').prop('disabled', true);
    const formData = new FormData();
    ids.forEach(id => formData.append('indices[]', id));
    fetch('{{ url_for("certificados.generar_lote") }}', { method: 'POST', body: formData })
      .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
      .then(data => {
        if (!data.success) throw new Error(data.error || 'Error desconocido');
        btn.html('<i class="bi bi-check-circle me-2"></i>✅ Éxito');
        if (Array.isArray(data.download_urls)) {
          data.download_urls.forEach((url, i) => {
            const a = document.createElement('a');
            a.href = url; a.download = ''; a.style.display = 'none';
            document.body.appendChild(a);
            setTimeout(() => { a.click(); document.body.removeChild(a); }, i * 150);
          });
        }
        let msg = '✅ ' + data.generados + ' de ' + data.total + ' certificados generados.';
        if (data.errores?.length) msg += '\n\n⚠️ Errores:\n- ' + data.errores.join('\n- ');
        alert(msg);
        setTimeout(() => location.reload(), 2000);
      })
      .catch(err => { btn.html(originalHtml).prop('disabled', false); alert('❌ Error:\n' + err.message); });
  }

  $('#batchGenerate, #batchGenerateTop').on('click', function() { ejecutarGeneracion($(this)); });

  // Chart.js — paleta institucional azul
  const ctx = document.getElementById('chartSecretarias');
  if (ctx) {
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: {{ sec_labels|tojson }},
        datasets: [{
          label: 'Certificados Generados',
          data: {{ sec_counts|tojson }},
          backgroundColor: 'rgba(15,76,129,0.75)',
          borderColor: 'rgba(15,76,129,1)',
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(0,0,0,0.04)' },
            ticks: { color: '#64748b', font: { weight: 600, size: 11 } }
          },
          x: {
            grid: { display: false },
            ticks: { color: '#64748b', font: { weight: 600, size: 10 }, maxRotation: 40, minRotation: 40 }
          }
        }
      }
    });
  }
});
</script>
{% endblock %}
