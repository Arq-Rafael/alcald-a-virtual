{% extends "base.html" %}

{% block head_extra %}
  <!-- DataTables CSS -->
  <link
    href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Bootstrap Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet"
  />
{% endblock %}

{% block content %}
<div class="container my-5 fade-in">
  <div class="glass-header mb-5 text-center">
    <h1 class="display-5 fw-bold" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
      <i class="bi bi-award-fill me-2" style="color: var(--secondary);"></i>Gestión de Certificados
    </h1>
    <p class="text-muted fs-5">Administración y generación de certificados municipales</p>
  </div>

  <!-- 1. Tarjetas de KPIs -->
  <div class="row mb-5 g-4">
    <div class="col-md-3">
      <div class="glass-panel p-4 text-center card-glow h-100">
        <div class="card-icon-wrapper mx-auto mb-3" style="width: 50px; height: 50px; font-size: 1.5rem;">
          <i class="bi bi-file-earmark-text"></i>
        </div>
        <h6 class="text-muted mb-2">Total Solicitudes</h6>
        <p class="display-6 fw-bold text-dark mb-0">{{ total_solicitudes }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass-panel p-4 text-center card-glow h-100" style="border-bottom: 4px solid var(--primary-light);">
        <div class="card-icon-wrapper mx-auto mb-3" style="width: 50px; height: 50px; font-size: 1.5rem; color: var(--primary-light);">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        <h6 class="text-muted mb-2">Generados</h6>
        <p class="display-6 fw-bold text-success mb-0">{{ generados }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass-panel p-4 text-center card-glow h-100" style="border-bottom: 4px solid var(--secondary);">
        <div class="card-icon-wrapper mx-auto mb-3" style="width: 50px; height: 50px; font-size: 1.5rem; color: var(--secondary);">
          <i class="bi bi-hourglass-split"></i>
        </div>
        <h6 class="text-muted mb-2">Pendientes</h6>
        <p class="display-6 fw-bold text-warning mb-0">{{ total_solicitudes - generados }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass-panel p-4 text-center card-glow h-100" style="border-bottom: 4px solid var(--accent);">
        <div class="card-icon-wrapper mx-auto mb-3" style="width: 50px; height: 50px; font-size: 1.5rem; color: var(--accent);">
          <i class="bi bi-speedometer2"></i>
        </div>
        <h6 class="text-muted mb-2">Tiempo Medio</h6>
        <p class="display-6 fw-bold text-info mb-0">{{ tiempo_medio }}s</p>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-5">
    <!-- 2. Gráfico de certificados por Secretaría -->
    <div class="col-md-8">
      <div class="glass-panel p-4 h-100">
        <h5 class="fw-bold mb-4"><i class="bi bi-bar-chart-fill me-2 text-primary"></i>Estadísticas por Secretaría</h5>
        <canvas id="chartSecretarias" style="max-height: 300px;"></canvas>
      </div>
    </div>
    
    <!-- 3. Panel de Filtros y Acciones -->
    <div class="col-md-4">
      <div class="glass-panel p-4 h-100 d-flex flex-column justify-content-center">
        <h5 class="fw-bold mb-4"><i class="bi bi-sliders me-2 text-primary"></i>Filtros y Acciones</h5>
        
        <div class="mb-3">
          <label class="form-label-premium">Filtrar Secretaría</label>
          <select id="filterSecretaria" class="form-select form-select-lg form-control-glass">
            <option value="">Todas las Secretarías</option>
            {% for sec in secretarias %}
              <option value="{{ sec }}">{{ sec }}</option>
            {% endfor %}
          </select>
        </div>
        
        <div class="mb-4">
          <label class="form-label-premium">Buscar Texto</label>
          <div class="input-group">
            <span class="input-group-text glass-panel border-end-0"><i class="bi bi-search"></i></span>
            <input type="text"
                   id="searchText"
                   class="form-control form-control-glass border-start-0"
                   placeholder="Buscar por objeto o justificación...">
          </div>
        </div>
        
        <button id="batchGenerate" class="btn btn-premium w-100 mt-auto">
          <i class="bi bi-lightning-charge-fill"></i> Generar Seleccionados
        </button>
      </div>
    </div>
  </div>

  <!-- 4. Tabla con paginación y selección -->
  <div class="glass-panel p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="fw-bold mb-0"><i class="bi bi-list-check me-2 text-primary"></i>Solicitudes Pendientes</h5>
      <span class="badge badge-institutional-green">{{ pendientes_list|length }} Pendientes</span>
    </div>
    
    <div class="table-responsive">
      <table id="tblPendientes" class="table table-hover align-middle" style="width:100%">
        <thead class="table-light">
          <tr>
            <th class="text-center" style="width: 50px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
            <th style="width: 50px;">#</th>
            <th>Secretaría</th>
            <th>Objeto</th>
            <th>Justificación</th>
            <th>Fecha</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for sol in pendientes_list %}
          <tr>
            <td class="text-center">
              <input type="checkbox"
                     class="form-check-input rowCheck shadow-none"
                     data-id="{{ sol.id }}">
            </td>
            <td class="fw-bold text-muted">{{ loop.index }}</td>
            <td><span class="badge bg-light text-dark border">{{ sol.secretaria }}</span></td>
            <td><div class="text-truncate" style="max-width: 200px;" title="{{ sol.objeto }}">{{ sol.objeto }}</div></td>
            <td><div class="text-truncate" style="max-width: 250px;" title="{{ sol.justificacion }}">{{ sol.justificacion }}</div></td>
            <td>{{ sol.fecha }}</td>
            <td><span class="badge bg-warning text-dark"><i class="bi bi-clock me-1"></i>Pendiente</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  <!-- jQuery (requerido por DataTables) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
    $(document).ready(() => {
      // Inicializar DataTable con diseño limpio
      const table = $('#tblPendientes').DataTable({
        paging: true,
        info: true,
        lengthChange: false,
        pageLength: 10,
        language: {
          url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json'
        },
        dom: 'rtip' // Ocultamos search y length default
      });

      // Filtro por Secretaría
      $('#filterSecretaria').on('change', function() {
        table.column(2).search(this.value).draw();
      });

      // Búsqueda global custom
      $('#searchText').on('keyup', function() {
        table.search(this.value).draw();
      });

      // Seleccionar todo
      $('#selectAll').on('click', function() {
        $('.rowCheck').prop('checked', this.checked);
      });

      // Batch generation
      $('#batchGenerate').on('click', function(e) {
        e.preventDefault();
        const btn = $(this);
        const ids = $('.rowCheck:checked')
                      .map((_, el) => el.dataset.id)
                      .get();
        if (!ids.length) {
          alert('Por favor selecciona al menos una solicitud para generar.');
          return;
        }
        
        // Animación de carga
        const originalText = btn.html();
        btn.html('<span class="spinner-border spinner-border-sm me-2"></span>Procesando...').prop('disabled', true);

        // Envío de solicitudes AJAX en paralelo para mejor UX
        const promises = ids.map(id => {
          return fetch('{{ url_for("certificados.generar_certificado") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `index=${encodeURIComponent(id)}`
          });
        });

        Promise.all(promises)
          .then(responses => {
            // Verificar si todas las respuestas fueron exitosas
            const allSuccess = responses.every(r => r.ok);
            if (allSuccess) {
              btn.html('<i class="bi bi-check-circle me-2"></i>¡Generados!').addClass('btn-success');
              setTimeout(() => {
                location.reload();
              }, 1500);
            } else {
              throw new Error('Algunas solicitudes fallaron');
            }
          })
          .catch(err => {
            console.error('Error generando certificados:', err);
            btn.html(originalText).prop('disabled', false);
            alert('Error al generar certificados. Intenta de nuevo.');
          });
      });

      // Chart.js: certificados por Secretaría
      const ctx = document.getElementById('chartSecretarias');
      if (ctx) {
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: {{ sec_labels|tojson }},
            datasets: [{
              label: 'Certificados Generados',
              data: {{ sec_counts|tojson }},
              backgroundColor: 'rgba(76, 175, 80, 0.6)',
              borderColor: 'rgba(76, 175, 80, 1)',
              borderWidth: 1,
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                grid: { color: 'rgba(0,0,0,0.05)' }
              },
              x: {
                grid: { display: false }
              }
            }
          }
        });
      }
    });
  </script>
{% endblock %}
