{% extends "base.html" %}

{% block content %}
  <h1 class="mb-4">Usos del Suelo</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, msg in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ msg }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <div id="map" style="width:100%; height:500px; margin-bottom:1.5rem;"></div>

  <form method="post" class="row g-3 mb-5" id="form-uso">
    <div class="col-md-4">
      <label for="cc" class="form-label">C√©dula catastral</label>
      <input name="cc" id="cc" class="form-control" placeholder="Ingrese c√©dula‚Ä¶">
    </div>
    <div class="col-md-4">
      <label for="matri" class="form-label">Matr√≠cula inmobiliaria</label>
      <input name="matri" id="matri" class="form-control" placeholder="Ingrese matr√≠cula‚Ä¶">
    </div>
    <div class="col-md-4">
      <label for="propietario" class="form-label">Propietario (opcional)</label>
      <input name="propietario" id="propietario" class="form-control" placeholder="Nombre‚Ä¶">
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-primary">Consultar Uso</button>
    </div>
  </form>

  {% if resultado %}
    <div class="card mb-4">
      <div class="card-body">
        <h5>Resultado b√∫squeda</h5>
        <p>
          <b>C√©dula:</b> {{ resultado.cedula }} |
          <b>Matr√≠cula:</b> {{ resultado.matricula }} |
          <b>Uso:</b> {{ resultado.uso }} |
          <b>Propietario:</b> {{ resultado.propietario }}
        </p>
          <a class="btn btn-success"
            href="{{ url_for('usos_suelo.generar_pdf', cc=resultado.cedula, matri=resultado.matricula) }}">
          Generar PDF
        </a>
      </div>
    </div>
  {% endif %}

  <a href="{{ url_for('usos_suelo.exportar_usos_excel') }}" class="btn btn-outline-success">
    üì• Exportar usos a Excel
  </a>
{% endblock %}


{% block scripts %}
  {{ super() }}

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity=""
    crossorigin="">
  </script>

  <script>
    // Construye la URL base para generar PDF
    const urlPdfBase = "{{ url_for('usos_suelo.generar_pdf', cc='__CC__', matri='__MAT__') }}";

    // Rellena el formulario y lo env√≠a
    function prefillAndSubmit(cc, matri){
      document.getElementById('cc').value    = cc || '';
      document.getElementById('matri').value = matri || '';
      document.getElementById('form-uso').submit();
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Inicializa Leaflet
      const map = L.map('map').setView([4.7, -74.1], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap'
      }).addTo(map);

      // Carga GeoJSON y pinta cada predio
      fetch("{{ url_for('usos_suelo.usos_suelo_geojson') }}")
        .then(r => r.json())
        .then(data => {
          const geoLayer = L.geoJSON(data, {
            style: feat => ({
              color: feat.properties.inf_id ? '#3388ff' : '#aaa',
              weight: 1,
              fillOpacity: feat.properties.inf_id ? 0.1 : 0
            }),
            onEachFeature: (feat, layer) => {
              const p = feat.properties || {};

              // Extrae valores para CC y Matr√≠cula
              const ccVal  = (p.COD_PRED || p.cod_pred || p.cedula_catastral || '').toString();
              const matVal = (p.NUM_DOC || p.num_doc || p.matricula || '').toString();
              const usoFin = p.uso || p.uso_final || p.dest_eco || '';

              // Genera contenido del popup
              let html = '<div style="max-height:220px;overflow:auto;font-size:12px;">';
              Object.entries(p).forEach(([k,v]) => {
                html += `<b>${k}:</b> ${v}<br>`;
              });
              html += '</div>';

              // Bot√≥n Consultar Uso
              html += `<button class="btn btn-sm btn-outline-primary mt-2"
                                onclick="prefillAndSubmit('${ccVal}','${matVal}')">
                         Consultar Uso del Suelo
                       </button>`;

              // Bot√≥n Generar PDF si ya hay uso
              if (usoFin) {
                const pdfURL = urlPdfBase
                                  .replace('__CC__', ccVal)
                                  .replace('__MAT__', matVal);
                html += ` <a class="btn btn-sm btn-primary mt-2 text-white"
                             href="${pdfURL}" target="_blank">
                             Generar Uso del Suelo
                           </a>`;
              }

              layer.bindPopup(html);
            }
          }).addTo(map);

          // Ajusta vista al bounds de los pol√≠gonos
          if (geoLayer.getBounds().isValid()) {
            map.fitBounds(geoLayer.getBounds());
          }
        })
        .catch(err => console.error("Error cargando GeoJSON:", err));
    });
  </script>
{% endblock %}
