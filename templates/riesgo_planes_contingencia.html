{% extends "base.html" %}
{% block title %}Planes de Contingencia - Gesti√≥n del Riesgo{% endblock %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/gestion_riesgo.css') }}">
<style>
  .contingencia-wrapper {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    min-height: calc(100vh - 60px);
    padding: 30px 20px;
  }

  .contingencia-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  /* Hero section */
  .contingencia-hero {
    background: linear-gradient(135deg, #2d5016 0%, #5a8a3a 100%);
    color: white;
    padding: 40px;
    border-radius: 12px;
    margin-bottom: 40px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }

  .contingencia-hero h1 {
    font-size: 2.5rem;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .contingencia-hero p {
    font-size: 1.1rem;
    opacity: 0.95;
  }

  /* Selector de tipos de evento */
  .eventos-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
  }

  .evento-card {
    background: white;
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    cursor: pointer;
    border-left: 5px solid #ccc;
    position: relative;
  }

  .evento-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.12);
  }

  .evento-card.active {
    border-left-color: #7cb342;
    background: #f0fdf4;
  }

  .evento-icon {
    font-size: 2.5rem;
    margin-bottom: 15px;
    display: inline-block;
  }

  .evento-card h3 {
    margin: 15px 0 8px 0;
    color: #2d5016;
    font-size: 1.1rem;
    font-weight: 600;
  }

  .evento-card p {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 15px;
  }

  .evento-btn {
    background: #5a8a3a;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
    width: 100%;
    font-size: 0.95rem;
  }

  .evento-btn:hover {
    background: #2d5016;
  }

  /* iOS-style buttons */
  .action-buttons-ios {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
  }

  .btn-ios {
    padding: 5px 10px;
    border: none;
    border-radius: 16px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    letter-spacing: 0.3px;
    line-height: 1.2;
  }

  .btn-ios:hover {
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.12);
  }

  .btn-ios:active {
    transform: scale(0.90);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .btn-ios.btn-pdf {
    background-color: #34C759;
    color: white;
  }

  .btn-ios.btn-enviar {
    background-color: #FFB800;
    color: #333;
  }

  .btn-ios.btn-aprobar {
    background-color: #007AFF;
    color: white;
  }

  .btn-ios.btn-comite {
    background-color: #1a472a;
    color: white;
  }
  
  .btn-ios.btn-editar {
    background-color: #5AC8FA;
    color: white;
    font-size: 14px;
    padding: 4px 9px;
  }
  
  .btn-ios.btn-ver {
    background-color: #8E8E93;
    color: white;
    font-size: 14px;
    padding: 4px 9px;
  }
  
  .btn-ios.btn-devolver {
    background-color: #FF9500;
    color: white;
    font-size: 14px;
    padding: 4px 9px;
  }

  .btn-ios.btn-secciones {
    background-color: #6366f1;
    color: white;
    font-size: 13px;
    padding: 4px 8px;
  }

  .btn-ios.btn-eliminar {
    background-color: #FF3B30;
    color: white;
    width: 26px;
    height: 26px;
    padding: 0;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0;
  }

  /* iOS-style modal */
  .ios-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    display: flex;
    justify-content: center;
    align-items: flex-end;
    z-index: 1000;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  @keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  .ios-modal-content {
    background: white;
    border-radius: 14px 14px 0 0;
    padding: 0;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.15);
  }

  .ios-modal-header {
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid #e5e5e5;
  }

  .ios-modal-header h3 {
    margin: 0;
    font-size: 17px;
    color: #333;
    font-weight: 600;
  }

  .ios-modal-body {
    padding: 16px 20px;
    text-align: center;
    color: #666;
    font-size: 15px;
  }

  .ios-modal-buttons {
    display: flex;
    gap: 0;
    border-top: 1px solid #e5e5e5;
  }

  .ios-modal-btn {
    flex: 1;
    padding: 14px;
    border: none;
    background: transparent;
    border-right: 1px solid #e5e5e5;
    cursor: pointer;
    font-size: 16px;
    font-weight: 500;
    transition: background-color 0.15s;
  }

  .ios-modal-btn:last-child {
    border-right: none;
  }

  .ios-modal-btn:active {
    background-color: #f0f0f0;
  }

  .ios-modal-btn.cancel {
    color: #999;
  }

  .ios-modal-btn.confirm {
    color: #007AFF;
    font-weight: 600;
  }

  /* Message bubble */
  .msg-bubble {
    position: fixed;
    bottom: 20px;
    right: 20px;
    max-width: 300px;
    padding: 12px 16px;
    border-radius: 18px;
    font-size: 14px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    animation: bubbleIn 0.3s ease;
    z-index: 999;
  }

  @keyframes bubbleIn {
    from { transform: translate(400px, 100px); opacity: 0; }
    to { transform: translate(0, 0); opacity: 1; }
  }

  .msg-bubble.success {
    background-color: #34C759;
    color: white;
  }

  .msg-bubble.info {
    background-color: #007AFF;
    color: white;
  }

  .msg-bubble.error {
    background-color: #FF3B30;
    color: white;
  }

  /* Wizard modal */
  .wizard-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
  }

  .wizard-overlay.active {
    display: flex;
  }

  .wizard-container {
    background: white;
    border-radius: 12px;
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  }

  .wizard-header {
    background: linear-gradient(135deg, #2d5016 0%, #5a8a3a 100%);
    color: white;
    padding: 25px;
    border-radius: 12px 12px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .wizard-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }

  .wizard-close {
    background: none;
    border: none;
    color: white;
    font-size: 1.8rem;
    cursor: pointer;
  }

  .wizard-progress {
    background: #f5f5f5;
    padding: 20px 25px;
    border-bottom: 1px solid #e0e0e0;
    display: flex;
    gap: 10px;
  }

  .progress-step {
    flex: 1;
    height: 4px;
    background: #e0e0e0;
    border-radius: 2px;
    position: relative;
  }

  .progress-step.active,
  .progress-step.completed {
    background: #7cb342;
  }

  .wizard-content {
    flex: 1;
    overflow-y: auto;
    padding: 30px;
  }

  .wizard-section {
    display: none;
  }

  .wizard-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .wizard-section h3 {
    color: #2d5016;
    margin-bottom: 20px;
    font-size: 1.3rem;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
  }

  .form-group input,
  .form-group textarea,
  .form-group select {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    font-family: inherit;
  }

  .form-group textarea {
    min-height: 100px;
    resize: vertical;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  /* Tabla de edici√≥n inline */
  .inline-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    background: white;
  }

  .inline-table th,
  .inline-table td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: left;
  }

  .inline-table th {
    background: #5a8a3a;
    color: white;
    font-weight: 600;
  }

  .inline-table input {
    width: 100%;
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  .btn-add-row {
    background: #7cb342;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
    font-size: 0.9rem;
  }

  .btn-remove-row {
    background: #ef4444;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 0.85rem;
  }

  /* Uploader de archivos */
  .file-uploader {
    border: 2px dashed #7cb342;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    background: #f9fdf7;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .file-uploader:hover {
    background: #f0fdf4;
    border-color: #5a8a3a;
  }

  .file-uploader.drag-over {
    background: #e8f5e9;
    border-color: #2d5016;
  }

  .file-list {
    margin-top: 15px;
  }

  .file-item {
    background: #f5f5f5;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .file-item .file-name {
    flex: 1;
    font-weight: 500;
  }

  .file-item .btn-remove {
    background: #ef4444;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 3px;
    cursor: pointer;
  }

  /* Wizard footer */
  .wizard-footer {
    border-top: 1px solid #e0e0e0;
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    gap: 15px;
    background: #f9f9f9;
    border-radius: 0 0 12px 12px;
  }

  .btn-wizard {
    padding: 12px 24px;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    font-size: 0.95rem;
    transition: all 0.3s ease;
  }

  .btn-prev {
    background: #e0e0e0;
    color: #333;
  }

  .btn-prev:hover {
    background: #d0d0d0;
  }

  .btn-next,
  .btn-guardar {
    background: #5a8a3a;
    color: white;
    flex: 1;
  }

  .btn-next:hover,
  .btn-guardar:hover {
    background: #2d5016;
  }

  /* Tabla de planes */
  .planes-tabla {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  }

  .planes-tabla table {
    width: 100%;
    border-collapse: collapse;
  }

  .planes-tabla th {
    background: #2d5016;
    color: white;
    padding: 15px;
    text-align: left;
    font-weight: 600;
  }

  .planes-tabla td {
    padding: 12px 15px;
    border-bottom: 1px solid #e0e0e0;
  }

  .planes-tabla tr:hover {
    background: #f9f9f9;
  }

  .badge-estado {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-borrador {
    background: #fef3c7;
    color: #92400e;
  }

  .badge-en_revision {
    background: #fce7f3;
    color: #831843;
  }

  .badge-emitido {
    background: #d1fae5;
    color: #065f46;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .btn-accion {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .btn-editar {
    background: #60a5fa;
    color: white;
  }

  .btn-descargar {
    background: #10b981;
    color: white;
  }

  .btn-duplicar {
    background: #8b5cf6;
    color: white;
  }

  .btn-eliminar {
    background: #ef4444;
    color: white;
  }

  .btn-accion:hover {
    opacity: 0.9;
  }

  /* Mensaje de estado */
  .alert {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: none;
  }

  .alert.show {
    display: block;
  }

  .alert-success {
    background: #d1fae5;
    color: #065f46;
    border: 1px solid #6ee7b7;
  }

  .alert-error {
    background: #fee2e2;
    color: #991b1b;
    border: 1px solid #fca5a5;
  }
</style>
{% endblock %}

{% block content %}
<div class="contingencia-wrapper">
  <div class="contingencia-container">
    
    <!-- Hero -->
    <div class="contingencia-hero">
      <h1>Planes de Contingencia</h1>
      <p>Crea y gestiona planes de contingencia para diferentes tipos de eventos. Incluye portada, tabla de contenidos, im√°genes y mapas.</p>
    </div>

    <!-- Alert messages -->
    <div id="alertMessage" class="alert"></div>

    <!-- Selector de Tipos de Evento -->
    <h2 style="color: #2d5016; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600;">Selecciona un tipo de evento para crear un nuevo plan:</h2>
    <div class="eventos-grid" id="eventosGrid">
      <!-- Se llena din√°micamente con JavaScript -->
    </div>

    <!-- Tabla de Planes Existentes -->
    <h2 style="color: #2d5016; margin-bottom: 20px; font-size: 1.3rem; font-weight: 600; margin-top: 50px;">Planes Existentes</h2>
    <div class="planes-tabla">
      <table id="planesTable">
        <thead>
          <tr>
            <th>N√∫mero</th>
            <th>Nombre</th>
            <th>Tipo de Evento</th>
            <th>Responsable</th>
            <th>Estado</th>
            <th>Vigencia</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="planesTbody">
          <tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">Cargando planes...</td></tr>
        </tbody>
      </table>
    </div>

  </div>
</div>

<!-- ===== MODAL WIZARD ===== -->
<div id="wizardOverlay" class="wizard-overlay">
  <div class="wizard-container">
    
    <div class="wizard-header">
      <h2 id="wizardTitle">Nuevo Plan de Contingencia</h2>
      <button class="wizard-close" onclick="cerrarWizard()">&times;</button>
    </div>

    <div class="wizard-progress" id="wizardProgress">
      <!-- Se llena din√°micamente -->
    </div>

    <div class="wizard-content">
      <form id="planForm">
        
        <!-- SECCI√ìN 1: IDENTIFICACI√ìN -->
        <div class="wizard-section active" data-section="1">
          <h3>1. Identificaci√≥n del Plan</h3>
          
          <div class="form-group">
            <label>Nombre del Plan*</label>
            <input type="text" name="nombre_plan" placeholder="Ej. Plan de Contingencia para Temporada de Lluvias 2026" required>
          </div>

          <div class="form-group">
            <label>Tipo de Evento (auto-detectado)</label>
            <input type="text" id="tipoEventoDisplay" disabled style="background: #f5f5f5;">
            <input type="hidden" name="tipo_evento" id="tipoEventoInput">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Versi√≥n</label>
              <input type="text" name="version" value="1.0" placeholder="1.0">
            </div>
            <div class="form-group">
              <label>√Åmbito de Cobertura*</label>
              <input type="text" name="ambito" placeholder="Municipio, Vereda, Barrio" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Municipio</label>
              <input type="text" name="municipio" placeholder="Municipio">
            </div>
            <div class="form-group">
              <label>Poblaci√≥n Objetivo (estimada)</label>
              <input type="number" name="poblacion_objetivo" placeholder="0" min="0">
            </div>
          </div>

          <div class="form-group">
            <label>Descripci√≥n del √Årea de Cobertura</label>
            <textarea name="area_cobertura" placeholder="Descripci√≥n geogr√°fica y administrativa del √°rea cubierta por este plan"></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 2: RESPONSABLES Y APROBACI√ìN -->
        <div class="wizard-section" data-section="2">
          <h3>2. Responsables y Aprobaci√≥n</h3>

          <div class="form-group">
            <label>Responsable Principal*</label>
            <input type="text" name="responsable_principal" placeholder="Nombre y cargo" required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Correo Electr√≥nico</label>
              <input type="email" name="correo_responsable" placeholder="correo@example.com">
            </div>
            <div class="form-group">
              <label>Tel√©fono</label>
              <input type="tel" name="telefono_responsable" placeholder="Ej. +57 1234567890">
            </div>
          </div>

          <div class="form-group">
            <label>Entidad Responsable</label>
            <input type="text" name="entidad_responsable" value="Alcald√≠a Municipal" placeholder="Alcald√≠a Municipal">
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Vigencia Desde</label>
              <input type="date" name="vigencia_desde">
            </div>
            <div class="form-group">
              <label>Vigencia Hasta</label>
              <input type="date" name="vigencia_hasta">
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>N√∫mero de Resoluci√≥n</label>
              <input type="text" name="numero_resolucion" placeholder="Ej. RES-2026-001">
            </div>
            <div class="form-group">
              <label>Fecha de Resoluci√≥n</label>
              <input type="date" name="fecha_resolucion">
            </div>
          </div>

          <div class="form-group">
            <label>Aprobado por</label>
            <input type="text" name="aprobado_por" placeholder="Nombre del funcionario que aprueba">
          </div>
        </div>

        <!-- SECCI√ìN 3: ESCENARIO Y RIESGO -->
        <div class="wizard-section" data-section="3">
          <h3>3. Escenario y An√°lisis de Riesgo</h3>

          <div class="form-group">
            <label>Descripci√≥n del Peligro*</label>
            <textarea name="descripcion_peligro" placeholder="Describe el tipo de peligro/evento, caracter√≠sticas, frecuencia, etc." required></textarea>
          </div>

          <div class="form-group">
            <label>Antecedentes Hist√≥ricos</label>
            <textarea name="antecedentes_historicos" placeholder="Eventos previos, impactos registrados, lecciones aprendidas"></textarea>
          </div>

          <div class="form-group">
            <label>Poblaci√≥n Expuesta</label>
            <textarea name="poblacion_expuesta" placeholder="Descripci√≥n de grupos vulnerables y poblaci√≥n potencialmente afectada"></textarea>
          </div>

          <div class="form-group">
            <label>Activos Expuestos (Infraestructura)</label>
            <textarea name="activos_expuestos" placeholder="Servicios, bienes, infraestructura cr√≠tica en riesgo"></textarea>
          </div>

          <div class="form-group">
            <label>Supuestos y Limitaciones</label>
            <textarea name="supuestos_limitaciones" placeholder="Supuestos en los que se basa el plan y sus limitaciones"></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 4: UMBRALES Y ALERTAS -->
        <div class="wizard-section" data-section="4">
          <h3>4. Alertas y Niveles de Activaci√≥n</h3>
          <p style="color: #666; margin-bottom: 15px;">Define los umbrales y criterios para cada nivel de alerta.</p>

          <table class="inline-table" id="umbralTable">
            <thead>
              <tr>
                <th>Nivel</th>
                <th>Criterio / Descripci√≥n</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="umbralTbody">
              <tr>
                <td><input type="text" value="Verde" class="nivel"></td>
                <td><input type="text" placeholder="Normal" class="criterio"></td>
                <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
              </tr>
              <tr>
                <td><input type="text" value="Amarillo" class="nivel"></td>
                <td><input type="text" placeholder="Riesgo bajo" class="criterio"></td>
                <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
              </tr>
              <tr>
                <td><input type="text" value="Naranja" class="nivel"></td>
                <td><input type="text" placeholder="Riesgo moderado" class="criterio"></td>
                <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
              </tr>
              <tr>
                <td><input type="text" value="Rojo" class="nivel"></td>
                <td><input type="text" placeholder="Riesgo alto" class="criterio"></td>
                <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn-add-row" onclick="agregarFilaUmbral()">+ Agregar Nivel</button>
        </div>

        <!-- SECCI√ìN 5: ORGANIZACI√ìN Y ROLES -->
        <div class="wizard-section" data-section="5">
          <h3>5. Organizaci√≥n y Estructura de Mando</h3>

          <div class="form-group">
            <label>Estructura de Comando (Descripci√≥n General)</label>
            <textarea name="estructura_comando_desc" placeholder="Describe la estructura del Centro de Operaciones de Emergencias (COE) o similar"></textarea>
          </div>

          <p style="color: #666; margin: 20px 0 15px 0; font-weight: 600;">Responsables Sectoriales:</p>
          <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; color: #2d5016;">
            üí° <strong>Tip:</strong> Haz clic en "Cargar Usuarios del Sistema" para llenar autom√°ticamente los datos desde la base de datos.
          </div>
          <button type="button" class="btn-add-row" style="margin-bottom: 15px;" onclick="cargarUsuariosDelSistema()">üì• Cargar Usuarios del Sistema</button>
          
          <table class="inline-table" id="rolesTable">
            <thead>
              <tr>
                <th>Sector</th>
                <th>Responsable</th>
                <th>Tel√©fono de Guardia</th>
                <th>Correo</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody id="rolesTbody">
              <tr>
                <td><input type="text" placeholder="Salud" class="sector"></td>
                <td><input type="text" placeholder="Nombre completo" class="responsable"></td>
                <td><input type="tel" placeholder="Tel√©fono" class="telefono"></td>
                <td><input type="email" placeholder="correo@example.com" class="correo"></td>
                <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="btn-add-row" onclick="agregarFilaRol()">+ Agregar Responsable</button>
        </div>

        <!-- SECCI√ìN 6: LOG√çSTICA Y RECURSOS -->
        <div class="wizard-section" data-section="6">
          <h3>6. Log√≠stica y Recursos</h3>

          <div class="form-group">
            <label>Inventario de Equipos (Descripci√≥n)</label>
            <textarea name="inventario_desc" placeholder="Equipos disponibles, veh√≠culos, maquinaria amarilla, EPP, etc."></textarea>
          </div>

          <div class="form-group">
            <label>Puntos de Acopio (Ubicaci√≥n)</label>
            <textarea name="puntos_acopio_desc" placeholder="Descripci√≥n de centros de acopio, almacenes, bodegas"></textarea>
          </div>

          <div class="form-group">
            <label>Rutas de Abastecimiento</label>
            <textarea name="rutas_abastecimiento" placeholder="Rutas de distribuci√≥n y acceso a puntos de acopio"></textarea>
          </div>

          <div class="form-group">
            <label>Proveedores Cr√≠ticos</label>
            <textarea name="proveedores_criticos" placeholder="Empresas o entidades clave para suministros, combustible, etc."></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 7: COMUNICACIONES -->
        <div class="wizard-section" data-section="7">
          <h3>7. Comunicaciones y Vocer√≠as</h3>

          <div class="form-group">
            <label>Voceros Oficiales</label>
            <textarea name="voceros" placeholder="Nombres, cargos y contactos de los voceros oficiales"></textarea>
          </div>

          <div class="form-group">
            <label>Canales de Comunicaci√≥n</label>
            <textarea name="canales_desc" placeholder="Radio, SMS, sirenas, redes sociales, perifoneo, etc."></textarea>
          </div>

          <div class="form-group">
            <label>Formatos de Boletines</label>
            <textarea name="formatos_boletines" placeholder="Descripci√≥n de formatos, frecuencia y distribuci√≥n de boletines"></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 8: SALUD Y AYUDA HUMANITARIA -->
        <div class="wizard-section" data-section="8">
          <h3>8. Salud y Asistencia Humanitaria</h3>

          <div class="form-group">
            <label>Protocolos de Salud</label>
            <textarea name="protocolos_desc" placeholder="Primeros auxilios, vigilancia epidemiol√≥gica, referencia/contrarreferencia"></textarea>
          </div>

          <div class="form-group">
            <label>Grupos Vulnerables</label>
            <textarea name="grupos_vulnerables_desc" placeholder="Protecci√≥n de ni√±os, adultos mayores, personas con discapacidad, etc."></textarea>
          </div>

          <div class="form-group">
            <label>Kits Humanitarios</label>
            <textarea name="kits_desc" placeholder="Contenido, ubicaci√≥n y cantidad de kits de ayuda humanitaria"></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 9: PRESUPUESTO -->
        <div class="wizard-section" data-section="9">
          <h3>9. Presupuesto y Financiamiento</h3>

          <div class="form-group">
            <label>Presupuesto Total Estimado</label>
            <input type="number" name="presupuesto_total" placeholder="0" min="0" step="1000">
          </div>

          <div class="form-group">
            <label>Presupuesto por Fase (Descripci√≥n)</label>
            <textarea name="presupuesto_desc" placeholder="Distribuci√≥n de presupuesto para preparaci√≥n, alistamiento, respuesta, rehabilitaci√≥n"></textarea>
          </div>

          <div class="form-group">
            <label>Fuentes de Financiamiento</label>
            <textarea name="fuentes_financiamiento" placeholder="Municipio, transferencias, cooperaci√≥n internacional, etc."></textarea>
          </div>
        </div>

        <!-- SECCI√ìN 10: MULTIMEDIA Y ANEXOS -->
        <div class="wizard-section" data-section="10">
          <h3>10. Multimedia, Mapas e Im√°genes</h3>

          <p style="color: #666; margin-bottom: 15px;">Carga mapas, im√°genes y documentos anexos que se incluir√°n en el PDF.</p>

          <div class="form-group">
            <label>Mapas de Riesgo / Evacuaci√≥n / Puntos Cr√≠ticos</label>
            <div class="file-uploader" id="mapasUploader" ondrop="manejarDrop(event, 'mapas')" ondragover="manejarDragOver(event)" ondragleave="manejarDragLeave(event)" onclick="document.getElementById('mapasInput').click()">
              <div style="font-size: 2rem; margin-bottom: 10px;">üìç</div>
              <p>Arrastra mapas aqu√≠ o haz clic para seleccionar</p>
              <input type="file" id="mapasInput" multiple accept="image/*,.pdf" style="display: none;" onchange="manejarArchivos(event, 'mapas')">
            </div>
            <div class="file-list" id="listaMapas"></div>
          </div>

          <div class="form-group">
            <label>Im√°genes (Fotograf√≠as, Diagramas)</label>
            <div class="file-uploader" id="imagenesUploader" ondrop="manejarDrop(event, 'imagenes')" ondragover="manejarDragOver(event)" ondragleave="manejarDragLeave(event)" onclick="document.getElementById('imagenesInput').click()">
              <div style="font-size: 2rem; margin-bottom: 10px;">üñºÔ∏è</div>
              <p>Arrastra im√°genes aqu√≠ o haz clic para seleccionar</p>
              <input type="file" id="imagenesInput" multiple accept="image/*" style="display: none;" onchange="manejarArchivos(event, 'imagenes')">
            </div>
            <div class="file-list" id="listaImagenes"></div>
          </div>

          <div class="form-group">
            <label>Documentos Anexos (PDF, Word, Excel)</label>
            <div class="file-uploader" id="docsUploader" ondrop="manejarDrop(event, 'documentos')" ondragover="manejarDragOver(event)" ondragleave="manejarDragLeave(event)" onclick="document.getElementById('docsInput').click()">
              <div style="font-size: 2rem; margin-bottom: 10px;">üìÑ</div>
              <p>Arrastra documentos aqu√≠ o haz clic para seleccionar</p>
              <input type="file" id="docsInput" multiple accept=".pdf,.doc,.docx,.xls,.xlsx" style="display: none;" onchange="manejarArchivos(event, 'documentos')">
            </div>
            <div class="file-list" id="listaDocumentos"></div>
          </div>
        </div>

        <!-- SECCI√ìN 11: REVISI√ìN Y FINALIZACI√ìN -->
        <div class="wizard-section" data-section="11">
          <h3>11. Revisi√≥n y Finalizaci√≥n</h3>

          <div style="background: #f0fdf4; border-left: 4px solid #7cb342; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
            <p style="margin: 0; color: #065f46;"><strong>‚úì Plan casi listo!</strong></p>
            <p style="margin: 5px 0 0 0; color: #047857; font-size: 0.9rem;">Verifica que todos los datos sean correctos antes de guardar. Podr√°s editar el plan despu√©s.</p>
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" name="confirmar">
              Confirmo que los datos son correctos y autorizo la creaci√≥n del plan
            </label>
          </div>

          <div class="form-group">
            <label>Estado Inicial del Plan</label>
            <select name="estado">
              <option value="Borrador" selected>Borrador (editable)</option>
              <option value="En_revision">En revisi√≥n</option>
              <option value="Emitido">Emitido (final)</option>
            </select>
          </div>

          <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 20px;">
            <p style="margin: 0; color: #1b5e20; font-size: 0.9rem;"><strong>üìÑ PDF:</strong> Se generar√° autom√°ticamente con portada, tabla de contenidos y todas las secciones completadas.</p>
          </div>
        </div>

      </form>
    </div>

    <div class="wizard-footer">
      <button class="btn-wizard btn-prev" onclick="irPaginaPrev()">‚Üê Anterior</button>
      <div id="footerButtons">
        <button class="btn-wizard btn-next" onclick="irPaginaSig()">Siguiente ‚Üí</button>
      </div>
    </div>

  </div>
</div>

<script>
// ===== VARIABLES GLOBALES =====
let paginaActual = 1;
const totalSecciones = 11;
let tipoEventoSeleccionado = null;

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
  cargarTiposEventos();
  cargarPlanesExistentes();
});

// ===== FUNCIONES DE TIPOS DE EVENTO =====
async function cargarTiposEventos() {
  try {
    const response = await fetch('/api/contingencia/tipos-eventos');
    const tipos = await response.json();
    
    const grid = document.getElementById('eventosGrid');
    grid.innerHTML = '';
    
    for (const [tipo, config] of Object.entries(tipos)) {
      const card = document.createElement('div');
      card.className = 'evento-card';
      const tipoDisplay = tipo.replace('_', ' ');
      card.innerHTML = `
        <div class="evento-icon">
          <i class="bi bi-${config.icon}"></i>
        </div>
        <h3>${tipoDisplay}</h3>
        <p>Crea un plan de contingencia para ${tipoDisplay.toLowerCase()}</p>
        <button type="button" class="evento-btn" onclick="seleccionarEvento('${tipo}')">
          Crear Plan
        </button>
      `;
      grid.appendChild(card);
    }
  } catch (error) {
    console.error('Error cargando tipos de eventos:', error);
    mostrarAlerta('Error al cargar tipos de eventos', 'error');
  }
}

function seleccionarEvento(tipo) {
  tipoEventoSeleccionado = tipo;
  document.getElementById('tipoEventoInput').value = tipo;
  document.getElementById('tipoEventoDisplay').value = tipo.replace('_', ' ');
  cargarDatosSugeridos(tipo);
  abrirWizard();
}

async function cargarDatosSugeridos(tipo_evento) {
  try {
    const response = await fetch(`/api/contingencia/datos-sugeridos/${tipo_evento}`);
    const resultado = await response.json();
    
    if (resultado.success) {
      const datos = resultado.datos;
      
      // Llenar campos sugeridos autom√°ticamente
      const descPeligroField = document.querySelector('textarea[name="descripcion_peligro"]');
      if (descPeligroField && !descPeligroField.value) {
        descPeligroField.value = datos.descripcion_base;
      }
      
      const antecedentesField = document.querySelector('textarea[name="antecedentes_historicos"]');
      if (antecedentesField && !antecedentesField.value) {
        antecedentesField.value = datos.antecedentes_sugeridos;
      }
      
      // Llenar umbrales recomendados
      const tbody = document.getElementById('umbralTbody');
      if (tbody && tbody.children.length <= 4) { // Solo si est√° en el default
        tbody.innerHTML = '';
        for (const [nivel, criterio] of Object.entries(datos.umbrales_predefinidos)) {
          const row = tbody.insertRow();
          row.innerHTML = `
            <td><input type="text" value="${nivel}" class="nivel"></td>
            <td><input type="text" value="${criterio}" class="criterio"></td>
            <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
          `;
        }
      }
      
      // Llenar sectores recomendados
      const rolesTbody = document.getElementById('rolesTbody');
      if (rolesTbody && rolesTbody.children.length <= 1) { // Solo si est√° en el default
        rolesTbody.innerHTML = '';
        datos.sectores_recomendados.forEach(sector => {
          const row = rolesTbody.insertRow();
          row.innerHTML = `
            <td><input type="text" value="${sector}" class="sector"></td>
            <td><input type="text" placeholder="Responsable" class="responsable"></td>
            <td><input type="tel" placeholder="Tel√©fono" class="telefono"></td>
            <td><input type="email" placeholder="correo@example.com" class="correo"></td>
            <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
          `;
        });
      }
      
      console.log('‚úì Datos sugeridos cargados');
    }
  } catch (error) {
    console.log('Informaci√≥n: No se cargaron datos sugeridos autom√°ticamente');
  }
}

// ===== FUNCIONES DEL WIZARD =====
function abrirWizard() {
  paginaActual = 1;
  document.getElementById('wizardOverlay').classList.add('active');
  mostrarSecci√≥n(1);
  actualizarProgreso();
}

function cerrarWizard() {
  if (confirm('¬øCerrar el asistente? Se perder√°n los cambios no guardados.')) {
    document.getElementById('wizardOverlay').classList.remove('active');
    document.getElementById('planForm').reset();
    paginaActual = 1;
    tipoEventoSeleccionado = null;
  }
}

function mostrarSecci√≥n(num) {
  document.querySelectorAll('.wizard-section').forEach(sec => sec.classList.remove('active'));
  document.querySelector(`[data-section="${num}"]`).classList.add('active');
}

function actualizarProgreso() {
  const progress = document.getElementById('wizardProgress');
  progress.innerHTML = '';
  
  for (let i = 1; i <= totalSecciones; i++) {
    const step = document.createElement('div');
    step.className = 'progress-step';
    if (i < paginaActual) {
      step.classList.add('completed');
    } else if (i === paginaActual) {
      step.classList.add('active');
    }
    progress.appendChild(step);
  }
  
  const footer = document.getElementById('footerButtons');
  if (paginaActual === totalSecciones) {
    footer.innerHTML = '<button type="button" class="btn-wizard btn-guardar" onclick="guardarPlan()">‚úì Guardar Plan</button>';
  } else {
    footer.innerHTML = '<button type="button" class="btn-wizard btn-next" onclick="irPaginaSig()">Siguiente ‚Üí</button>';
  }
}

function irPaginaSig() {
  if (paginaActual < totalSecciones) {
    paginaActual++;
    mostrarSecci√≥n(paginaActual);
    actualizarProgreso();
    document.querySelector('.wizard-content').scrollTop = 0;
  }
}

function irPaginaPrev() {
  if (paginaActual > 1) {
    paginaActual--;
    mostrarSecci√≥n(paginaActual);
    actualizarProgreso();
    document.querySelector('.wizard-content').scrollTop = 0;
  }
}

// ===== GESTI√ìN DE TABLAS DIN√ÅMICAS =====
function agregarFilaUmbral() {
  const tbody = document.getElementById('umbralTbody');
  const row = tbody.insertRow();
  row.innerHTML = `
    <td><input type="text" placeholder="Nuevo nivel" class="nivel"></td>
    <td><input type="text" placeholder="Criterio" class="criterio"></td>
    <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
  `;
}

function agregarFilaRol() {
  const tbody = document.getElementById('rolesTbody');
  const row = tbody.insertRow();
  row.innerHTML = `
    <td><input type="text" placeholder="Sector" class="sector"></td>
    <td><input type="text" placeholder="Responsable" class="responsable"></td>
    <td><input type="tel" placeholder="Tel√©fono" class="telefono"></td>
    <td><input type="email" placeholder="correo@example.com" class="correo"></td>
    <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
  `;
}

async function cargarUsuariosDelSistema() {
  try {
    mostrarAlerta('Cargando usuarios del sistema...', 'success');
    const response = await fetch('/api/contingencia/cargar-usuarios');
    const datos = await response.json();
    
    const tbody = document.getElementById('rolesTbody');
    tbody.innerHTML = '';
    
    // Mapeo de sectores est√°ndar
    const sectoresPredef = ['Salud', 'Log√≠stica', 'Seguridad', 'Tr√°nsito', 'WASH', 'Comunicaciones'];
    
    sectoresPredef.forEach((sector, idx) => {
      const usuario = datos.usuarios && datos.usuarios[idx] ? datos.usuarios[idx] : {};
      const row = tbody.insertRow();
      row.innerHTML = `
        <td><input type="text" value="${sector}" class="sector"></td>
        <td><input type="text" placeholder="Responsable" class="responsable" value="${usuario.nombre || ''}"></td>
        <td><input type="tel" placeholder="Tel√©fono" class="telefono" value="${usuario.telefono || ''}"></td>
        <td><input type="email" placeholder="correo@example.com" class="correo" value="${usuario.email || ''}"></td>
        <td><button class="btn-remove-row" type="button" onclick="eliminarFila(this)">Eliminar</button></td>
      `;
    });
    
    mostrarAlerta('‚úì Usuarios cargados autom√°ticamente', 'success');
  } catch (error) {
    console.error('Error cargando usuarios:', error);
    mostrarAlerta('No se pudieron cargar los usuarios (contin√∫a manualmente)', 'error');
  }
}

function eliminarFila(btn) {
  btn.closest('tr').remove();
}

// ===== GESTI√ìN DE ARCHIVOS =====
function manejarDragOver(e) {
  e.preventDefault();
  e.target.closest('.file-uploader').classList.add('drag-over');
}

function manejarDragLeave(e) {
  e.target.closest('.file-uploader').classList.remove('drag-over');
}

function manejarDrop(e, tipo) {
  e.preventDefault();
  e.target.closest('.file-uploader').classList.remove('drag-over');
  const files = e.dataTransfer.files;
  manejarArchivos({ target: { files: files } }, tipo);
}

function manejarArchivos(event, tipo) {
  const files = event.target.files;
  const tipoId = {
    'mapas': 'listaMapas',
    'imagenes': 'listaImagenes',
    'documentos': 'listaDocumentos'
  };
  
  const lista = document.getElementById(tipoId[tipo]);
  if (!lista) {
    console.error(`Elemento lista${tipo} no encontrado`);
    return;
  }
  
  lista.innerHTML = '';
  
  for (const file of files) {
    const item = document.createElement('div');
    item.className = 'file-item';
    item.innerHTML = `
      <span class="file-name">üìé ${file.name}</span>
      <button type="button" class="btn-remove" onclick="this.parentElement.remove()">‚úï</button>
    `;
    lista.appendChild(item);
  }
}

// ===== GUARDADO DEL PLAN =====
async function guardarPlan() {
  const form = document.getElementById('planForm');
  
  // Validaci√≥n manual solo de campos cr√≠ticos
  const nombre_plan = form.querySelector('input[name="nombre_plan"]')?.value?.trim();
  const responsable_principal = form.querySelector('input[name="responsable_principal"]')?.value?.trim();
  const ambito = form.querySelector('input[name="ambito"]')?.value?.trim();
  const descripcion_peligro = form.querySelector('textarea[name="descripcion_peligro"]')?.value?.trim();
  const estado = form.querySelector('select[name="estado"]')?.value;
  
  if (!nombre_plan || !responsable_principal || !ambito || !descripcion_peligro || !estado) {
    alert('Por favor, completa los campos principales:\n- Nombre del Plan\n- Responsable Principal\n- √Åmbito de Cobertura\n- Descripci√≥n del Peligro\n- Estado');
    return;
  }

  const formData = new FormData(form);
  const datos = Object.fromEntries(formData);
  
  const umbrales = {};
  document.querySelectorAll('#umbralTbody tr').forEach(row => {
    const nivel = row.querySelector('.nivel').value;
    const criterio = row.querySelector('.criterio').value;
    if (nivel && criterio) umbrales[nivel.toLowerCase()] = criterio;
  });
  datos.umbrales_alertas = umbrales;
  
  const roles = [];
  document.querySelectorAll('#rolesTbody tr').forEach(row => {
    const sector = row.querySelector('.sector').value;
    const responsable = row.querySelector('.responsable').value;
    const telefono = row.querySelector('.telefono').value;
    const correo = row.querySelector('.correo').value;
    if (sector || responsable) {
      roles.push({ sector, responsable, telefono, correo });
    }
  });
  datos.estructura_organizativa = { roles };
  datos.usuario_creador = 'Sistema';
  
  mostrarAlerta('Guardando plan...', 'success');
  
  try {
    const response = await fetch('/api/contingencia/crear', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(datos)
    });
    
    const resultado = await response.json();
    
    if (resultado.success) {
      mostrarAlerta('‚úì Plan guardado exitosamente.', 'success');
      setTimeout(() => {
        cerrarWizard();
        cargarPlanesExistentes();
      }, 1500);
    } else {
      mostrarAlerta('Error al guardar: ' + resultado.error, 'error');
    }
  } catch (error) {
    console.error('Error guardando plan:', error);
    mostrarAlerta('Error de conexi√≥n al guardar el plan', 'error');
  }
}

// ===== CARGA DE PLANES EXISTENTES =====
async function cargarPlanesExistentes() {
  try {
    const response = await fetch('/api/contingencia?per_page=50');
    const resultado = await response.json();
    
    const tbody = document.getElementById('planesTbody');
    if (!tbody) {
      console.warn('No se encontr√≥ elemento planesTbody');
      return;
    }
    
    tbody.innerHTML = '';
    
    // Validar que resultado tenga la estructura correcta
    if (!resultado.planes || resultado.planes.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #999;">No hay planes creados a√∫n.</td></tr>';
      return;
    }
    
    resultado.planes.forEach(plan => {
      const estadoKey = (plan.estado || 'Borrador').toLowerCase().replace(/\s/g, '_');
      const badgeClass = estadoKey === 'en_revision' ? 'badge-en_revision' : `badge-${estadoKey}`;
      
      // Determinar botones seg√∫n el estado del plan
      let botonesAccion = '';
      
      if (estadoKey === 'borrador' || estadoKey === 'vigente') {
        // BORRADOR: PDF inicial + Editar + Secciones + Enviar a Revisi√≥n + Eliminar
        botonesAccion = `
          <button class="btn-ios btn-pdf" onclick="descargarPDF(${plan.id})" title="Generar PDF inicial">PDF</button>
          <button class="btn-ios btn-editar" onclick="editarPlan(${plan.id})" title="Editar plan">‚úé</button>
          <button class="btn-ios btn-secciones" onclick="mostrarMenuSecciones(${plan.id})" title="Editar por secciones">üìã</button>
          <button class="btn-ios btn-enviar" onclick="mostrarConfirmacion(${plan.id}, 'En_revision', '¬øEnviar a revisi√≥n?')" title="Enviar a revisi√≥n">Revisar</button>
          <button class="btn-ios btn-eliminar" onclick="eliminarPlan(${plan.id})" title="Eliminar">‚úï</button>
        `;
      } else if (estadoKey === 'en_revision') {
        // EN REVISI√ìN: PDF + Editar (para correcciones) + Secciones + Aprobar + Devolver
        botonesAccion = `
          <button class="btn-ios btn-pdf" onclick="descargarPDF(${plan.id})" title="Generar PDF">PDF</button>
          <button class="btn-ios btn-editar" onclick="editarPlan(${plan.id})" title="Editar para correcciones">‚úé</button>
          <button class="btn-ios btn-secciones" onclick="mostrarMenuSecciones(${plan.id})" title="Editar por secciones">üìã</button>
          <button class="btn-ios btn-aprobar" onclick="mostrarConfirmacion(${plan.id}, 'Aprobado', '¬øAprobar el plan?')" title="Aprobar">Aprobar</button>
          <button class="btn-ios btn-devolver" onclick="mostrarConfirmacion(${plan.id}, 'Borrador', '¬øDevolver a borrador?')" title="Devolver">‚Ü©</button>
        `;
      } else if (estadoKey === 'aprobado') {
        // APROBADO: PDF oficial + Ver + Secciones + Enviar a Comit√©
        botonesAccion = `
          <button class="btn-ios btn-pdf" onclick="descargarPDF(${plan.id})" title="Descargar PDF oficial">PDF</button>
          <button class="btn-ios btn-ver" onclick="verDetalle(${plan.id})" title="Ver detalles">üëÅ</button>
          <button class="btn-ios btn-secciones" onclick="mostrarMenuSecciones(${plan.id})" title="Ver secciones">üìã</button>
          <button class="btn-ios btn-comite" onclick="mostrarConfirmacion(${plan.id}, 'Aprobado_Comite', '¬øAprobado por Comit√©?')" title="Aprobar por Comit√©">Comit√©</button>
        `;
      } else if (estadoKey === 'aprobado_comite') {
        // APROBADO POR COMIT√â: PDF oficial + Ver (solo lectura)
        botonesAccion = `
          <button class="btn-ios btn-pdf" onclick="descargarPDF(${plan.id})" title="Descargar PDF oficial">PDF</button>
          <button class="btn-ios btn-ver" onclick="verDetalle(${plan.id})" title="Ver detalles">üëÅ</button>
        `;
      }
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><strong>${plan.numero_plan || 'N/A'}</strong></td>
        <td>${plan.nombre_plan || '-'}</td>
        <td>${(plan.tipo_evento || '').replace(/_/g, ' ')}</td>
        <td>${plan.responsable_principal || '-'}</td>
        <td><span class="badge-estado ${badgeClass}">${(plan.estado || 'Borrador').replace(/_/g, ' ').toUpperCase()}</span></td>
        <td>${plan.vigencia_desde || '-'}</td>
        <td>
          <div class="action-buttons-ios">
            ${botonesAccion}
          </div>
        </td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error cargando planes:', error);
    const tbody = document.getElementById('planesTbody');
    if (tbody) {
      tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #d32f2f;">Error al cargar planes: ' + error.message + '</td></tr>';
    }
  }
}

// ===== ACCIONES SOBRE PLANES =====
async function descargarPDF(id) {
  try {
    window.location.href = `/api/contingencia/${id}/pdf`;
  } catch (error) {
    console.error('Error descargando PDF:', error);
    mostrarAlerta('Error al descargar el PDF', 'error');
  }
}

async function eliminarPlan(id) {
  if (!confirm('¬øEst√°s seguro de que deseas eliminar este plan?')) return;
  
  try {
    const response = await fetch(`/api/contingencia/${id}`, { method: 'DELETE' });
    const resultado = await response.json();
    
    if (resultado.success) {
      mostrarAlerta('Plan eliminado exitosamente', 'success');
      cargarPlanesExistentes();
    } else {
      mostrarAlerta('Error al eliminar el plan', 'error');
    }
  } catch (error) {
    console.error('Error eliminando plan:', error);
    mostrarAlerta('Error de conexi√≥n', 'error');
  }
}

function editarPlan(id) {
  try {
    // Redirigir a la vista de edici√≥n del plan (wizard con 9 secciones oficiales)
    window.location.href = `/gestion-riesgo/planes-contingencia/editar/${id}/introduccion`;
  } catch (error) {
    console.error('Error al editar plan:', error);
    mostrarAlerta('Error al abrir el editor del plan', 'error');
  }
}

function verDetalle(id) {
  try {
    // Redirigir a la vista de detalle del plan
    window.location.href = `/gestion-riesgo/planes-contingencia/detalle/${id}`;
  } catch (error) {
    console.error('Error al ver detalle:', error);
    mostrarAlerta('Error al abrir los detalles', 'error');
  }
}

function mostrarMenuSecciones(planId) {
  // Definir las 9 secciones oficiales del plan de contingencia
  const secciones = [
    { key: 'introduccion', label: '1. Introducci√≥n' },
    { key: 'objetivos', label: '2. Objetivos y Alcance' },
    { key: 'normativo', label: '3. Marco Normativo' },
    { key: 'organizacion', label: '4. Organizaci√≥n' },
    { key: 'riesgos', label: '5. An√°lisis de Riesgos' },
    { key: 'medidas', label: '6. Medidas de Reducci√≥n' },
    { key: 'respuesta', label: '7. Plan de Respuesta' },
    { key: 'actualizacion', label: '8. Actualizaci√≥n' },
    { key: 'anexos', label: '9. Anexos' }
  ];
  
  // Crear modal con men√∫ de secciones
  const modal = document.createElement('div');
  modal.className = 'ios-modal';
  modal.id = 'seccionesModal_' + planId;
  modal.style.display = 'flex';
  
  let contenido = `
    <div class="ios-modal-content" style="width:90%; max-width:450px; border-radius:12px; overflow:hidden;">
      <div class="ios-modal-header" style="background:#1e293b; color:white; padding:16px; text-align:center;">
        <h3 style="margin:0; font-size:18px;">Secciones del Plan</h3>
        <p style="margin:4px 0 0 0; font-size:12px; opacity:0.8;">Selecciona una secci√≥n para editar</p>
      </div>
      <div class="ios-modal-body" style="padding:12px; display:grid; gap:8px; background:#f8fafc; max-height:70vh; overflow-y:auto;">
  `;
  
  secciones.forEach((sec, idx) => {
    const bgColor = idx % 2 === 0 ? '#1e293b' : '#0f172a';
    contenido += `
      <a href="/gestion-riesgo/planes-contingencia/editar/${planId}/${sec.key}" 
         style="display:block; padding:12px 14px; background:${bgColor}; color:#e2e8f0; border-radius:8px; text-decoration:none; border-left:4px solid #38bdf8; cursor:pointer; font-size:14px; font-weight:500; transition:all 0.2s;">
        ${sec.label}
      </a>
    `;
  });
  
  contenido += `
      </div>
      <div class="ios-modal-buttons" style="background:#f1f5f9; padding:12px; display:flex; gap:8px; border-top:1px solid #e2e8f0;">
        <button class="ios-modal-btn cancel" onclick="cerrarModalSecciones('${planId}')" style="flex:1; padding:8px; background:#6b7280; color:white; border:none; border-radius:6px; cursor:pointer; font-weight:600;">Cerrar</button>
      </div>
    </div>
  `;
  
  modal.innerHTML = contenido;
  modal.addEventListener('click', (e) => {
    if (e.target === modal) cerrarModalSecciones(planId);
  });
  
  document.body.appendChild(modal);
}

function cerrarModalSecciones(planId) {
  const modal = document.getElementById('seccionesModal_' + planId);
  if (modal) {
    modal.style.animation = 'fadeOut 0.3s ease-out';
    setTimeout(() => modal.remove(), 300);
  }
}

// Variables globales para el modal
let pendingAction = null;

function mostrarConfirmacion(id, estado, mensaje) {
  pendingAction = { id, estado };
  const modal = document.createElement('div');
  modal.className = 'ios-modal';
  modal.id = 'confirmModal';
  
  const esAprobacion = estado === 'Aprobado' || estado === 'Aprobado_Comite';
  const mensajeExtra = esAprobacion ? '<p style="font-size: 13px; color: #999; margin: 8px 0 0 0;">Se generar√° el PDF final aprobado</p>' : '';
  
  modal.innerHTML = `
    <div class="ios-modal-content">
      <div class="ios-modal-header">
        <h3>${mensaje}</h3>
      </div>
      <div class="ios-modal-body">
        Plan: ${estado.replace(/_/g, ' ')}
        ${mensajeExtra}
      </div>
      <div class="ios-modal-buttons">
        <button class="ios-modal-btn cancel" onclick="cerrarModal()">Cancelar</button>
        <button class="ios-modal-btn confirm" onclick="confirmarEstado()">Confirmar</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) cerrarModal();
  });
}

function cerrarModal() {
  const modal = document.getElementById('confirmModal');
  if (modal) modal.remove();
  pendingAction = null;
}

async function confirmarEstado() {
  if (!pendingAction) return;
  
  const { id, estado } = pendingAction;
  cerrarModal();
  
  try {
    const payload = { estado };
    const response = await fetch(`/api/contingencia/${id}/estado`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const res = await response.json();
    
    if (res.success) {
      mostrarBurbuja('‚úì ' + estado.replace(/_/g, ' '), 'success');
      
      // Si es aprobado, ofrecer generar PDF final
      if (estado === 'Aprobado' || estado === 'Aprobado_Comite') {
        setTimeout(() => {
          const generarModal = document.createElement('div');
          generarModal.className = 'ios-modal';
          generarModal.id = 'generatePdfModal';
          generarModal.innerHTML = `
            <div class="ios-modal-content">
              <div class="ios-modal-header">
                <h3>¬øGenerar PDF Final?</h3>
              </div>
              <div class="ios-modal-body">
                El plan ha sido aprobado. ¬øDesea descargar el documento final?
              </div>
              <div class="ios-modal-buttons">
                <button class="ios-modal-btn cancel" onclick="cerrarGenerateModal()">M√°s tarde</button>
                <button class="ios-modal-btn confirm" onclick="descargarYCerrar(${id})">Descargar</button>
              </div>
            </div>
          `;
          document.body.appendChild(generarModal);
          generarModal.addEventListener('click', (e) => {
            if (e.target === generarModal) cerrarGenerateModal();
          });
        }, 800);
      } else {
        cargarPlanesExistentes();
      }
    } else {
      mostrarBurbuja('Error: ' + (res.error || 'desconocido'), 'error');
    }
  } catch (error) {
    console.error('Error actualizando estado:', error);
    mostrarBurbuja('Error de conexi√≥n', 'error');
  }
}

function cerrarGenerateModal() {
  const modal = document.getElementById('generatePdfModal');
  if (modal) modal.remove();
  cargarPlanesExistentes();
}

function descargarYCerrar(id) {
  cerrarGenerateModal();
  descargarPDF(id);
  cargarPlanesExistentes();
}

function mostrarBurbuja(mensaje, tipo = 'info') {
  // Remover burbuja anterior si existe
  const burbujasAnteriores = document.querySelectorAll('.msg-bubble');
  burbujasAnteriores.forEach(b => b.remove());
  
  const burbuja = document.createElement('div');
  burbuja.className = `msg-bubble ${tipo}`;
  burbuja.textContent = mensaje;
  document.body.appendChild(burbuja);
  
  setTimeout(() => {
    burbuja.remove();
  }, 3000);
}

// ===== UTILIDADES =====
function mostrarAlerta(mensaje, tipo) {
  const alert = document.getElementById('alertMessage');
  alert.className = `alert show alert-${tipo}`;
  alert.textContent = mensaje;
  
  if (tipo === 'success') {
    setTimeout(() => {
      alert.classList.remove('show');
    }, 4000);
  }
}
</script>
<script src="{{ url_for('static', filename='js/contingencia_oficial.js') }}"></script>
{% endblock %}
