{% extends "base.html" %}
{% block content %}

<h1 class="mb-3">Participación Ciudadana</h1>

{# =========================
RADICAR (solo Gobierno/Admin)
========================= #}
{% if puede_radicar %}
  <div class="card mb-4">
  <div class="card-header">Radicar nuevo</div>
  <div class="card-body">
    <form action="{{ url_for('participacion') }}" method="post" enctype="multipart/form-data" class="row g-3" id="formRadicar">
      <div class="col-md-3">
        <label class="form-label">Tipo de radicado</label>
        <select name="tipo" class="form-select" required>
          <option value="">-- Selecciona tipo --</option>
          <option value="Petición">Petición</option>
          <option value="Queja">Queja</option>
          <option value="Reclamo">Reclamo</option>
          <option value="Sugerencia">Sugerencia</option>
          <option value="Derecho de petición">Derecho de petición</option>
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Oficina destinataria</label>
        <select name="oficina" class="form-select" required>
          <option value="">-- Elija oficina --</option>
          {# oficinas: dict {code: label} #}
          {% for code, label in oficinas.items() %}
          <option value="{{ code }}">{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-2">
        <label class="form-label">Plazo (días)</label>
        <input type="number" name="plazo_dias" class="form-control" value="5" min="1" max="30" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Archivo PDF</label>
        <input type="file" name="pdf" accept="application/pdf" class="form-control" required id="pdfInput">
        <small class="text-muted d-block mt-1">Máx. 10 MB</small>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-success" id="btnSubmitRadicar">
          <i class="bi bi-upload me-2"></i>Subir Radicado
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  // Validación de archivo PDF
  document.getElementById('pdfInput')?.addEventListener('change', function(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    
    const maxSize = 10 * 1024 * 1024; // 10 MB
    if (file.size > maxSize) {
      alert('El archivo es demasiado grande. Máximo 10 MB permitido.');
      e.target.value = '';
      return;
    }
    
    if (!file.type.includes('pdf')) {
      alert('Solo se aceptan archivos PDF.');
      e.target.value = '';
    }
  });

  // Validación del formulario antes de enviar
  document.getElementById('formRadicar')?.addEventListener('submit', function(e) {
    const tipo = this.querySelector('[name="tipo"]').value;
    const oficina = this.querySelector('[name="oficina"]').value;
    const pdf = this.querySelector('[name="pdf"]').value;
    
    if (!tipo || !oficina || !pdf) {
      e.preventDefault();
      alert('Por favor completa todos los campos requeridos.');
      return false;
    }
    
    // Mostrar estado de carga
    const btn = document.getElementById('btnSubmitRadicar');
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
    btn.disabled = true;
  });
</script>
{% else %}
<div class="alert alert-info mb-4">
  Solo la <strong>Secretaría de Gobierno</strong> puede radicar. Puedes consultar y responder los radicados asignados a
  tu oficina.
</div>
{% endif %}

{# =========================
LISTADO
========================= #}
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Listado de Radicados</span>
  </div>
  <div class="card-body p-0">
    <table class="table table-hover table-sm mb-0 align-middle">
      <thead class="table-light">
        <tr>
          <th>Radicado</th>
          <th>Tipo</th>
          <th>Destinatario</th>
          <th>Ingreso</th>
          <th>Vence</th>
          <th>Estado</th>
          <th>Semáforo</th>
          <th>Resp.</th>
          <th class="text-end">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for r in radicados %}

        {# --- Normalización de destinatario a CÓDIGO ---
        Si r.destinatario ya es código (está en 'oficinas'), úsalo.
        Si viniera como etiqueta, conviértelo con oficinas_rev. #}
        {% set dest_code = r.destinatario if r.destinatario in oficinas
        else (oficinas_rev.get(r.destinatario, r.destinatario) if oficinas_rev is defined else r.destinatario) %}

        {# --- Normalización del usuario actual a CÓDIGO ---
        Si session['user'] ya es código, úsalo; si es etiqueta, reverso. #}
        {% set raw_user = session.get('user') %}
        {% set user_code = raw_user if raw_user in oficinas
        else (oficinas_rev.get(raw_user, raw_user) if oficinas_rev is defined else raw_user) %}

        {% set soy_dest = (user_code == dest_code) %}
        {% set es_admin = (session.get('user_role') == 'admin' or session.get('role') == 'admin') %}
        {% set es_gobierno = (user_code in ['Sec.Gobierno','Gobierno','Secretaría de Gobierno']) %}

        {# Oficina que RESPONDIÓ (si existe), normalizada a CÓDIGO #}
        {% set resp_code = r.respuesta_oficina if r.respuesta_oficina else '' %}
        {% if resp_code and (resp_code not in oficinas) and (oficinas_rev is defined) %}
        {% set resp_code = oficinas_rev.get(resp_code, resp_code) %}
        {% endif %}
        {% set soy_responsable = (resp_code and (user_code == resp_code)) %}

        <tr>
          <td><strong>{{ r.consecutivo }}</strong></td>
          <td>{{ r.tipo }}</td>

          {# Mostrar etiqueta bonita a partir del código #}
          <td>{{ oficinas.get(dest_code, dest_code or '—') }}</td>

          <td>
            {% if r.fecha_ingreso %}
            {{ r.fecha_ingreso.strftime('%Y-%m-%d %H:%M') if r.fecha_ingreso.strftime else r.fecha_ingreso }}
            {% else %}—{% endif %}
          </td>

          <td>
            {% if r.fecha_vencimiento %}
            {{ r.fecha_vencimiento.strftime('%Y-%m-%d') if r.fecha_vencimiento.strftime else r.fecha_vencimiento }}
            {% else %}—{% endif %}
          </td>

          <td>
            <span class="badge
              {% if r.estado == 'Respondido' %}bg-success
              {% elif r.estado == 'Pendiente' %}bg-secondary
              {% else %}bg-info{% endif %}">
              {{ r.estado }}
            </span>
          </td>

          {# --- Semáforo dinámico ---
          Si el backend pasa r.dias_restantes (int):
          >3 = verde, 0..3 = amarillo, <0=rojo Si no, caemos a r.semaforo (success|warning/danger/secondary) #} {% set
            dr=r.dias_restantes if r.dias_restantes is defined else None %} <td>
            {% if dr is not none %}
            {% if dr > 3 %}
            <span class="badge bg-success">&nbsp;</span>
            {% elif dr >= 0 %}
            <span class="badge bg-warning">&nbsp;</span>
            {% else %}
            <span class="badge bg-danger">&nbsp;</span>
            {% endif %}
            {% else %}
            <span class="badge bg-{{ r.semaforo or 'secondary' }}">&nbsp;</span>
            {% endif %}
            </td>

            <td>
              {% if r.respuesta_pdf %}
              <span class="badge bg-success">Sí</span>
              {% else %}
              <span class="badge bg-secondary">No</span>
              {% endif %}
            </td>

            <td class="text-end">
              <div class="btn-group btn-group-sm" role="group">

                {# Descargar radicado (puede quedar visible a todos, ajusta si lo quieres restringir) #}
                <a class="btn btn-outline-secondary" href="{{ url_for('descargar_radicado_pdf', rad_id=r.id) }}"
                  title="Descargar radicado (PDF)">
                  Radicado
                </a>

                {# Descargar Respuesta: SOLO admin, Gobierno o la oficina que RESPONDIÓ #}
                {% if r.respuesta_pdf and (es_admin or es_gobierno or soy_responsable) %}
                <a class="btn btn-outline-secondary" href="{{ url_for('descargar_respuesta_pdf', rad_id=r.id) }}"
                  title="Descargar respuesta (PDF)">
                  Respuesta
                </a>
                {% endif %}

                {# Responder: oficina destinataria (por CÓDIGO), admin o Gobierno #}
                {% if soy_dest or es_admin or es_gobierno %}
                <a class="btn btn-success" href="{{ url_for('responder_radicado', rad_id=r.id) }}" title="Responder">
                  Responder
                </a>
                {% endif %}

                {# Eliminar: solo admin #}
                {% if es_admin %}
                <form action="{{ url_for('eliminar_radicado', rad_id=r.id) }}" method="post" class="d-inline"
                  onsubmit="return confirm('¿Eliminar este radicado?');">
                  <button class="btn btn-outline-danger" title="Eliminar">Eliminar</button>
                </form>
                {% endif %}

              </div>
            </td>
        </tr>

        {% else %}
        <tr>
          <td colspan="9" class="text-center text-muted py-4">No hay radicados aún.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}