{% extends "base.html" %}

{% block content %}
<div class="container my-5">
  <div class="glass-panel p-5">
    <h2 class="mb-4 text-center fw-bold" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Nueva Solicitud</h2>
    <form method="POST" class="row g-4">

      <!-- Municipio, NIT, Fecha -->
      <div class="col-md-4">
        <label for="municipio" class="form-label form-label-premium">Municipio</label>
        <input type="text"
         class="form-control form-control-glass"
         id="municipio"
         name="municipio"
         value="Municipio de Supatá"
         readonly>
      </div>
      <div class="col-md-4">
        <label for="nit" class="form-label form-label-premium">NIT</label>
        <input type="text"
         class="form-control form-control-glass"
         id="nit"
         name="nit"
         value="899999398-5"
         readonly>
      </div>
      <div class="col-md-4">
        <label for="fecha" class="form-label form-label-premium">Fecha</label>
        <input type="date" class="form-control form-control-glass" id="fecha" name="fecha"
               value="{{ today }}" required>
      </div>

      <!-- Secretaría solicitante -->
      <div class="col-md-6">
        <label for="secretaria" class="form-label form-label-premium">Secretaría Solicitante</label>
        <select class="form-select select2" id="secretaria" name="secretaria" required>
          <option value=""></option>
          {% for sec in secretarias %}
            <option value="{{ sec }}">{{ sec }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Objeto y Justificación -->
      <div class="col-md-6">
        <label for="objeto" class="form-label form-label-premium">Objeto del Proyecto</label>
        <textarea class="form-control form-control-glass" id="objeto" name="objeto"
                  rows="2" style="resize: vertical;"></textarea>
      </div>
      <div class="col-12">
        <label for="justificacion" class="form-label form-label-premium">Justificación</label>
        <textarea class="form-control form-control-glass" id="justificacion" name="justificacion"
                  rows="4" style="resize: vertical;"></textarea>
      </div>

      <!-- Valor en Pesos COP -->
      <div class="col-md-4">
        <label for="valor" class="form-label form-label-premium">Valor (COP)</label>
        <div class="input-group">
          <span class="input-group-text glass-panel border-end-0" style="background: rgba(255,255,255,0.4); backdrop-filter: blur(10px);">$</span>
          <input
            type="text"
            class="form-control form-control-glass border-start-0 ps-1"
            id="valor"
            name="valor"
            placeholder="0"
            required    
          >
        </div>
      </div> 

      <!-- Meta Producto + campos auto-rellenados -->
      <div class="col-md-4">
        <label for="meta" class="form-label form-label-premium">Meta Producto</label>
        <select class="form-select select2" id="meta" name="meta" required>
          <option value="" disabled selected>Selecciona una meta...</option>
          {% for item in plan_list %}
            <option
              value="{{ item['meta de producto'] }}"
              data-eje="{{ item['eje'] }}"
              data-sector="{{ item['sector'] }}"
              data-bpim="{{ item['codigo bpim'] }}"
            >
              {{ item['meta de producto'] }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label for="eje" class="form-label form-label-premium">Eje</label>
        <input type="text" class="form-control form-control-glass" id="eje" name="eje" readonly>
      </div>
      <div class="col-md-4">
        <label for="sector" class="form-label form-label-premium">Sector</label>
        <input type="text" class="form-control form-control-glass" id="sector" name="sector" readonly>
      </div>
      <div class="col-md-4">
        <label for="bpim" class="form-label form-label-premium">Código BPIM</label>
        <input type="text" class="form-control form-control-glass" id="bpim" name="bpim" readonly>
      </div>

      <!-- Botones de acción -->
      <div class="col-12 text-end mt-5">
        <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary me-3 px-4 py-2" style="border-radius: 12px;">
          Cancelar
        </a>
        <button type="submit" class="btn btn-premium px-5">
          <i class="bi bi-send-fill me-2"></i> Radicar Solicitud
        </button>
      </div>

    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  $(document).ready(function(){
    // Inicializamos Select2 en #meta y #secretaria con búsqueda inline
    $('#meta, #secretaria').select2({
      theme: 'bootstrap-5',
      placeholder: 'Selecciona una…',
      allowClear: true,
      width: '100%',
      minimumResultsForSearch: 0,               // siempre mostrar buscador
      dropdownAutoWidth: false
    });

    // Al seleccionar una meta en el dropdown (evento propio de Select2)
    $('#meta').on('select2:select', function(e){
      const ds = e.params.data.element.dataset;
      $('#eje').val(ds.eje || '');
      $('#sector').val(ds.sector || '');
      $('#bpim').val(ds.bpim || '');
    });

    // Si se limpia la selección, vaciar campos relacionados
    $('#meta').on('select2:clear', function(){
      $('#eje, #sector, #bpim').val('');
    });
  });
</script>

<script>
// Cada vez que el usuario sale del campo, formateamos con miles
document.getElementById('valor').addEventListener('blur', function(){
  let v = this.value.replace(/\D/g,'');           // quitamos todo no dígito
  if(!v) return this.value = '';                   // vacío si no hay número
  v = parseInt(v, 10).toString();                  // convertimos a entero
  // añadimos separadores de miles cada 3 dígitos:
  this.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
});

// Para que, si hay un valor precargado (p.ej. tras validación fallida), también se formatee:
window.addEventListener('DOMContentLoaded', ()=>{
  const inp = document.getElementById('valor');
  if(inp.value) {
    let v = inp.value.replace(/\D/g,'');
    inp.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
  }
});
</script>

{% endblock %}
